name: "E2E (Selenium Grid • Cross-Browser)"

# -----------------------------------------------------------------------------
# Reusable workflow: Selenium Grid E2E (BrikByteOS standard)
#
# Adds:
#   - BrikByte parallel-runner contract to normalize shard env:
#       PARALLEL, PARALLEL_MODE, SHARD_INDEX, SHARD_TOTAL
#   - Unique artifact naming to avoid 409 conflicts:
#       includes run_id + run_attempt + browser + shard
#   - Optional Edge job uses its own governed matrix (edge × shard)
# -----------------------------------------------------------------------------

on:
  workflow_call:
    inputs:
      # -----------------------------------------------------------------------
      # App under test
      # -----------------------------------------------------------------------
      target_url:
        description: >
          Base URL of the app under test
          (e.g., http://host.docker.internal:3000)
        type: string
        required: true

      health_url:
        description: >
          Optional health endpoint to wait for
          (e.g., http://localhost:3000/health)
        type: string
        required: false
        default: ""

      start_app:
        description: >
          If true, start the app under test via docker-compose
          (localhost CI)
        type: boolean
        required: false
        default: false

      app_compose_file:
        description: >
          Path to docker-compose file for the app under test
          (required if start_app=true)
        type: string
        required: false
        default: ""

      app_service_workdir:
        description: >
          Working directory where app_compose_file lives
          (e.g., node-ui-example)
        type: string
        required: false
        default: "."

      app_wait_seconds:
        description: >
          Max seconds to wait for app health endpoint
          (if health_url provided)
        type: number
        required: false
        default: 120

      # -----------------------------------------------------------------------
      # Selenium Grid
      # -----------------------------------------------------------------------
      compose_file:
        description: >
          Path to docker-compose Selenium Grid definition
          in the caller repo
        type: string
        required: false
        default: "docker-compose.selenium.yml"

      service_workdir:
        description: >
          Working directory in the caller repo where compose
          + tests live
        type: string
        required: false
        default: "."

      enable_edge:
        description: >
          If true, also run Edge job
          (separate job with separate timeout).
        type: boolean
        required: false
        default: false

      browsers:
        description: >
          Comma-separated browsers for main matrix (chrome,firefox).
          If empty => chrome,firefox. (Edge handled separately.)
        type: string
        required: false
        default: ""

      override_shards:
        description: >
          Requested shard count (default 1).
          Will be clamped by governance caps.
        type: string
        required: false
        default: "1"

      grid_wait_seconds:
        description: "Max seconds to wait for Selenium Grid + node registration"
        type: number
        required: false
        default: 120

      # -----------------------------------------------------------------------
      # Runner
      # -----------------------------------------------------------------------
      runner_language:
        description: "java | python"
        type: string
        required: true

      test_command:
        description: "Command to run E2E tests (e.g., mvn test or pytest -q)"
        type: string
        required: true

      # -----------------------------------------------------------------------
      # Artifact / audit controls
      # -----------------------------------------------------------------------
      artifact_name:
        description: "Base name for uploaded logs/artifacts"
        type: string
        required: false
        default: "selenium-grid-e2e"

      e2e_video:
        description: "If true, always export videos where supported."
        type: boolean
        required: false
        default: false

      e2e_trace:
        description: "If true, always export traces where supported."
        type: boolean
        required: false
        default: false

      e2e_artifacts_always:
        description: "If true, always export artifacts even on success."
        type: boolean
        required: false
        default: false

      selenium_screenshots_dir:
        description: >
          Override source screenshots dir
          (absolute or relative to repo root)
        type: string
        required: false
        default: ""

      selenium_videos_dir:
        description: >
          Override source videos dir
          (absolute or relative to repo root)
        type: string
        required: false
        default: ""

      selenium_logs_dir:
        description: >
          Override source logs dir
          (absolute or relative to repo root)
        type: string
        required: false
        default: ""

      # -----------------------------------------------------------------------
      # Safeguards / Job Timeouts
      # -----------------------------------------------------------------------
      job_timeout_minutes:
        description: "Job timeout in minutes for main matrix jobs"
        type: number
        required: false
        default: 30

      edge_job_timeout_minutes:
        description: "Job timeout in minutes for Edge job"
        type: number
        required: false
        default: 40

      enforce_teardown:
        description: >
          If true, always attempt docker compose down -v
          for grid and app in finalizer.
        type: boolean
        required: false
        default: true

      parallel_enabled:
        description: "Enable parallel-runner contract (true|false)."
        type: string
        required: false
        default: "true"

      parallel_mode:
        description: "serial|static|dynamic"
        type: string
        required: false
        default: "static"

    outputs:
      selenium_remote_url:
        description: "Remote WebDriver URL for test runners"
        value: ${{ jobs.e2e.outputs.selenium_remote_url }}

permissions:
  contents: read

jobs:
  # ----------------------------------------------------------------------------
  # PLAN: governed deterministic matrix (browser × shard)
  #   - Main matrix: chrome+firefox (edge excluded; handled in separate plan/job)
  # ----------------------------------------------------------------------------
  plan:
    name: "Plan governed Selenium matrix"
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.plan.outputs.matrix_json }}

    steps:
      - name: "Checkout (caller repo)"
        uses: actions/checkout@v4

      - name: "Compute browser list (deterministic)"
        id: browsers
        shell: bash
        run: |
          set -euo pipefail
          csv="chrome,firefox"

          if [[ -n "${{ inputs.browsers }}" ]]; then
            csv="${{ inputs.browsers }}"
          fi

          csv="$(echo "${csv}" | tr -d ' ')"
          csv="$(echo "${csv}" | sed 's/edge//g')"
          csv="$(echo "${csv}" | sed 's/,,/,/g')"
          csv="$(echo "${csv}" | sed 's/^,//')"
          csv="$(echo "${csv}" | sed 's/,$//')"

          if [[ -z "${csv}" ]]; then
            csv="chrome,firefox"
          fi

          echo "browsers_csv=${csv}" >> "${GITHUB_OUTPUT}"
          echo "[PLAN] browsers(main)=${csv}"

      - name: "Generate browser × shard matrix (governed)"
        id: plan
        uses: BrikByte-Studios/.github/.github/actions/matrix-plan@main
        with:
          test_type: e2e
          override_shards: ${{ inputs.override_shards }}
          browsers: ${{ steps.browsers.outputs.browsers_csv }}

      - name: "Debug matrix_json"
        run: |
          echo "matrix_json=${{ steps.plan.outputs.matrix_json }}"

  # ----------------------------------------------------------------------------
  # OPTIONAL PLAN: governed edge × shard matrix (only if enable_edge)
  # ----------------------------------------------------------------------------
  plan-edge:
    name: "Plan governed Edge matrix"
    if: ${{ inputs.enable_edge == true }}
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.plan.outputs.matrix_json }}

    steps:
      - name: "Checkout (caller repo)"
        uses: actions/checkout@v4

      - name: "Generate edge × shard matrix (governed)"
        id: plan
        uses: BrikByte-Studios/.github/.github/actions/matrix-plan@main
        with:
          test_type: e2e
          override_shards: ${{ inputs.override_shards }}
          browsers: "edge"

      - name: "Debug matrix_json"
        run: |
          echo "matrix_json=${{ steps.plan.outputs.matrix_json }}"

  # ----------------------------------------------------------------------------
  # MATRIX: chrome + firefox (browser × shard)
  # ----------------------------------------------------------------------------
  e2e:
    name: "Selenium E2E • ${{ matrix.browser }} • shard ${{ matrix.shard }}"
    needs: plan
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs.job_timeout_minutes }}

    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.plan.outputs.matrix) }}

    outputs:
      selenium_remote_url: ${{ steps.set-remote.outputs.selenium_remote_url }}

    env:
      # App + grid
      E2E_TARGET_URL: ${{ inputs.target_url }}
      SELENIUM_REMOTE_URL: "http://localhost:4444/wd/hub"
      BROWSER: ${{ matrix.browser }}

      # Artifact exporter contract
      E2E_RUNNER: "selenium"
      E2E_VIDEO: ${{ inputs.e2e_video && 'true' || 'false' }}
      E2E_TRACE: ${{ inputs.e2e_trace && 'true' || 'false' }}
      E2E_ARTIFACTS_ALWAYS: ${{ inputs.e2e_artifacts_always && 'true' || 'false' }}

      # shard metadata (deterministic)
      SHARD_INDEX: ${{ matrix.shard }}
      SHARD_TOTAL: ${{ strategy.job-total }}

      # Optional sharding contract for Makefile/test runners
      UNIT_SHARD: ${{ matrix.shard }}
      UNIT_SHARD_TOTAL: ${{ strategy.job-total }}

      PARALLEL_MODE: ${{ inputs.parallel_mode }}
      PARALLEL: ${{ inputs.parallel_enabled }}

      FORCE_COLOR: "0"

    steps:
      - name: "Checkout (caller repo)"
        uses: actions/checkout@v4

      - name: "Setup Java (if runner_language=java)"
        if: ${{ inputs.runner_language == 'java' }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: "Setup Python (if runner_language=python)"
        if: ${{ inputs.runner_language == 'python' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: "Docker info (diagnostics)"
        run: |
          set -euo pipefail
          docker version
          docker compose version

      # -----------------------------------------------------------------------
      # OPTIONAL: Start the app under test (localhost CI)
      # -----------------------------------------------------------------------
      - name: "Validate app inputs (if start_app=true)"
        if: ${{ inputs.start_app == true }}
        run: |
          set -euo pipefail
          if [[ -z "${{ inputs.app_compose_file }}" ]]; then
            echo "[APP] ERROR: app_compose_file is required when start_app=true"
            exit 1
          fi
          echo "[APP] start_app=true, compose=${{ inputs.app_compose_file }}"
          echo "[APP] workdir=${{ inputs.app_service_workdir }}"

      - name: "Start app under test (docker compose)"
        if: ${{ inputs.start_app == true }}
        working-directory: ${{ inputs.app_service_workdir }}
        run: |
          set -euo pipefail
          docker compose -f "${{ inputs.app_compose_file }}" up -d --build
          docker compose -f "${{ inputs.app_compose_file }}" ps

      - name: "Wait for app readiness (optional)"
        if: ${{ inputs.health_url != '' }}
        run: |
          set -euo pipefail
          echo "[APP] Waiting for: ${{ inputs.health_url }}"
          timeout=${{ inputs.app_wait_seconds }}
          elapsed=0
          until curl -fsS "${{ inputs.health_url }}" >/dev/null 2>&1; do
            sleep 2
            elapsed=$((elapsed+2))
            if (( elapsed >= timeout )); then
              echo "[APP] ERROR: not ready within ${timeout}s"
              exit 1
            fi
          done
          echo "[APP] Ready ✅"

      # -----------------------------------------------------------------------
      # Start Selenium Grid
      # -----------------------------------------------------------------------
      - name: "Start Selenium Grid (docker compose)"
        working-directory: ${{ inputs.service_workdir }}
        run: |
          set -euo pipefail
          docker compose -f "${{ inputs.compose_file }}" up -d
          docker compose -f "${{ inputs.compose_file }}" ps

      - name: "Debug: hub logs (early)"
        if: always()
        working-directory: ${{ inputs.service_workdir }}
        run: |
          set -euo pipefail
          docker compose -f "${{ inputs.compose_file }}" \
            logs --no-color selenium-hub | tail -n 200 || true

      - name: "Install jq (for reliable /status parsing)"
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq
          jq --version

      - name: "Wait for Selenium Grid readiness + node registration"
        uses: BrikByte-Studios/.github/.github/actions/selenium-grid-healthcheck@main
        with:
          remote_url: ${{ env.SELENIUM_REMOTE_URL }}
          timeout_seconds: ${{ inputs.grid_wait_seconds }}
          require_chrome: "true"
          require_firefox: "true"
          require_edge: "false"

      - name: "Expose Remote WebDriver URL (workflow output)"
        id: set-remote
        run: |
          set -euo pipefail
          echo "selenium_remote_url=${SELENIUM_REMOTE_URL}" >> "${GITHUB_OUTPUT}"

      # -----------------------------------------------------------------------
      # Standardize shard env contract (PARALLEL/SHARD_INDEX/SHARD_TOTAL)
      # -----------------------------------------------------------------------
      - name: "Parallel runner contract (normalize shards)"
        id: pr
        uses: BrikByte-Studios/.github/.github/actions/parallel-runner@main
        with:
          parallel_enabled: ${{ inputs.parallel_enabled }}
          parallel_mode: ${{ inputs.parallel_mode }}
          shard_index: ${{ matrix.shard }}
          shard_total: ${{ strategy.job-total }}
          selection_mode: "none"
          working_directory: ${{ inputs.service_workdir }}

      - name: "Run E2E tests"
        working-directory: ${{ inputs.service_workdir }}
        env:
          SHARD_INDEX: ${{ steps.pr.outputs.shard_index }}
          SHARD_TOTAL: ${{ steps.pr.outputs.shard_total }}
          PARALLEL: ${{ steps.pr.outputs.parallel_enabled }}
          PARALLEL_MODE: ${{ steps.pr.outputs.parallel_mode }}
        run: |
          set -euo pipefail
          echo "[E2E] BROWSER=${BROWSER}"
          echo "[E2E] E2E_TARGET_URL=${E2E_TARGET_URL}"

          echo "[E2E] PARALLEL=${PARALLEL:-false}"
          echo "[E2E] PARALLEL_MODE=${PARALLEL_MODE:-static}"
          echo "[E2E] SHARD_INDEX=${SHARD_INDEX:-0}"
          echo "[E2E] SHARD_TOTAL=${SHARD_TOTAL:-1}"

          export E2E_SHARD="${SHARD_INDEX:-0}"
          export E2E_SHARD_TOTAL="${SHARD_TOTAL:-1}"
          echo "[E2E] E2E_SHARD=${E2E_SHARD}/${E2E_SHARD_TOTAL}"

          eval "${{ inputs.test_command }}"

      - name: "Normalize E2E_STATUS (always)"
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          s="${{ job.status }}"
          if [[ "$s" == "failure" || "$s" == "cancelled" ]]; then
            echo "E2E_STATUS=failed" >> "$GITHUB_ENV"
          else
            echo "E2E_STATUS=success" >> "$GITHUB_ENV"
          fi

      - name: "Resolve Selenium artifact roots (always)"
        if: always()
        id: selenium-roots
        shell: bash
        run: |
          set -euo pipefail

          lang="${{ inputs.runner_language }}"
          wd="${{ inputs.service_workdir }}"

          shots="${{ inputs.selenium_screenshots_dir }}"
          vids="${{ inputs.selenium_videos_dir }}"
          logs="${{ inputs.selenium_logs_dir }}"

          if [[ -z "$shots" || -z "$vids" || -z "$logs" ]]; then
            if [[ "$lang" == "java" ]]; then
              shots="${shots:-${wd}/target/selenium-artifacts/screenshots}"
              vids="${vids:-${wd}/target/selenium-artifacts/videos}"
              logs="${logs:-${wd}/target/surefire-reports}"
            elif [[ "$lang" == "python" ]]; then
              shots="${shots:-${wd}/artifacts/selenium/screenshots}"
              vids="${vids:-${wd}/artifacts/selenium/videos}"
              logs="${logs:-${wd}/artifacts/selenium/logs}"
            else
              echo "[ROOTS] ERROR: unknown runner_language=$lang"
              exit 1
            fi
          fi

          echo "[ROOTS] shots=$shots"
          echo "[ROOTS] vids=$vids"
          echo "[ROOTS] logs=$logs"

          echo "shots=$shots" >> "$GITHUB_OUTPUT"
          echo "vids=$vids" >> "$GITHUB_OUTPUT"
          echo "logs=$logs" >> "$GITHUB_OUTPUT"

      - name: "Capture E2E diagnostics (always)"
        if: always()
        uses: BrikByte-Studios/.github/.github/actions/capture-e2e-diagnostics@main
        with:
          runner: "selenium"
          browser: ${{ matrix.browser }}
          status: ${{ job.status }}
        env:
          SELENIUM_DIAG_DIR: >
            ${{ inputs.service_workdir }}/target/selenium-artifacts/diagnostics
          PLAYWRIGHT_DIAG_DIR: "test-results/diagnostics"
          CYPRESS_DIAG_DIR: "cypress/diagnostics"
          E2E_DIAG_HEAVY_ON_FAILURE_ONLY: "true"
          E2E_DIAG_DISABLE_HAR_BY_DEFAULT: "true"
          E2E_DIAG_MAX_TOTAL_MB: "150"

      - name: "Export E2E artifacts (always)"
        if: always()
        uses: BrikByte-Studios/.github/.github/actions/export-e2e-artifacts@main
        with:
          runner: "selenium"
          browser: ${{ matrix.browser }}
          status: ${{ job.status }}
          video: ${{ inputs.e2e_video }}
          trace: ${{ inputs.e2e_trace }}
          artifacts_always: ${{ inputs.e2e_artifacts_always }}
        env:
          E2E_MAX_TOTAL_MB: "300"
          E2E_MAX_VIDEOS: "10"
          RUNNER_LANGUAGE: ${{ inputs.runner_language }}
          SERVICE_WORKDIR: ${{ inputs.service_workdir }}
          SELENIUM_SCREENSHOTS_DIR: ${{ steps.selenium-roots.outputs.shots }}
          SELENIUM_VIDEOS_DIR: ${{ steps.selenium-roots.outputs.vids }}
          SELENIUM_LOGS_DIR: ${{ steps.selenium-roots.outputs.logs }}

      - name: "Collect Selenium Grid logs (always)"
        if: always()
        working-directory: ${{ inputs.service_workdir }}
        run: |
          set -euo pipefail
          mkdir -p .audit/selenium-grid
          COMPOSE_FILE="${{ inputs.compose_file }}"

          docker compose -f "$COMPOSE_FILE" ps \
            > .audit/selenium-grid/compose-ps.txt || true

          docker compose -f "$COMPOSE_FILE" logs --no-color selenium-hub \
            > .audit/selenium-grid/selenium-hub.log || true

          docker compose -f "$COMPOSE_FILE" logs --no-color chrome \
            > .audit/selenium-grid/node-chrome.log || true

          docker compose -f "$COMPOSE_FILE" logs --no-color firefox \
            > .audit/selenium-grid/node-firefox.log || true

          curl -fsS http://localhost:4444/status \
            > .audit/selenium-grid/grid-status.json || true

      - name: "Collect app-under-test logs (always)"
        if: ${{ always() && inputs.start_app == true }}
        working-directory: ${{ inputs.app_service_workdir }}
        run: |
          set -euo pipefail
          mkdir -p ../.audit/app-under-test

          APP_COMPOSE_FILE="${{ inputs.app_compose_file }}"
          HEALTH_URL="${{ inputs.health_url }}"

          docker compose -f "$APP_COMPOSE_FILE" ps \
            > ../.audit/app-under-test/compose-ps.txt || true

          docker compose -f "$APP_COMPOSE_FILE" logs --no-color \
            > ../.audit/app-under-test/compose.log || true

          if [[ -n "$HEALTH_URL" ]]; then
            curl -fsS "$HEALTH_URL" \
              > ../.audit/app-under-test/health.json || true
          fi

      - name: "Teardown Selenium Grid (always)"
        if: always()
        working-directory: ${{ inputs.service_workdir }}
        run: |
          set -euo pipefail
          docker compose -f "${{ inputs.compose_file }}" down -v || true

      - name: "Teardown app under test (always)"
        if: ${{ always() && inputs.start_app == true }}
        working-directory: ${{ inputs.app_service_workdir }}
        run: |
          set -euo pipefail
          docker compose -f "${{ inputs.app_compose_file }}" down -v || true

      - name: "Upload E2E audit artifacts (always)"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: >-
            ${{ inputs.artifact_name }}-
            ${{ matrix.browser }}-shard${{ matrix.shard }}-
            run${{ github.run_id }}-attempt${{ github.run_attempt }}
          path: |
            .audit/**
          if-no-files-found: warn
          include-hidden-files: true
          retention-days: 14

      - name: "FINALIZER: enforce teardown (grid + app) (always)"
        if: ${{ always() && inputs.enforce_teardown == true }}
        run: |
          set +e
          SERVICE_WORKDIR="${{ inputs.service_workdir }}"
          COMPOSE_FILE="${{ inputs.compose_file }}"

          APP_WORKDIR="${{ inputs.app_service_workdir }}"
          APP_COMPOSE_FILE="${{ inputs.app_compose_file }}"
          START_APP="${{ inputs.start_app }}"

          (
            cd "$SERVICE_WORKDIR" &&
            docker compose -f "$COMPOSE_FILE" down -v
          ) || true

          if [[ "$START_APP" == "true" ]]; then
            (
              cd "$APP_WORKDIR" &&
              docker compose -f "$APP_COMPOSE_FILE" down -v
            ) || true

  # ----------------------------------------------------------------------------
  # OPTIONAL EDGE JOB: edge × shard (governed by plan-edge)
  # ----------------------------------------------------------------------------
  e2e-edge:
    name: "Selenium E2E • edge • shard ${{ matrix.shard }}"
    if: ${{ inputs.enable_edge == true }}
    needs: plan-edge
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs.edge_job_timeout_minutes }}

    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.plan-edge.outputs.matrix) }}

    env:
      E2E_TARGET_URL: ${{ inputs.target_url }}
      SELENIUM_REMOTE_URL: "http://localhost:4444/wd/hub"
      BROWSER: "edge"
      FORCE_COLOR: "0"

      E2E_RUNNER: "selenium"
      E2E_VIDEO: ${{ inputs.e2e_video && 'true' || 'false' }}
      E2E_TRACE: ${{ inputs.e2e_trace && 'true' || 'false' }}
      E2E_ARTIFACTS_ALWAYS: ${{ inputs.e2e_artifacts_always && 'true' || 'false' }}

      PARALLEL_MODE: ${{ inputs.parallel_mode }}
      PARALLEL: ${{ inputs.parallel_enabled }}

    steps:
      - name: "Checkout (caller repo)"
        uses: actions/checkout@v4

      - name: "Setup Java (if runner_language=java)"
        if: ${{ inputs.runner_language == 'java' }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: "Setup Python (if runner_language=python)"
        if: ${{ inputs.runner_language == 'python' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: "Docker info (diagnostics)"
        run: |
          set -euo pipefail
          docker version
          docker compose version

      - name: "Validate app inputs (if start_app=true)"
        if: ${{ inputs.start_app == true }}
        run: |
          set -euo pipefail
          if [[ -z "${{ inputs.app_compose_file }}" ]]; then
            echo "[APP] ERROR: app_compose_file is required when start_app=true"
            exit 1
          fi

      - name: "Start app under test (docker compose)"
        if: ${{ inputs.start_app == true }}
        working-directory: ${{ inputs.app_service_workdir }}
        run: |
          set -euo pipefail
          docker compose -f "${{ inputs.app_compose_file }}" up -d --build
          docker compose -f "${{ inputs.app_compose_file }}" ps || true

      - name: "Wait for app readiness (optional)"
        if: ${{ inputs.health_url != '' }}
        run: |
          set -euo pipefail
          timeout=${{ inputs.app_wait_seconds }}
          elapsed=0
          until curl -fsS "${{ inputs.health_url }}" >/dev/null 2>&1; do
            sleep 2
            elapsed=$((elapsed+2))
            if (( elapsed >= timeout )); then
              echo "[APP] ERROR: not ready within ${timeout}s"
              exit 1
            fi
          done
          echo "[APP] Ready ✅"

      - name: "Start Selenium Grid (with Edge profile if supported)"
        working-directory: ${{ inputs.service_workdir }}
        run: |
          set -euo pipefail
          docker compose -f "${{ inputs.compose_file }}" --profile edge up -d \
            || docker compose -f "${{ inputs.compose_file }}" up -d
          docker compose -f "${{ inputs.compose_file }}" ps

      - name: "Install jq"
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: "Wait for Selenium Grid readiness + node registration (Edge)"
        uses: BrikByte-Studios/.github/.github/actions/selenium-grid-healthcheck@main
        with:
          remote_url: ${{ env.SELENIUM_REMOTE_URL }}
          timeout_seconds: ${{ inputs.grid_wait_seconds }}
          require_chrome: "true"
          require_firefox: "true"
          require_edge: "true"

      - name: "Parallel runner contract (normalize shards)"
        id: pr
        uses: BrikByte-Studios/.github/.github/actions/parallel-runner@main
        with:
          parallel_enabled: ${{ inputs.parallel_enabled }}
          parallel_mode: ${{ inputs.parallel_mode }}
          shard_index: ${{ matrix.shard }}
          shard_total: ${{ strategy.job-total }}
          selection_mode: "none"
          working_directory: ${{ inputs.service_workdir }}

      - name: "Run E2E tests (Edge)"
        working-directory: ${{ inputs.service_workdir }}
        env:
          SHARD_INDEX: ${{ steps.pr.outputs.shard_index }}
          SHARD_TOTAL: ${{ steps.pr.outputs.shard_total }}
          PARALLEL: ${{ steps.pr.outputs.parallel_enabled }}
          PARALLEL_MODE: ${{ steps.pr.outputs.parallel_mode }}
        run: |
          set -euo pipefail
          echo "[E2E] BROWSER=${BROWSER}"
          echo "[E2E] E2E_TARGET_URL=${E2E_TARGET_URL}"
          echo "[E2E] PARALLEL=${PARALLEL:-false}"
          echo "[E2E] PARALLEL_MODE=${PARALLEL_MODE:-static}"
          echo "[E2E] SHARD_INDEX=${SHARD_INDEX:-0}"
          echo "[E2E] SHARD_TOTAL=${SHARD_TOTAL:-1}"

          export E2E_SHARD="${SHARD_INDEX:-0}"
          export E2E_SHARD_TOTAL="${SHARD_TOTAL:-1}"

          eval "${{ inputs.test_command }}"

      - name: "Normalize E2E_STATUS (always)"
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          s="${{ job.status }}"
          if [[ "$s" == "failure" || "$s" == "cancelled" ]]; then
            echo "E2E_STATUS=failed" >> "$GITHUB_ENV"
          else
            echo "E2E_STATUS=success" >> "$GITHUB_ENV"
          fi

      - name: "Resolve Selenium artifact roots (always)"
        if: always()
        id: selenium-roots
        shell: bash
        run: |
          set -euo pipefail

          lang="${{ inputs.runner_language }}"
          wd="${{ inputs.service_workdir }}"

          shots="${{ inputs.selenium_screenshots_dir }}"
          vids="${{ inputs.selenium_videos_dir }}"
          logs="${{ inputs.selenium_logs_dir }}"

          if [[ -z "$shots" || -z "$vids" || -z "$logs" ]]; then
            if [[ "$lang" == "java" ]]; then
              shots="${shots:-${wd}/target/selenium-artifacts/screenshots}"
              vids="${vids:-${wd}/target/selenium-artifacts/videos}"
              logs="${logs:-${wd}/target/surefire-reports}"
            elif [[ "$lang" == "python" ]]; then
              shots="${shots:-${wd}/artifacts/selenium/screenshots}"
              vids="${vids:-${wd}/artifacts/selenium/videos}"
              logs="${logs:-${wd}/artifacts/selenium/logs}"
            else
              echo "[ROOTS] ERROR: unknown runner_language=$lang"
              exit 1
            fi
          fi

          echo "shots=$shots" >> "$GITHUB_OUTPUT"
          echo "vids=$vids" >> "$GITHUB_OUTPUT"
          echo "logs=$logs" >> "$GITHUB_OUTPUT"

      - name: "Capture E2E diagnostics (always)"
        if: always()
        uses: BrikByte-Studios/.github/.github/actions/capture-e2e-diagnostics@main
        with:
          runner: "selenium"
          browser: "edge"
          status: ${{ job.status }}
        env:
          SELENIUM_DIAG_DIR: >
            ${{ inputs.service_workdir }}/target/selenium-artifacts/diagnostics
          PLAYWRIGHT_DIAG_DIR: "test-results/diagnostics"
          CYPRESS_DIAG_DIR: "cypress/diagnostics"
          E2E_DIAG_HEAVY_ON_FAILURE_ONLY: "true"
          E2E_DIAG_DISABLE_HAR_BY_DEFAULT: "true"
          E2E_DIAG_MAX_TOTAL_MB: "150"

      - name: "Export E2E artifacts (always)"
        if: always()
        uses: BrikByte-Studios/.github/.github/actions/export-e2e-artifacts@main
        with:
          runner: "selenium"
          browser: "edge"
          status: ${{ job.status }}
          video: ${{ inputs.e2e_video }}
          trace: ${{ inputs.e2e_trace }}
          artifacts_always: ${{ inputs.e2e_artifacts_always }}
        env:
          E2E_MAX_TOTAL_MB: "300"
          E2E_MAX_VIDEOS: "10"
          RUNNER_LANGUAGE: ${{ inputs.runner_language }}
          SERVICE_WORKDIR: ${{ inputs.service_workdir }}
          SELENIUM_SCREENSHOTS_DIR: ${{ steps.selenium-roots.outputs.shots }}
          SELENIUM_VIDEOS_DIR: ${{ steps.selenium-roots.outputs.vids }}
          SELENIUM_LOGS_DIR: ${{ steps.selenium-roots.outputs.logs }}

      - name: "Collect Selenium Grid logs (always)"
        if: always()
        working-directory: ${{ inputs.service_workdir }}
        run: |
          set -euo pipefail
          mkdir -p .audit/selenium-grid
          COMPOSE_FILE="${{ inputs.compose_file }}"

          docker compose -f "$COMPOSE_FILE" ps \
            > .audit/selenium-grid/compose-ps.txt || true

          docker compose -f "$COMPOSE_FILE" logs --no-color selenium-hub \
            > .audit/selenium-grid/selenium-hub.log || true

          docker compose -f "$COMPOSE_FILE" logs --no-color edge \
            > .audit/selenium-grid/node-edge.log || true

          curl -fsS http://localhost:4444/status \
            > .audit/selenium-grid/grid-status.json || true

      - name: "Teardown Selenium Grid (always)"
        if: always()
        working-directory: ${{ inputs.service_workdir }}
        run: |
          set -euo pipefail
          docker compose -f "${{ inputs.compose_file }}" down -v || true

      - name: "Teardown app under test (always)"
        if: ${{ always() && inputs.start_app == true }}
        working-directory: ${{ inputs.app_service_workdir }}
        run: |
          set -euo pipefail
          docker compose -f "${{ inputs.app_compose_file }}" down -v || true

      - name: "Upload E2E audit artifacts (always)"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: >-
            ${{ inputs.artifact_name }}-edge-shard${{ matrix.shard }}-
            run${{ github.run_id }}-attempt${{ github.run_attempt }}
          path: |
            .audit/**
          if-no-files-found: warn
          include-hidden-files: true
          retention-days: 14

      - name: "FINALIZER: enforce teardown (grid + app) (always)"
        if: ${{ always() && inputs.enforce_teardown == true }}
        run: |
          set +e
          (
            cd "${{ inputs.service_workdir }}" &&
            docker compose -f "${{ inputs.compose_file }}" down -v
          ) || true

          if [[ "${{ inputs.start_app }}" == "true" ]]; then
            (
              cd "${{ inputs.app_service_workdir }}" &&
              docker compose -f "${{ inputs.app_compose_file }}" down -v
            ) || true
          fi
