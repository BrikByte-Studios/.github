# =============================================================================
# BrikByteOS ‚Äî Reusable Java Unit Test Workflow (Maven/Gradle)
# -----------------------------------------------------------------------------
# WBS ID : PIPE-TEST-UNIT-CI-BUILD-002
# Repos  :
#   - Implemented in:
#       ‚Ä¢ BrikByte-Studios/.github (.github/workflows/test-java.yml)
#   - Consumed by:
#       ‚Ä¢ BrikByte-Studios/brik-pipe-examples/java-api-example
#       ‚Ä¢ Product repos (via workflow_call)
#
# Contract:
#   - Expects:
#       ‚Ä¢ Makefile with `make test` calling:
#           - Maven: mvn -B test
#           - Gradle: ./gradlew test
#       ‚Ä¢ src/test/java for tests.
# =============================================================================
name: "BrikByteOS ‚Äî Java Unit Tests"

on:
  workflow_call:
    inputs:
      java-version:
        description: "Java version (e.g. 17 or 21; must align with runtime matrix)"
        required: false
        type: string
        default: "17"
      distribution:
        description: "JDK distribution (e.g. temurin)"
        required: false
        type: string
        default: "temurin"
      working-directory:
        description: "Path to Java project (Makefile + pom.xml/build.gradle)"
        required: false
        type: string
        default: "."

permissions:
  contents: read

jobs:
  test:
    name: "Java: Unit Tests"
    runs-on: ubuntu-latest

    env:
      LANGUAGE: java
      JAVA_VERSION: ${{ inputs.java-version != '' && inputs.java-version || '17' }}
      JAVA_DISTRIBUTION: ${{ inputs.distribution || 'temurin' }}
      WORKING_DIRECTORY: ${{ inputs.working-directory != '' && inputs.working-directory || '.' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify Java test layout
        run: |
          echo "üìÅ Working directory: ${WORKING_DIRECTORY}"

          if [ ! -d "${WORKING_DIRECTORY}" ]; then
            echo "‚ùå WORKING_DIRECTORY '${WORKING_DIRECTORY}' does not exist."
            exit 1
          fi

          if [ ! -f "${WORKING_DIRECTORY}/Makefile" ]; then
            echo "‚ùå Makefile not found in ${WORKING_DIRECTORY}."
            echo "   Expected 'make test' using Maven or Gradle."
            exit 1
          fi

          if [ ! -f "${WORKING_DIRECTORY}/pom.xml" ] && \
             [ ! -f "${WORKING_DIRECTORY}/build.gradle" ] && \
             [ ! -f "${WORKING_DIRECTORY}/build.gradle.kts" ]; then
            echo "‚ùå No pom.xml or build.gradle(.kts) found in ${WORKING_DIRECTORY}."
            exit 1
          fi

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}

      - name: "Cache JVM dependencies (Maven / Gradle)"
        uses: BrikByte-Studios/.github/.github/actions/cache-java-deps@main
        with:
          java-version: ${{ env.JAVA_VERSION }}
          project-path: ${{ env.WORKING_DIRECTORY }}

      - name: Run Java unit tests (make test)
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          set -euo pipefail

          echo "üß™ [TEST] Language  : ${LANGUAGE}"
          echo "üß™ [TEST] Runtime   : Java (Temurin) ${JAVA_VERSION}"
          echo "üß™ [TEST] Directory : ${PWD}"
          echo "üß™ [TEST] Command   : make test"
          echo "üß™ [TEST] Status    : STARTING"

          START_TS=$(date +%s)

          make test

          END_TS=$(date +%s)
          DURATION=$((END_TS - START_TS))

          echo "‚úÖ [TEST] Status    : COMPLETED"
          echo "‚è±  [TEST] Duration : ${DURATION} seconds"
          echo "‚ÑπÔ∏è  [TEST] See Maven/Gradle test summary above."

      # -----------------------------------------------------------------------
      # X) Collect coverage (Java: Jacoco XML)
      #    - Expects target/site/jacoco/jacoco.xml.
      # -----------------------------------------------------------------------
      - name: Normalize coverage ‚Üí coverage.json
        uses: BrikByte-Studios/.github/.github/actions/coverage-merge@main
        with:
          language: ${{ env.LANGUAGE }}
          working-directory: ${{ env.WORKING_DIRECTORY }}
          out: out/coverage.json

      - name: Upload Node coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          # Unique per matrix entry: includes runtime version + job + attempt
          name: coverage-${{ env.LANGUAGE }}
          path: |
            ${{ env.WORKING_DIRECTORY }}/out/coverage.json
            ${{ env.WORKING_DIRECTORY }}/coverage/
          if-no-files-found: ignore
