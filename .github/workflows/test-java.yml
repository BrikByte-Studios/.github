# =============================================================================
# BrikByteOS ‚Äî Reusable Java Unit Test Workflow (Maven/Gradle)
# -----------------------------------------------------------------------------
# WBS ID : PIPE-TEST-UNIT-CI-BUILD-002
# Repos  :
#   - Implemented in:
#       ‚Ä¢ BrikByte-Studios/.github (.github/workflows/test-java.yml)
#   - Consumed by:
#       ‚Ä¢ BrikByte-Studios/brik-pipe-examples/java-api-example
#       ‚Ä¢ Product repos (via workflow_call)
#
# Contract:
#   - Expects:
#       ‚Ä¢ Makefile with `make test` calling:
#           - Maven: mvn -B test
#           - Gradle: ./gradlew test
#       ‚Ä¢ src/test/java for tests.
#
# Matrix plan integration:
#   - Uses BrikPipe Matrix Plan composite action to compute shards deterministically
#   - Parallel rules live in:
#       BrikByte-Studios/.github/.github/actions/matrix-plan/parallel-matrix.yml
# =============================================================================
name: "BrikByteOS ‚Äî Java Unit Tests"

on:
  workflow_call:
    inputs:
      java-version:
        description: "Java version (e.g. 17 or 21; must align with runtime matrix)"
        required: false
        type: string
        default: "17"
      distribution:
        description: "JDK distribution (e.g. temurin)"
        required: false
        type: string
        default: "temurin"
      working-directory:
        description: "Path to Java project (Makefile + pom.xml/build.gradle)"
        required: false
        type: string
        default: "."

      # ------------------------------
      # Governed parallelism (optional)
      # ------------------------------
      override_shards:
        description: "Optional requested shard count (clamped to caps)."
        required: false
        type: string
        default: ""
      matrix_config_path:
        description: >
          Optional path to parallel-matrix.yml.
          Leave empty to use default inside BrikByte-Studios/.github.
        required: false
        type: string
        default: ""
      parallel_mode:
        description: "Parallel mode: static|dynamic (default static)"
        required: false
        type: string
        default: "static"

      parallel_enabled:
        description: "Enable parallel shard execution (true|false)"
        required: false
        type: string
        default: "true"


permissions:
  contents: read

jobs:
  # ------------------------------------------------------------
  # 1) PLAN: compute governed matrix JSON (job output)
  # ------------------------------------------------------------
  plan:
    name: "Matrix Plan (java unit)"
    runs-on: ubuntu-latest

    outputs:
      matrix_json: ${{ steps.matrix.outputs.matrix_json }}

    steps:
      - name: "Compute matrix plan (unit)"
        id: matrix
        uses: BrikByte-Studios/.github/.github/actions/matrix-plan@main
        with:
          test_type: "unit"
          config_path: ${{ inputs.matrix_config_path }}
          override_shards: ${{ inputs.override_shards }}

      - name: "Debug matrix_json"
        run: |
          echo "matrix_json=${{ steps.matrix.outputs.matrix_json }}"

  # ------------------------------------------------------------
  # 2) TEST: run shards from matrix computed in plan job
  # ------------------------------------------------------------
  test:
    name: "Java: Unit Tests ‚Ä¢ shard ${{ matrix.shard }}"
    needs: plan
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.plan.outputs.matrix_json) }}

    env:
      LANGUAGE: java
      JAVA_VERSION: ${{ inputs.java-version != '' && inputs.java-version || '17' }}
      JAVA_DISTRIBUTION: ${{ inputs.distribution || 'temurin' }}
      WORKING_DIRECTORY: ${{ inputs.working-directory != '' && inputs.working-directory || '.' }}

      # shard metadata (defined by matrix-plan)
      SHARD_INDEX: ${{ matrix.shard }}
      SHARD_TOTAL: ${{ strategy.job-total }}

      PARALLEL_MODE: ${{ inputs.parallel_mode }}
      PARALLEL: ${{ inputs.parallel_enabled }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify Java test layout
        run: |
          echo "üìÅ Working directory: ${WORKING_DIRECTORY}"

          if [ ! -d "${WORKING_DIRECTORY}" ]; then
            echo "‚ùå WORKING_DIRECTORY '${WORKING_DIRECTORY}' does not exist."
            exit 1
          fi

          if [ ! -f "${WORKING_DIRECTORY}/Makefile" ]; then
            echo "‚ùå Makefile not found in ${WORKING_DIRECTORY}."
            echo "   Expected 'make test' using Maven or Gradle."
            exit 1
          fi

          if [ ! -f "${WORKING_DIRECTORY}/pom.xml" ] && \
             [ ! -f "${WORKING_DIRECTORY}/build.gradle" ] && \
             [ ! -f "${WORKING_DIRECTORY}/build.gradle.kts" ]; then
            echo "‚ùå No pom.xml or build.gradle(.kts) found in ${WORKING_DIRECTORY}."
            exit 1
          fi

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}

      - name: "Cache JVM dependencies (Maven / Gradle)"
        uses: BrikByte-Studios/.github/.github/actions/cache-java-deps@main
        with:
          java-version: ${{ env.JAVA_VERSION }}
          project-path: ${{ env.WORKING_DIRECTORY }}

      - name: Compute shard env (1-based for Makefile)
        shell: bash
        run: |
          set -euo pipefail

          SHARD0="${SHARD_INDEX}"
          TOTAL="${SHARD_TOTAL}"

          # Convert to 1-based (for your Node Makefile/shard-tests.cjs)
          SHARD1=$((SHARD0 + 1))

          {
            echo "UNIT_SHARD=${SHARD1}"
            echo "UNIT_SHARD_TOTAL=${TOTAL}"
          } >> "$GITHUB_ENV"

          echo "[SHARD] 0-based=${SHARD0} -> 1-based=${SHARD1} / total=${TOTAL}"

      - name: Parallel runner (serial/static/dynamic)
        id: pr
        uses: BrikByte-Studios/.github/.github/actions/parallel-runner@main
        with:
          parallel_enabled: ${{ env.PARALLEL }}
          parallel_mode: ${{ env.PARALLEL_MODE }}
          shard_index: ${{ matrix.shard }}          # 0-based
          shard_total: ${{ strategy.job-total }}
          selection_mode: "file-split"
          working_directory: ${{ env.WORKING_DIRECTORY }}
          test_glob: "**/*{Test,Tests}.java"
          out_list: "${{ env.WORKING_DIRECTORY }}/out/shard-files.txt"
          # items_file: "${{ env.WORKING_DIRECTORY }}/out/test-items.txt"
          # optional knobs:
          # allow_empty_items: true
          # selection_mode: file-split|shard-map|framework-native

      # -----------------------------------------------------------------------
      # Run unit tests via `make test`
      #
      # NOTE:
      #   Your Makefile must honor SHARD_INDEX + SHARD_TOTAL (or ignore them).
      #   Recommended pattern: Makefile routes to a shard runner script:
      #     make test => scripts/shard-tests.sh "$SHARD_INDEX" "$SHARD_TOTAL"
      # -----------------------------------------------------------------------
      - name: Run Java unit tests (make test)
        if: ${{ steps.pr.outputs.is_empty_shard != 'true' }}
        working-directory: ${{ env.WORKING_DIRECTORY }}
        env:
          UNIT_SHARD: ${{ env.SHARD_INDEX }}
          UNIT_SHARD_TOTAL: ${{ env.SHARD_TOTAL }}
          TEST_ITEMS_FILE: ${{ steps.pr.outputs.selection_path }}
        run: |
          set -euo pipefail

          echo "üß™ [TEST] Language     : ${LANGUAGE}"
          echo "üß™ [TEST] Runtime      : Java (${JAVA_DISTRIBUTION}) ${JAVA_VERSION}"
          echo "üß™ [TEST] Directory    : ${PWD}"
          echo "üß™ [TEST] Shard        : ${SHARD_INDEX}/${SHARD_TOTAL}"
          echo "üß™ [TEST] Command      : make test"
          echo "üß™ [TEST] Status       : STARTING"

          START_TS=$(date +%s)

          make test

          END_TS=$(date +%s)
          DURATION=$((END_TS - START_TS))

          echo "‚úÖ [TEST] Status       : COMPLETED"
          echo "‚è±  [TEST] Duration    : ${DURATION} seconds"
          echo "‚ÑπÔ∏è  [TEST] See Maven/Gradle test summary above."

      - name: Empty shard (nothing to run)
        if: ${{ steps.pr.outputs.is_empty_shard == 'true' }}
        run: |
          echo "‚ÑπÔ∏è Empty shard ${{ env.SHARD_INDEX }}/${{ env.SHARD_TOTAL }} ‚Äî skipping tests."


      # -----------------------------------------------------------------------
      # Detect JaCoCo presence (empty shard => no jacoco.xml)
      # -----------------------------------------------------------------------
      - name: Detect JaCoCo XML presence
        id: jacoco
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          set -euo pipefail
          if [ -f "target/site/jacoco/jacoco.xml" ] || [ -f "jacoco.xml" ]; then
            echo "has_jacoco=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_jacoco=false" >> "$GITHUB_OUTPUT"
          fi
          echo "has_jacoco=$(cat $GITHUB_OUTPUT | tail -n 1)"

      # -----------------------------------------------------------------------
      # X) Collect coverage (Java: JaCoCo XML)
      #    - Expects target/site/jacoco/jacoco.xml.
      # -----------------------------------------------------------------------
      - name: Normalize coverage ‚Üí coverage.json
        if: steps.jacoco.outputs.has_jacoco == 'true'
        uses: BrikByte-Studios/.github/.github/actions/coverage-merge@main
        with:
          language: ${{ env.LANGUAGE }}
          working-directory: ${{ env.WORKING_DIRECTORY }}
          out: out/coverage.json

      - name: Ensure summary.line is set in coverage.json (Java / JaCoCo)
        if: steps.jacoco.outputs.has_jacoco == 'true'
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          set -euo pipefail
          echo "üîß Normalizing coverage: syncing summary.line from JaCoCo XML"

          if [ -f "target/site/jacoco/jacoco.xml" ]; then
            export JACOCO_XML="target/site/jacoco/jacoco.xml"
          elif [ -f "jacoco.xml" ]; then
            export JACOCO_XML="jacoco.xml"
          else
            echo "‚ùå JaCoCo XML not found (expected target/site/jacoco/jacoco.xml or jacoco.xml)."
            ls -R
            exit 1
          fi

          python - << 'EOF'
          import json
          import xml.etree.ElementTree as ET
          from pathlib import Path
          import os

          jacoco_path = os.environ.get("JACOCO_XML", "target/site/jacoco/jacoco.xml")
          xml_path = Path(jacoco_path)

          if not xml_path.is_file():
            raise SystemExit(f"JaCoCo XML not found at {xml_path}")

          tree = ET.parse(xml_path)
          root = tree.getroot()

          missed = 0
          covered = 0
          for counter in root.iter("counter"):
            if counter.get("type") == "LINE":
              missed = int(counter.get("missed", "0"))
              covered = int(counter.get("covered", "0"))
              break

          total = missed + covered
          if total == 0:
            raise SystemExit("No LINE coverage data found in JaCoCo XML.")

          line_pct = (covered / total) * 100.0

          out_dir = Path("out")
          out_dir.mkdir(parents=True, exist_ok=True)
          cov_path = out_dir / "coverage.json"

          try:
            cov = json.loads(cov_path.read_text(encoding="utf-8"))
          except FileNotFoundError:
            cov = {}

          cov.setdefault("summary", {})
          cov["summary"]["line"] = line_pct
          cov.setdefault("files", [])

          cov_path.write_text(json.dumps(cov, indent=2), encoding="utf-8")
          print(f"‚úÖ Updated out/coverage.json with summary.line = {line_pct:.1f}")
          EOF

          echo "‚úÖ coverage.json after normalization:"
          cat out/coverage.json

      - name: Upload Java coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-java-shard${{ env.SHARD_INDEX }}
          path: |
            ${{ env.WORKING_DIRECTORY }}/out/coverage.json
            ${{ env.WORKING_DIRECTORY }}/target/site/jacoco/jacoco.xml
            ${{ env.WORKING_DIRECTORY }}/out/junit.xml
            ${{ env.WORKING_DIRECTORY }}/out/shard-files.txt
            ${{ env.WORKING_DIRECTORY }}/out/shard-packages.txt
          if-no-files-found: ignore
          include-hidden-files: true
          retention-days: 14
