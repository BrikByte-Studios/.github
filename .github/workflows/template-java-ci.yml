# -----------------------------------------------------------------------------
# [TEMPLATE] Baseline Java CI Workflow
#
# Repos:
#   - Implemented in: BrikByte-Studios/.github
#   - Consumed by: brik-pipe-examples/java-*, product repos via workflow_call
#
# WBS / Task:
#   - [TASK] PIPE-BUILD-TEMPLATES-BUILD-002
#   - PIPE-CORE-1.1.2 — CI/CD Templates Repo
#   - PIPE-BUILD-RUNTIMES-INIT-001 — Runtime Matrix
#
# Purpose:
#   Standardized Maven/Gradle-based CI pipeline for Java runtimes (17–21),
#   reusable across BrikByteOS projects via workflow_call.
#
# Usage (in consumer repo):
#
#   jobs:
#     ci:
#       uses: BrikByte-Studios/.github/.github/workflows/template-java-ci.yml@main
#       with:
#         java-version: "17"
#         distribution: "temurin"
#         project-path: "java-api-example"   # or "." if workflow lives at repo root
# -----------------------------------------------------------------------------
name: "Template: Java CI"

on:
  # NOTE:
  #   This is a *reusable* workflow.
  #   It is NOT intended to run directly on push/pull_request in the .github repo.
  #   Product/example repos should define their own triggers and call this via:
  #
  #   jobs:
  #     ci:
  #       uses: BrikByte-Studios/.github/.github/workflows/template-java-ci.yml@main
  #
  workflow_call:
    inputs:
      java-version:
        description: "Java version (17 or 21, per runtime matrix)"
        required: false
        default: "17"
        type: string
      distribution:
        description: "JDK distribution (e.g. temurin)"
        required: false
        default: "temurin"
        type: string
      enable-cache:
        description: "Enable Maven cache (requires pom.xml in caller repo)"
        required: false
        default: "true"
        type: string
      project-path:
        description: "Relative path to the Java project ('.' or 'subdir')"
        required: false
        default: "."
        type: string

permissions:
  contents: read

jobs:
  build-and-test:
    name: "Java: Build & Test"
    runs-on: ubuntu-latest

    env:
      # Ensure we always have values:
      JAVA_VERSION: ${{ inputs.java-version || '17' }}
      JAVA_DISTRIBUTION: ${{ inputs.distribution || 'temurin' }}
      ENABLE_CACHE: ${{ inputs.enable-cache || 'true' }}
      PROJECT_PATH: ${{ inputs.project-path || '.' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # Setup Java
      #   - Uses runtime matrix defaults (Java 17, Temurin)
      #   - Cache is *optional* and can be disabled by callers if it causes issues.
      # -----------------------------------------------------------------------
      - name: Setup Java
        # If/when BrikByte-Studios/brik-pipe-actions/setup-java@v1 exists,
        # replace this with the composite action to centralise Java setup.
        # uses: BrikByte-Studios/brik-pipe-actions/setup-java@v1
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          # Only enable cache when ENABLE_CACHE == 'true'
          cache: ${{ env.ENABLE_CACHE == 'true' && 'maven' || '' }}

      # -----------------------------------------------------------------------
      # Detect build tool
      #   - Maven (pom.xml)
      #   - Gradle (build.gradle / build.gradle.kts)
      #   - Runs in PROJECT_PATH so monorepos are supported.
      # -----------------------------------------------------------------------
      - name: Detect build tool
        id: detect
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          if [ -f "pom.xml" ]; then
            echo "tool=maven" >> "$GITHUB_OUTPUT"
          elif [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then
            echo "tool=gradle" >> "$GITHUB_OUTPUT"
          else
            echo "❌ No pom.xml or build.gradle found in $PWD."
            echo "   This reusable workflow expects a Java project in PROJECT_PATH."
            exit 1
          fi

      # -----------------------------------------------------------------------
      # Build
      # -----------------------------------------------------------------------
      - name: Build (Maven)
        if: steps.detect.outputs.tool == 'maven'
        working-directory: ${{ env.PROJECT_PATH }}
        run: mvn -B clean package

      - name: Build (Gradle)
        if: steps.detect.outputs.tool == 'gradle'
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          chmod +x ./gradlew || true
          ./gradlew clean build

      # -----------------------------------------------------------------------
      # Test (explicit, even though most builds already run tests)
      # -----------------------------------------------------------------------
      - name: Test (Maven)
        if: steps.detect.outputs.tool == 'maven'
        working-directory: ${{ env.PROJECT_PATH }}
        run: mvn -B test

      - name: Test (Gradle)
        if: steps.detect.outputs.tool == 'gradle'
        working-directory: ${{ env.PROJECT_PATH }}
        run: ./gradlew test

      # -----------------------------------------------------------------------
      # Upload JAR artifacts (if present)
      # -----------------------------------------------------------------------
      - name: Upload JARs
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: java-artifacts
          # Note: paths are relative to PROJECT_PATH
          path: |
            ${{ env.PROJECT_PATH }}/target/**/*.jar
            ${{ env.PROJECT_PATH }}/build/libs/**/*.jar
          if-no-files-found: ignore
