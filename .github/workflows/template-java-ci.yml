# -----------------------------------------------------------------------------
# [TEMPLATE] Baseline Java CI Workflow
#
# Repos:
#   - Implemented in: BrikByte-Studios/.github
#   - Consumed by: brik-pipe-examples/java-* and product repos via workflow_call
#
# WBS / Tasks:
#   - [TASK] PIPE-BUILD-TEMPLATES-BUILD-002
#   - [TASK] PIPE-BUILD-CONVENTIONS-CONFIG-003
#   - PIPE-CORE-1.1.2 ‚Äî CI/CD Templates Repo
#   - PIPE-BUILD-RUNTIMES-INIT-001 ‚Äî Runtime Matrix
#
# Purpose:
#   Standardized, reusable Java CI workflow (Maven/Gradle) for BrikByteOS
#   Pipelines, delegating build/test to canonical `make ci` in the target
#   project so local dev and CI use the same entrypoint.
#
# Usage (in consumer repo):
#
#   name: "CI ‚Äî Java API Example"
#   on:
#     push:
#       branches: [ main, master ]
#     pull_request:
#       branches: [ main, master ]
#
#   jobs:
#     ci:
#       uses: BrikByte-Studios/.github/.github/workflows/template-java-ci.yml@main
#       with:
#         java-version: "17"
#         distribution: "temurin"
#         project-path: "java-api-example"   # or "." if project at repo root
#
# Notes:
#   - Expects a Java project in `project-path` with:
#       - pom.xml OR build.gradle/build.gradle.kts
#       - Makefile exposing `make build`, `make test`, `make ci`
#     as per PIPE-BUILD-CONVENTIONS-CONFIG-003.
#   - Runtime versions and build/test commands MUST align with the Runtime Matrix.
# -----------------------------------------------------------------------------
name: "Template: Java CI"

on:
  # Reusable workflow only ‚Äî not intended to run directly in BrikByte-Studios/.github.
  workflow_call:
    inputs:
      java-version:
        description: "Java version (17 or 21, per runtime matrix)"
        required: false
        default: "17"
        type: string
      distribution:
        description: "JDK distribution (e.g. temurin)"
        required: false
        default: "temurin"
        type: string
      enable-cache:
        description: "Enable Maven cache (requires pom.xml in caller repo)"
        required: false
        default: "true"
        type: string
      project-path:
        description: "Relative path to the Java project ('.' or 'subdir')"
        required: false
        default: "."
        type: string

permissions:
  contents: read

jobs:
  build-and-test:
    name: "Java: Build & Test"
    runs-on: ubuntu-latest

    env:
      JAVA_VERSION: ${{ inputs.java-version || '17' }}
      JAVA_DISTRIBUTION: ${{ inputs.distribution || 'temurin' }}
      ENABLE_CACHE: ${{ inputs.enable-cache || 'true' }}
      PROJECT_PATH: ${{ inputs.project-path || '.' }}

    steps:
      # -----------------------------------------------------------------------
      # 1) Checkout repository
      # -----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # 2) Verify Java project layout in PROJECT_PATH
      #    - Checks:
      #       ‚Ä¢ Makefile present (for make build/test/ci)
      #       ‚Ä¢ pom.xml OR build.gradle/build.gradle.kts present
      # -----------------------------------------------------------------------
      - name: Verify Java project layout
        run: |
          echo "üìÅ Project path: ${PROJECT_PATH}"

          if [ ! -d "${PROJECT_PATH}" ]; then
            echo "‚ùå PROJECT_PATH '${PROJECT_PATH}' does not exist."
            exit 1
          fi

          if [ ! -f "${PROJECT_PATH}/Makefile" ]; then
            echo "‚ùå Makefile not found in ${PROJECT_PATH}."
            echo "   This template expects a Makefile exposing 'make ci' as per"
            echo "   PIPE-BUILD-CONVENTIONS-CONFIG-003."
            exit 1
          fi

          if [ -f "${PROJECT_PATH}/pom.xml" ]; then
            echo "‚úÖ Detected Maven project (pom.xml) in ${PROJECT_PATH}."
          elif [ -f "${PROJECT_PATH}/build.gradle" ] || [ -f "${PROJECT_PATH}/build.gradle.kts" ]; then
            echo "‚úÖ Detected Gradle project in ${PROJECT_PATH}."
          else
            echo "‚ùå No pom.xml or build.gradle(.kts) found in ${PROJECT_PATH}."
            echo "   This reusable workflow expects a Java project at PROJECT_PATH."
            exit 1
          fi

      # -----------------------------------------------------------------------
      # 3) Setup Java
      #    - Uses runtime matrix defaults (Java 17, Temurin).
      #    - Cache is *optional* and primarily tuned for Maven.
      # -----------------------------------------------------------------------
      - name: Setup Java
        # When available, replace with:
        # uses: BrikByte-Studios/brik-pipe-actions/setup-java@v1
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          # Only enable Maven cache when ENABLE_CACHE == 'true'.
          cache: ${{ env.ENABLE_CACHE == 'true' && 'maven' || '' }}

      # -----------------------------------------------------------------------
      # 4) Run canonical CI pipeline via Make
      #    - Delegates build + test to repo-level conventions:
      #        make ci ‚Üí (clean + build + test), as defined in Makefile.
      #    - This keeps workflow thin and enforces same commands in CI and local dev.
      # -----------------------------------------------------------------------
      - name: Run Java CI via Make
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          echo "üö¶ Running Java CI via 'make ci' in ${PWD}..."
          make ci

      # -----------------------------------------------------------------------
      # 5) Upload JAR artifacts (if present)
      #    - Supports Maven (target/**/*.jar) and Gradle (build/libs/**/*.jar)
      #      relative to PROJECT_PATH.
      # -----------------------------------------------------------------------
      - name: Upload JARs
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: java-artifacts
          path: |
            ${{ env.PROJECT_PATH }}/target/**/*.jar
            ${{ env.PROJECT_PATH }}/build/libs/**/*.jar
          if-no-files-found: ignore
