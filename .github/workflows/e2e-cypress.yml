# ==============================================================================
# Reusable Playwright E2E Workflow — BrikByteOS
# ==============================================================================
#
# Reusable via workflow_call
# Stable ENV CONTRACT
# Always set E2E_STATUS
# Always export via export-e2e-artifacts action (single source of truth)
# Always upload .audit/**/e2e/artifacts/**
# No duplicated legacy audit logic
#
# ENV CONTRACT (stable across repos and runners)
# ---------------------------------------------
# Required:
#   - E2E_TARGET_URL           Base URL of app under test
#   - E2E_RUNNER               playwright
#
# Exporter contract:
#   - E2E_STATUS               success|failed
#   - E2E_VIDEO                true|false
#   - E2E_TRACE                true|false
#   - E2E_ARTIFACTS_ALWAYS     true|false
#   - E2E_AUDIT_DATE           YYYY-MM-DD (optional override)
#   - E2E_AUDIT_ROOT           .audit/<date>/e2e/artifacts (optional override)
#
# Notes:
# - This workflow intentionally does NOT implement legacy copy logic into .audit.
# - The single source of truth for normalization is the reusable action:
#     BrikByte-Studios/.github/.github/actions/export-e2e-artifacts@main
# ==============================================================================

name: "E2E - Playwright (Reusable)"

on:
  workflow_call:
    inputs:
      target_url:
        description: "Base URL Playwright will test against."
        type: string
        required: false
        default: "https://staging.example.com"

      health_path:
        description: "Relative health path for readiness checks."
        type: string
        required: false
        default: "/health"

      service_workdir:
        description: "Working directory for the service under test."
        type: string
        required: false
        default: "."

      docker_port:
        description: "Container port used by the app when start_with_docker=true."
        type: number
        required: false
        default: 3000

      spec_pattern:
        description: "Optional Playwright test grep (passed to --grep)."
        type: string
        required: false
        default: ""

      workers:
        description: "Playwright workers (e.g. 50%, 4)."
        type: string
        required: false
        default: "50%"

      retries:
        description: "Playwright retry count in CI."
        type: number
        required: false
        default: 1

      trace_mode:
        description: "Trace mode (on, on-first-retry, retain-on-failure, off)."
        type: string
        required: false
        default: "on-first-retry"

      artifact_name:
        description: "Artifact base name for logs/evidence."
        type: string
        required: false
        default: "playwright-e2e"

      start_with_docker:
        description: "If true, build & start the app via Docker before tests."
        type: boolean
        required: false
        default: false

      docker_image_name:
        description: "Docker image name used to build/run the app in Docker mode."
        type: string
        required: false
        default: "brikbyte-e2e-app"

      allow_disable:
        description: "If true, repo can disable Playwright via disable_playwright_e2e input."
        type: boolean
        required: false
        default: true

      non_blocking:
        description: "If true, Playwright failures won't fail the workflow (stabilization)."
        type: boolean
        required: false
        default: false

      disable_playwright_e2e:
        description: "If true, skip Playwright run (repo emergency stop)."
        type: boolean
        required: false
        default: false

      enable_firefox:
        description: "Enable Firefox project."
        type: boolean
        required: false
        default: false

      enable_webkit:
        description: "Enable WebKit project."
        type: boolean
        required: false
        default: false

      # -----------------------------------------------------------------------
      # Cross-runner artifact export toggles (BrikByteOS standard)
      # -----------------------------------------------------------------------
      e2e_video:
        description: "If true, exporter treats videos as always-on where supported."
        type: boolean
        required: false
        default: false

      e2e_trace:
        description: "If true, exporter treats traces as always-on where supported."
        type: boolean
        required: false
        default: false

      e2e_artifacts_always:
        description: "If true, exporter exports artifacts even on success."
        type: boolean
        required: false
        default: false

      job_timeout_minutes:
        description: "Job timeout in minutes to avoid hung sessions."
        type: number
        required: false
        default: 30

    secrets: {}

jobs:
  playwright-e2e:
    name: "Playwright E2E • ${{ matrix.browser }}"
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs.job_timeout_minutes }}

    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]

    env:
      # Runner contract
      E2E_RUNNER: playwright
      E2E_TARGET_URL: ${{ inputs.target_url }}

      # Playwright convention (read by your tests/config if you want)
      PW_BROWSER: ${{ matrix.browser }}
      PW_WORKERS: ${{ inputs.workers }}
      PW_RETRIES: ${{ inputs.retries }}
      PW_TRACE_MODE: ${{ inputs.trace_mode }}

      # Exporter toggles
      E2E_BROWSER: ${{ matrix.browser }}
      E2E_VIDEO: ${{ inputs.e2e_video }}
      E2E_TRACE: ${{ inputs.e2e_trace }}
      E2E_ARTIFACTS_ALWAYS: ${{ inputs.e2e_artifacts_always }}

      FORCE_COLOR: "0"

    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v4

      - name: "Honor disable flag"
        env:
          ALLOW_DISABLE: ${{ inputs.allow_disable }}
          DISABLE: ${{ inputs.disable_playwright_e2e }}
        run: |
          set -euo pipefail
          echo "[PLAYWRIGHT] allow_disable=${ALLOW_DISABLE}"
          echo "[PLAYWRIGHT] disable_playwright_e2e=${DISABLE}"

          if [ "${ALLOW_DISABLE}" = "true" ] && [ "${DISABLE}" = "true" ]; then
            echo "[PLAYWRIGHT] Disabled by repo flag. Exiting early."
            exit 0
          fi

      - name: "Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: "Create Docker network (docker mode)"
        if: ${{ inputs.start_with_docker }}
        run: |
          set -euo pipefail
          docker network create e2e-net

      - name: "Build UI Docker image (docker mode)"
        if: ${{ inputs.start_with_docker }}
        working-directory: ${{ inputs.service_workdir }}
        env:
          DOCKER_IMAGE_NAME: ${{ inputs.docker_image_name }}
        run: |
          set -euo pipefail
          docker build -t "${DOCKER_IMAGE_NAME}" .

      - name: "Start UI Docker container (docker mode)"
        if: ${{ inputs.start_with_docker }}
        env:
          DOCKER_IMAGE_NAME: ${{ inputs.docker_image_name }}
          DOCKER_PORT: ${{ inputs.docker_port }}
        run: |
          set -euo pipefail
          docker run -d --rm \
            --name app \
            --network e2e-net \
            -e PORT="${DOCKER_PORT}" \
            "${DOCKER_IMAGE_NAME}"

      - name: "Resolve HEALTH_URL"
        id: health
        env:
          START_WITH_DOCKER: ${{ inputs.start_with_docker }}
          DOCKER_PORT: ${{ inputs.docker_port }}
          HEALTH_PATH: ${{ inputs.health_path }}
          TARGET_URL: ${{ inputs.target_url }}
        run: |
          set -euo pipefail
          if [ "${START_WITH_DOCKER}" = "true" ]; then
            echo "health_url=http://app:${DOCKER_PORT}${HEALTH_PATH}" >> "$GITHUB_OUTPUT"
          else
            echo "health_url=${TARGET_URL}${HEALTH_PATH}" >> "$GITHUB_OUTPUT"
          fi

      - name: "Wait for service readiness"
        env:
          HEALTH_URL: ${{ steps.health.outputs.health_url }}
          START_WITH_DOCKER: ${{ inputs.start_with_docker }}
        run: |
          set -euo pipefail
          echo "[PLAYWRIGHT] Waiting for ${HEALTH_URL}"

          timeout=120
          elapsed=0
          interval=5

          if [ "${START_WITH_DOCKER}" = "true" ]; then
            docker ps --filter "name=app" --format "{{.Names}}" | grep -q "^app$" || {
              echo "[PLAYWRIGHT] ERROR: app container not running"
              docker logs app || true
              exit 1
            }

            while ! docker run --rm --network e2e-net \
              curlimages/curl:8.5.0 -fsS "${HEALTH_URL}" >/dev/null; do
              sleep "${interval}"
              elapsed=$((elapsed + interval))

              docker ps --filter "name=app" --format "{{.Names}}" | grep -q "^app$" || {
                echo "[PLAYWRIGHT] ERROR: app container stopped"
                docker logs app || true
                exit 1
              }

              if [ "${elapsed}" -ge "${timeout}" ]; then
                echo "[PLAYWRIGHT] ERROR: readiness timed out (${timeout}s)"
                docker logs app || true
                exit 1
              fi
            done
          else
            while ! curl -fsS "${HEALTH_URL}" >/dev/null; do
              sleep "${interval}"
              elapsed=$((elapsed + interval))
              if [ "${elapsed}" -ge "${timeout}" ]; then
                echo "[PLAYWRIGHT] ERROR: readiness timed out (${timeout}s)"
                exit 1
              fi
            done
          fi

      - name: "Install dependencies"
        working-directory: ${{ inputs.service_workdir }}
        run: |
          set -euo pipefail
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: "Install Playwright browsers"
        working-directory: ${{ inputs.service_workdir }}
        run: |
          set -euo pipefail
          npx playwright install --with-deps

      - name: "Run Playwright E2E"
        id: run_pw
        if: >
          matrix.browser == 'chromium' ||
          (matrix.browser == 'firefox' && inputs.enable_firefox) ||
          (matrix.browser == 'webkit' && inputs.enable_webkit)
        working-directory: ${{ inputs.service_workdir }}
        env:
          SPEC_PATTERN: ${{ inputs.spec_pattern }}
          START_WITH_DOCKER: ${{ inputs.start_with_docker }}
          NON_BLOCKING: ${{ inputs.non_blocking }}
        run: |
          set -euo pipefail

          echo "[E2E] Browser=${PW_BROWSER}"
          echo "[E2E] Target=${E2E_TARGET_URL}"

          GREP_ARG=""
          if [ -n "${SPEC_PATTERN}" ]; then
            GREP_ARG="--grep ${SPEC_PATTERN}"
          fi

          set +e
          npx playwright test \
            --project="${PW_BROWSER}" \
            ${GREP_ARG}

          exit_code=$?
          set -e

          if [ "${exit_code}" -ne 0 ] && [ "${NON_BLOCKING}" = "true" ]; then
            echo "[PLAYWRIGHT] Non-blocking enabled. Continuing despite failures."
            exit 0
          fi

          exit "${exit_code}"

      - name: "Set E2E_STATUS for exporter (always)"
        if: always()
        run: |
          set -euo pipefail
          status="${{ job.status }}"
          if [ "${status}" = "failure" ] || [ "${status}" = "cancelled" ]; then
            echo "E2E_STATUS=failed" >> "${GITHUB_ENV}"
          else
            echo "E2E_STATUS=success" >> "${GITHUB_ENV}"
          fi

      - name: "Export E2E artifacts (always)"
        if: always()
        uses: BrikByte-Studios/.github/.github/actions/export-e2e-artifacts@main
        with:
          runner: "playwright"
          browser: ${{ matrix.browser }}
          status: ${{ job.status }}
          video: ${{ inputs.e2e_video }}
          trace: ${{ inputs.e2e_trace }}
          artifacts_always: ${{ inputs.e2e_artifacts_always }}
        env:
          E2E_MAX_TOTAL_MB: "300"
          E2E_MAX_VIDEOS: "10"

      - name: "Upload E2E artifacts (always)"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}-${{ matrix.browser }}-${{ github.run_id }}
          path: ${{ inputs.service_workdir }}/.audit/**/e2e/artifacts/**
          if-no-files-found: warn
          include-hidden-files: true

      - name: "Cleanup Docker (docker mode)"
        if: ${{ always() && inputs.start_with_docker }}
        run: |
          set -euo pipefail
          docker rm -f app || true
          docker network rm e2e-net || true
