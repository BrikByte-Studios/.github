# ==============================================================================
# Reusable Cypress E2E Workflow — BrikByteOS
# ==============================================================================
#
# PURPOSE
# -------
# This workflow provides a **standardized, governance-ready Cypress E2E runner**
# for all BrikByte Studios UI services.
#
# It supports TWO execution modes:
#
# 1) External target (staging / preview URL)
#    - Cypress hits an already-running environment
#
# 2) Docker-started UI (local container)
#    - UI is built + started in CI
#    - Cypress runs in a sibling container
#    - Containers communicate via a shared Docker network
#
# WHY THIS DESIGN?
# ----------------
# - Cypress runs inside Docker for determinism
# - Docker networking avoids localhost pitfalls
# - Explicit health checks ensure reliable startup
# - Artifacts (screenshots + videos) are always exported
# - Fully offline (no Cypress Cloud dependency)
#
# GOVERNANCE
# ----------
# - First-class E2E evidence for BrikByteOS audit bundles
# - Deterministic, reproducible CI behavior
# - Clear separation of concerns (app vs test runner)
#
# ==============================================================================

name: "E2E - Cypress (Reusable)"

on:
  # This workflow is ONLY invoked by other workflows
  workflow_call:
    inputs:
      # ------------------------------------------------------------------------
      # Target URL that Cypress will test against.
      #
      # Examples:
      # - https://staging.example.com
      # - http://app:3000   (when using Docker network mode)
      # ------------------------------------------------------------------------
      target_url:
        type: string
        required: false
        default: "https://staging.example.com"

      # ------------------------------------------------------------------------
      # Health endpoint used for readiness checks.
      # Must return HTTP 200 when the service is ready.
      # ------------------------------------------------------------------------
      health_path:
        type: string
        required: false
        default: "/health"

      # ------------------------------------------------------------------------
      # Directory containing:
      # - Dockerfile (if start_with_docker=true)
      # - cypress.config.cjs
      # - tests/e2e/cypress/*
      # ------------------------------------------------------------------------
      service_workdir:
        type: string
        required: false
        default: "."

      # ------------------------------------------------------------------------
      # Cypress Docker image (official).
      # Includes browsers + Cypress binary.
      # ------------------------------------------------------------------------
      cypress_image:
        type: string
        required: false
        default: "cypress/included:13.12.0"

      # ------------------------------------------------------------------------
      # Optional Cypress spec filter.
      # Example:
      #   tests/e2e/cypress/e2e/smoke.cy.ts
      # ------------------------------------------------------------------------
      spec_pattern:
        type: string
        required: false
        default: ""

      # ------------------------------------------------------------------------
      # Retry behavior
      # - runMode   → CI
      # - openMode  → local developer use
      # ------------------------------------------------------------------------
      run_mode_retries:
        type: number
        required: false
        default: 2

      open_mode_retries:
        type: number
        required: false
        default: 0

      # ------------------------------------------------------------------------
      # Artifact name prefix for screenshots/videos
      # ------------------------------------------------------------------------
      artifact_name:
        type: string
        required: false
        default: "cypress-artifacts"

      # ------------------------------------------------------------------------
      # If true:
      # - Build the UI Docker image
      # - Start it in CI
      # - Run Cypress against it via Docker networking
      # ------------------------------------------------------------------------
      start_with_docker:
        type: boolean
        required: false
        default: false

      # ------------------------------------------------------------------------
      # Docker image name used when building the UI
      # ------------------------------------------------------------------------
      docker_image_name:
        type: string
        required: false
        default: "brikbyte-e2e-app"

jobs:
  cypress-e2e:
    name: "Cypress E2E"
    runs-on: ubuntu-latest

    # --------------------------------------------------------------------------
    # Environment variables exposed to Cypress
    # --------------------------------------------------------------------------
    env:
      CYPRESS_BASE_URL: ${{ inputs.target_url }}
      E2E_TARGET_URL: ${{ inputs.target_url }}
      CYPRESS_RUN_MODE_RETRIES: ${{ inputs.run_mode_retries }}
      CYPRESS_OPEN_MODE_RETRIES: ${{ inputs.open_mode_retries }}

    steps:
      # ------------------------------------------------------------------------
      # Checkout repository
      # ------------------------------------------------------------------------
      - name: "Checkout repository"
        uses: actions/checkout@v4

      # ------------------------------------------------------------------------
      # Create a shared Docker network
      #
      # This allows:
      # - UI container (hostname: app)
      # - Cypress container
      # to talk to each other deterministically.
      # ------------------------------------------------------------------------
      - name: "Create Docker network"
        if: ${{ inputs.start_with_docker }}
        run: docker network create e2e-net

      # ------------------------------------------------------------------------
      # Build the UI Docker image
      # ------------------------------------------------------------------------
      - name: "Build UI Docker image"
        if: ${{ inputs.start_with_docker }}
        working-directory: ${{ inputs.service_workdir }}
        env:
          DOCKER_IMAGE_NAME: ${{ inputs.docker_image_name }}
        run: |
          set -euo pipefail
          echo "[CYPRESS-E2E] Building UI image: ${DOCKER_IMAGE_NAME}"
          docker build -t "${DOCKER_IMAGE_NAME}" .

      # ------------------------------------------------------------------------
      # Start the UI container
      #
      # IMPORTANT:
      # - Container name is hard-coded to `app`
      # - Cypress will access it via http://app:3000
      # ------------------------------------------------------------------------
      - name: "Start UI Docker container"
        if: ${{ inputs.start_with_docker }}
        env:
          DOCKER_IMAGE_NAME: ${{ inputs.docker_image_name }}
        run: |
          set -euo pipefail
          docker run -d --rm \
            --name app \
            --network e2e-net \
            -e PORT=3000 \
            "${DOCKER_IMAGE_NAME}"

      # ------------------------------------------------------------------------
      # Wait for service readiness
      #
      # Uses:
      # - curl from host   (external URL mode)
      # - curl from Docker (container network mode)
      # ------------------------------------------------------------------------
      - name: "Wait for service readiness"
        env:
          HEALTH_URL: ${{ inputs.target_url }}${{ inputs.health_path }}
          START_WITH_DOCKER: ${{ inputs.start_with_docker }}
        run: |
          set -euo pipefail
          echo "[CYPRESS-E2E] Waiting for ${HEALTH_URL}"

          timeout=120
          elapsed=0

          if [ "${START_WITH_DOCKER}" = "true" ]; then
            while ! docker run --rm --network e2e-net curlimages/curl:8.5.0 -fsS "${HEALTH_URL}" > /dev/null; do
              sleep 5
              elapsed=$((elapsed + 5))
              if [ "${elapsed}" -ge "${timeout}" ]; then
                docker logs app || true
                exit 1
              fi
            done
          else
            while ! curl -fsS "${HEALTH_URL}" > /dev/null; do
              sleep 5
              elapsed=$((elapsed + 5))
              if [ "${elapsed}" -ge "${timeout}" ]; then
                exit 1
              fi
            done
          fi

      # ------------------------------------------------------------------------
      # Run Cypress inside official Docker image
      # ------------------------------------------------------------------------
      - name: "Run Cypress E2E"
        env:
          CYPRESS_IMAGE: ${{ inputs.cypress_image }}
          SERVICE_WORKDIR: ${{ inputs.service_workdir }}
          SPEC_PATTERN: ${{ inputs.spec_pattern }}
          START_WITH_DOCKER: ${{ inputs.start_with_docker }}
        run: |
          set -euo pipefail

          PROJECT_DIR="/e2e/${SERVICE_WORKDIR}"
          CONFIG_FILE="${PROJECT_DIR}/cypress.config.cjs"

          NET_ARGS=""
          if [ "${START_WITH_DOCKER}" = "true" ]; then
            NET_ARGS="--network e2e-net"
          fi

          docker run --rm ${NET_ARGS} \
            -e CYPRESS_BASE_URL="${CYPRESS_BASE_URL}" \
            -e E2E_TARGET_URL="${E2E_TARGET_URL}" \
            -e CYPRESS_RUN_MODE_RETRIES="${CYPRESS_RUN_MODE_RETRIES}" \
            -e CYPRESS_OPEN_MODE_RETRIES="${CYPRESS_OPEN_MODE_RETRIES}" \
            -v "${GITHUB_WORKSPACE}:/e2e" \
            -w "${PROJECT_DIR}" \
            "${CYPRESS_IMAGE}" \
            npx cypress run --config-file "${CONFIG_FILE}"

      # ------------------------------------------------------------------------
      # Upload Cypress artifacts
      # ------------------------------------------------------------------------
      - name: "Upload Cypress artifacts"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: |
            ${{ inputs.service_workdir }}/tests/e2e/cypress/screenshots
            ${{ inputs.service_workdir }}/tests/e2e/cypress/videos
          if-no-files-found: ignore

      # ------------------------------------------------------------------------
      # Cleanup Docker resources
      # ------------------------------------------------------------------------
      - name: "Cleanup Docker"
        if: always() && inputs.start_with_docker
        run: |
          docker rm -f app || true
          docker network rm e2e-net || true
