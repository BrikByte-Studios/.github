# =============================================================================
# BrikByteOS — Reusable Cypress E2E Workflow (governed browser matrix)
# -------------------------------------------------------------------
# - Uses BrikPipe matrix-plan for deterministic browser matrix
# - Wires BrikByteOS parallel-runner for standard shard contract (framework-native)
#   (Cypress spec sharding NOT enabled yet; shard_total will be 1)
# - Optional flaky reruns via flaky-rerun.sh (opt-in)
# - Exports diagnostics + artifacts using BrikByteOS actions
# =============================================================================

name: "E2E - Cypress (Reusable)"

on:
  workflow_call:
    inputs:
      target_url:
        description: "Base URL Cypress will test against."
        type: string
        required: false
        default: "https://staging.example.com"

      health_path:
        description: "Relative health path for readiness checks."
        type: string
        required: false
        default: "/health"

      service_workdir:
        description: "Working directory for the Cypress project."
        type: string
        required: false
        default: "."

      docker_port:
        description: >
          Container port used by the app when start_with_docker=true.
        type: number
        required: false
        default: 3000

      cypress_image:
        description: "Cypress Docker image to run tests."
        type: string
        required: false
        default: "cypress/included:13.12.0"

      spec_pattern:
        description: "Optional Cypress spec glob/path filter."
        type: string
        required: false
        default: ""

      run_mode_retries:
        description: "Retries when running in CI."
        type: number
        required: false
        default: 2

      open_mode_retries:
        description: "Retries when running via Cypress open."
        type: number
        required: false
        default: 0

      artifact_name:
        description: "Artifact base name for logs/evidence."
        type: string
        required: false
        default: "cypress-e2e"

      start_with_docker:
        description: "If true, build & start the app via Docker before tests."
        type: boolean
        required: false
        default: false

      docker_image_name:
        description: >
          Docker image name used to build/run the app in Docker mode.
        type: string
        required: false
        default: "brikbyte-e2e-app"

      allow_disable:
        description: >
          If true, repo can disable Cypress via disable_cypress_e2e input.
        type: boolean
        required: false
        default: true

      non_blocking:
        description: >
          If true, Cypress failures won't fail the workflow (stabilization).
        type: boolean
        required: false
        default: false

      disable_cypress_e2e:
        description: "If true, skip Cypress run (repo emergency stop)."
        type: boolean
        required: false
        default: false

      # -----------------------------------------------------------------------
      # Matrix governance (BrikPipe)
      # -----------------------------------------------------------------------
      override_shards:
        description: >
          Requested shard count (future: Cypress spec sharding). Clamped.
          NOTE: Cypress spec sharding is NOT enabled in this workflow yet.
        type: string
        required: false
        default: ""

      browsers:
        description: >
          CSV list of Cypress browsers (chrome,firefox,edge).
          Deterministic. Use "chrome" for cheapest default.
        type: string
        required: false
        default: "chrome"

      parallel_mode:
        description: >
          Parallel runner mode: serial|static|dynamic (dynamic reserved).
        type: string
        required: false
        default: "static"

      parallel_enabled:
        description: "Enable parallel-runner contract (true|false)."
        type: string
        required: false
        default: "true"

      # -----------------------------------------------------------------------
      # Cross-runner artifact export toggles (BrikByteOS standard)
      # -----------------------------------------------------------------------
      e2e_video:
        description: >
          If true, exporter treats videos as always-on where supported.
        type: boolean
        required: false
        default: false

      e2e_trace:
        description: >
          If true, exporter treats traces as always-on where supported.
        type: boolean
        required: false
        default: false

      e2e_artifacts_always:
        description: >
          If true, exporter exports artifacts even on success.
        type: boolean
        required: false
        default: false

      job_timeout_minutes:
        description: "Job timeout in minutes to avoid hung sessions."
        type: number
        required: false
        default: 30

      # -----------------------------------------------------------------------
      # Flaky detection (PIPE-FLAKY-RERUN-INTEG-001)
      # -----------------------------------------------------------------------
      flaky_detect:
        description: "Enable suite-level flaky reruns (true|false)"
        type: string
        required: false
        default: "false"

      flaky_reruns:
        description: "Total attempts when flaky_detect=true (e.g., 3)"
        type: string
        required: false
        default: "3"

      flaky_export_path:
        description: >
          Relative path (from service_workdir) to store flaky evidence.
        type: string
        required: false
        default: "out/flaky"

    secrets: {}

permissions:
  contents: read

jobs:
  # ---------------------------------------------------------------------------
  # 0) PLAN: governed browser matrix
  # ---------------------------------------------------------------------------
  plan:
    name: "Plan governed Cypress matrix"
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.plan.outputs.matrix_json }}

    steps:
      - name: "Checkout (future-proof for repo-level config)"
        uses: actions/checkout@v4

      - name: "Generate browser matrix (governed)"
        id: plan
        uses: BrikByte-Studios/.github/.github/actions/matrix-plan@main
        with:
          test_type: e2e
          # Cypress spec sharding not implemented -> force 1.
          override_shards: "1"
          browsers: ${{ inputs.browsers }}

      - name: "Debug matrix_json"
        run: |
          echo "matrix_json=${{ steps.plan.outputs.matrix_json }}"

  # ---------------------------------------------------------------------------
  # 1) RUN: Cypress E2E per browser (and future shards)
  # ---------------------------------------------------------------------------
  cypress-e2e:
    name: "Cypress E2E • ${{ matrix.browser }} • shard ${{ matrix.shard }}"
    needs: plan
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs.job_timeout_minutes }}

    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.plan.outputs.matrix) }}

    env:
      # ----------------------------------------------------------
      # Test runner contract
      # ----------------------------------------------------------
      E2E_RUNNER: cypress
      E2E_TARGET_URL: ${{ inputs.target_url }}

      # Cypress convention
      CYPRESS_BASE_URL: ${{ inputs.target_url }}

      # Retry controls (read by your cypress.config.*)
      CYPRESS_RUN_MODE_RETRIES: ${{ inputs.run_mode_retries }}
      CYPRESS_OPEN_MODE_RETRIES: ${{ inputs.open_mode_retries }}

      # Exporter toggles
      E2E_BROWSER: ${{ matrix.browser }}
      E2E_VIDEO: ${{ inputs.e2e_video && 'true' || 'false' }}
      E2E_TRACE: ${{ inputs.e2e_trace && 'true' || 'false' }}
      E2E_ARTIFACTS_ALWAYS: ${{ inputs.e2e_artifacts_always && 'true' || 'false' }}

      # Flaky contract (opt-in)
      FLAKY_DETECT: ${{ inputs.flaky_detect }}
      FLAKY_RERUNS: ${{ inputs.flaky_reruns }}
      FLAKY_EXPORT_PATH: ${{ inputs.flaky_export_path }}

      FORCE_COLOR: "0"

    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v4

      - name: "Parallel runner (framework-native contract)"
        id: pr
        uses: BrikByte-Studios/.github/.github/actions/parallel-runner@main
        with:
          parallel_enabled: ${{ inputs.parallel_enabled }}
          parallel_mode: ${{ inputs.parallel_mode }}
          shard_index: ${{ matrix.shard }}
          shard_total: ${{ strategy.job-total }}
          selection_mode: "framework-native"
          working_directory: ${{ inputs.service_workdir }}

      - name: "Checkout BrikByte shared scripts"
        uses: actions/checkout@v4
        with:
          repository: BrikByte-Studios/.github
          ref: main
          path: .brikbyte-github

      - name: "Sync flaky-rerun.sh into caller repo"
        run: |
          set -euo pipefail
          mkdir -p .github/scripts
          cp .brikbyte-github/.github/scripts/flaky-rerun.sh \
            .github/scripts/flaky-rerun.sh
          chmod +x .github/scripts/flaky-rerun.sh
          echo "✅ flaky-rerun.sh synced."

      - name: "Honor disable flag"
        env:
          ALLOW_DISABLE: ${{ inputs.allow_disable }}
          DISABLE: ${{ inputs.disable_cypress_e2e }}
        run: |
          set -euo pipefail
          echo "[CYPRESS] allow_disable=${ALLOW_DISABLE}"
          echo "[CYPRESS] disable_cypress_e2e=${DISABLE}"

          if [ "${ALLOW_DISABLE}" = "true" ] && [ "${DISABLE}" = "true" ]; then
            echo "[CYPRESS] Disabled by repo flag. Exiting early."
            exit 0
          fi

      - name: "Create Docker network (docker mode)"
        if: ${{ inputs.start_with_docker }}
        run: |
          set -euo pipefail
          docker network create e2e-net

      - name: "Build UI Docker image (docker mode)"
        if: ${{ inputs.start_with_docker }}
        working-directory: ${{ inputs.service_workdir }}
        env:
          DOCKER_IMAGE_NAME: ${{ inputs.docker_image_name }}
        run: |
          set -euo pipefail
          docker build -t "${DOCKER_IMAGE_NAME}" .

      - name: "Start UI Docker container (docker mode)"
        if: ${{ inputs.start_with_docker }}
        env:
          DOCKER_IMAGE_NAME: ${{ inputs.docker_image_name }}
          DOCKER_PORT: ${{ inputs.docker_port }}
        run: |
          set -euo pipefail
          docker run -d --rm \
            --name app \
            --network e2e-net \
            -e PORT="${DOCKER_PORT}" \
            "${DOCKER_IMAGE_NAME}"

      - name: "Resolve HEALTH_URL"
        id: health
        env:
          START_WITH_DOCKER: ${{ inputs.start_with_docker }}
          DOCKER_PORT: ${{ inputs.docker_port }}
          HEALTH_PATH: ${{ inputs.health_path }}
          TARGET_URL: ${{ inputs.target_url }}
        run: |
          set -euo pipefail
          if [ "${START_WITH_DOCKER}" = "true" ]; then
            echo "health_url=http://app:${DOCKER_PORT}${HEALTH_PATH}" \
              >> "$GITHUB_OUTPUT"
          else
            echo "health_url=${TARGET_URL}${HEALTH_PATH}" \
              >> "$GITHUB_OUTPUT"
          fi

      - name: "Wait for service readiness"
        env:
          HEALTH_URL: ${{ steps.health.outputs.health_url }}
          START_WITH_DOCKER: ${{ inputs.start_with_docker }}
        run: |
          set -euo pipefail
          echo "[CYPRESS] Waiting for ${HEALTH_URL}"

          timeout=120
          elapsed=0
          interval=5

          if [ "${START_WITH_DOCKER}" = "true" ]; then
            docker ps --filter "name=app" --format "{{.Names}}" \
              | grep -q "^app$" || {
                echo "[CYPRESS] ERROR: app container not running"
                docker logs app || true
                exit 1
              }

            while ! docker run --rm --network e2e-net \
              curlimages/curl:8.5.0 -fsS "${HEALTH_URL}" >/dev/null; do
              sleep "${interval}"
              elapsed=$((elapsed + interval))

              docker ps --filter "name=app" --format "{{.Names}}" \
                | grep -q "^app$" || {
                  echo "[CYPRESS] ERROR: app container stopped"
                  docker logs app || true
                  exit 1
                }

              if [ "${elapsed}" -ge "${timeout}" ]; then
                echo "[CYPRESS] ERROR: readiness timed out (${timeout}s)"
                docker logs app || true
                exit 1
              fi
            done
          else
            while ! curl -fsS "${HEALTH_URL}" >/dev/null; do
              sleep "${interval}"
              elapsed=$((elapsed + interval))
              if [ "${elapsed}" -ge "${timeout}" ]; then
                echo "[CYPRESS] ERROR: readiness timed out (${timeout}s)"
                exit 1
              fi
            done
          fi

          echo "[CYPRESS] Ready ✅"

      - name: "Run Cypress E2E (flaky opt-in)"
        id: run_cypress
        env:
          CYPRESS_IMAGE: ${{ inputs.cypress_image }}
          SERVICE_WORKDIR: ${{ inputs.service_workdir }}
          SPEC_PATTERN: ${{ inputs.spec_pattern }}
          START_WITH_DOCKER: ${{ inputs.start_with_docker }}
          NON_BLOCKING: ${{ inputs.non_blocking }}
        run: |
          set -euo pipefail

          if [ ! -f "${GITHUB_WORKSPACE}/${SERVICE_WORKDIR}/cypress.config.cjs" ]; then
            echo "[CYPRESS] ERROR: Missing ${SERVICE_WORKDIR}/cypress.config.cjs"
            exit 1
          fi

          PROJECT_DIR="/e2e/${SERVICE_WORKDIR}"
          CONFIG_FILE="${PROJECT_DIR}/cypress.config.cjs"

          SPEC_ARG=""
          if [ -n "${SPEC_PATTERN}" ]; then
            SPEC_ARG="--spec ${SPEC_PATTERN}"
          fi

          NET_ARGS=""
          if [ "${START_WITH_DOCKER}" = "true" ]; then
            NET_ARGS="--network e2e-net"
          fi

          echo "[CYPRESS] Browser=${E2E_BROWSER}"
          echo "[CYPRESS] Target=${E2E_TARGET_URL}"
          echo "[CYPRESS] Shard=${SHARD_INDEX}/${SHARD_TOTAL} (contract)"
          echo "[CYPRESS] Workdir=${SERVICE_WORKDIR}"
          echo "[CYPRESS] Image=${CYPRESS_IMAGE}"

          export FLAKY_EXPORT_PATH="${PWD}/${FLAKY_EXPORT_PATH:-out/flaky}"
          export FLAKY_LABEL="cypress-${E2E_BROWSER}"
          FLAKY_SH="${GITHUB_WORKSPACE}/.github/scripts/flaky-rerun.sh"

          if [[ ! -f "${FLAKY_SH}" ]]; then
            echo "❌ flaky-rerun.sh not found at: ${FLAKY_SH}"
            ls -la "${GITHUB_WORKSPACE}/.github/scripts" || true
            exit 1
          fi

          set +e
          "${FLAKY_SH}" -- docker run --rm ${NET_ARGS} \
            -e CYPRESS_BASE_URL="${CYPRESS_BASE_URL}" \
            -e E2E_TARGET_URL="${E2E_TARGET_URL}" \
            -e CYPRESS_RUN_MODE_RETRIES="${CYPRESS_RUN_MODE_RETRIES}" \
            -e CYPRESS_OPEN_MODE_RETRIES="${CYPRESS_OPEN_MODE_RETRIES}" \
            -v "${GITHUB_WORKSPACE}:/e2e" \
            -w "${PROJECT_DIR}" \
            "${CYPRESS_IMAGE}" \
            npx cypress run \
            --browser "${E2E_BROWSER}" \
            --config-file "${CONFIG_FILE}" \
            ${SPEC_ARG}

          exit_code=$?
          set -e

          if [ "${exit_code}" -ne 0 ] && [ "${NON_BLOCKING}" = "true" ]; then
            echo "[CYPRESS] Non-blocking enabled. Continuing despite failures."
            exit 0
          fi

          exit "${exit_code}"

      - name: "Capture E2E diagnostics (always)"
        if: always()
        uses: BrikByte-Studios/.github/.github/actions/capture-e2e-diagnostics@main
        with:
          runner: "cypress"
          browser: ${{ matrix.browser }}
          status: ${{ job.status }}
        env:
          CYPRESS_DIAG_DIR: >
            ${{ inputs.service_workdir }}/tests/e2e/cypress/diagnostics
          PLAYWRIGHT_DIAG_DIR: "test-results/diagnostics"
          SELENIUM_DIAG_DIR: "target/selenium-artifacts/diagnostics"
          E2E_DIAG_HEAVY_ON_FAILURE_ONLY: "true"
          E2E_DIAG_DISABLE_HAR_BY_DEFAULT: "true"
          E2E_DIAG_MAX_TOTAL_MB: "150"

      - name: "Set E2E_STATUS for exporter (always)"
        if: always()
        run: |
          set -euo pipefail
          status="${{ job.status }}"
          if [ "${status}" = "failure" ] || [ "${status}" = "cancelled" ]; then
            echo "E2E_STATUS=failed" >> "${GITHUB_ENV}"
          else
            echo "E2E_STATUS=success" >> "${GITHUB_ENV}"
          fi

      - name: "Export E2E artifacts (always)"
        if: always()
        uses: BrikByte-Studios/.github/.github/actions/export-e2e-artifacts@main
        with:
          runner: "cypress"
          browser: ${{ matrix.browser }}
          status: ${{ job.status }}
          video: ${{ inputs.e2e_video }}
          trace: ${{ inputs.e2e_trace }}
          artifacts_always: ${{ inputs.e2e_artifacts_always }}
        env:
          E2E_MAX_TOTAL_MB: "300"
          E2E_MAX_VIDEOS: "10"
          CYPRESS_SCREENSHOTS_DIR: >
            ${{ inputs.service_workdir }}/tests/e2e/cypress/screenshots
          CYPRESS_VIDEOS_DIR: >
            ${{ inputs.service_workdir }}/tests/e2e/cypress/videos
          CYPRESS_REPORT_DIR: "${{ inputs.service_workdir }}/cypress/reports"

      - name: "Upload E2E artifacts (always)"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}-${{ matrix.browser }}-${{ github.run_id }}
          path: |
            .audit/**/e2e/artifacts/**
            .audit/**/e2e/diagnostics/**
            ${{ inputs.service_workdir }}/out/flaky/**
          if-no-files-found: warn
          include-hidden-files: true
          retention-days: 14

      - name: "Cleanup Docker (docker mode)"
        if: ${{ always() && inputs.start_with_docker }}
        run: |
          set -euo pipefail
          docker rm -f app || true
          docker network rm e2e-net || true
