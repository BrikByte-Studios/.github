# =============================================================================
# BrikByteOS â€” Reusable Go Unit Test Workflow (with governed sharding)
# -----------------------------------------------------------------------------
# WBS ID : PIPE-TEST-UNIT-CI-BUILD-002
#
# Matrix plan integration:
#   - Uses BrikPipe Matrix Plan composite action to compute shards deterministically
#   - Parallel rules live in:
#       BrikByte-Studios/.github/.github/actions/matrix-plan/parallel-matrix.yml
# =============================================================================
name: "BrikByteOS â€” Go Unit Tests"

on:
  workflow_call:
    inputs:
      go-version:
        description: "Go version (must align with runtime matrix, e.g. 1.22.x)"
        required: false
        type: string
        default: "1.22.x"
      working-directory:
        description: "Path to Go module root (Makefile + go.mod)"
        required: false
        type: string
        default: "."

      # ------------------------------
      # Governed parallelism (optional)
      # ------------------------------
      override_shards:
        description: "Optional requested shard count (clamped to caps)."
        required: false
        type: string
        default: ""
      matrix_config_path:
        description: >
          Optional path to parallel-matrix.yml.
          Leave empty to use default inside BrikByte-Studios/.github.
        required: false
        type: string
        default: ""

permissions:
  contents: read

jobs:
  # ---------------------------------------------------------------------------
  # 0) Plan matrix (must be a separate job to use outputs in strategy.matrix)
  # ---------------------------------------------------------------------------
  plan:
    name: "Plan matrix (go unit)"
    runs-on: ubuntu-latest
    outputs:
      matrix_json: ${{ steps.plan.outputs.matrix_json }}
    steps:
      - name: "Compute matrix plan (unit)"
        id: plan
        uses: BrikByte-Studios/.github/.github/actions/matrix-plan@main
        with:
          test_type: "unit"
          config_path: ${{ inputs.matrix_config_path }}
          override_shards: ${{ inputs.override_shards }}

  # ---------------------------------------------------------------------------
  # 1) Execute tests (sharded)
  # ---------------------------------------------------------------------------
  test:
    name: "Go: Unit Tests (sharded)"
    runs-on: ubuntu-latest
    needs: plan

    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.plan.outputs.matrix_json) }}

    env:
      LANGUAGE: go
      GO_VERSION: ${{ inputs.go-version != '' && inputs.go-version || '1.22.x' }}
      WORKING_DIRECTORY: ${{ inputs.working-directory != '' && inputs.working-directory || '.' }}
      GOFLAGS: "-mod=readonly"

      # shard metadata (defined by matrix-plan output)
      SHARD_INDEX: ${{ matrix.shard }}
      SHARD_TOTAL: ${{ fromJson(needs.plan.outputs.matrix_json).shard.size }}

      # standardized contract for Makefile runners
      UNIT_SHARD: ${{ matrix.shard }}
      UNIT_SHARD_TOTAL: ${{ fromJson(needs.plan.outputs.matrix_json).shard.size }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify Go test layout
        run: |
          echo "ðŸ“ Working directory: ${WORKING_DIRECTORY}"

          if [ ! -d "${WORKING_DIRECTORY}" ]; then
            echo "âŒ WORKING_DIRECTORY '${WORKING_DIRECTORY}' does not exist."
            exit 1
          fi

          if [ ! -f "${WORKING_DIRECTORY}/go.mod" ]; then
            echo "âŒ go.mod not found in ${WORKING_DIRECTORY}."
            exit 1
          fi

          if [ ! -f "${WORKING_DIRECTORY}/Makefile" ]; then
            echo "âŒ Makefile not found in ${WORKING_DIRECTORY}."
            echo "   Expected 'make test' mapping to 'go test ./...'."
            exit 1
          fi

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: "Cache Go modules & build cache"
        uses: BrikByte-Studios/.github/.github/actions/cache-go-deps@main
        with:
          go-version: ${{ env.GO_VERSION }}
          project-path: ${{ env.WORKING_DIRECTORY }}

      # -------------------------------------------------------------------
      # Install go-junit-report so Makefile can safely emit out/junit.xml
      # -------------------------------------------------------------------
      - name: Install go-junit-report
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          set -euo pipefail
          echo "ðŸ“¦ Installing go-junit-report..."
          go install github.com/jstemmer/go-junit-report/v2@latest
          GOPATH="$(go env GOPATH)"
          echo "ðŸ“ GOPATH is: ${GOPATH}"
          echo "${GOPATH}/bin" >> "$GITHUB_PATH"
          echo "âœ… go-junit-report installed and added to PATH"

      - name: Run Go unit tests (make test)
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          set -euo pipefail

          echo "ðŸ§ª [TEST] Language   : ${LANGUAGE}"
          echo "ðŸ§ª [TEST] Runtime    : Go ${GO_VERSION}"
          echo "ðŸ§ª [TEST] Directory  : ${PWD}"
          echo "ðŸ§ª [TEST] Shard      : ${SHARD_INDEX}/${SHARD_TOTAL}"
          echo "ðŸ§ª [TEST] Command    : make test"
          echo "ðŸ§ª [TEST] Status     : STARTING"

          START_TS=$(date +%s)

          make test

          END_TS=$(date +%s)
          DURATION=$((END_TS - START_TS))

          echo "âœ… [TEST] Status     : COMPLETED"
          echo "â±  [TEST] Duration   : ${DURATION} seconds"

      # -----------------------------------------------------------------------
      # X) Collect coverage (Go: go test -coverprofile=coverage.out)
      # -----------------------------------------------------------------------
      - name: Normalize coverage â†’ coverage.json
        uses: BrikByte-Studios/.github/.github/actions/coverage-merge@main
        with:
          language: ${{ env.LANGUAGE }}
          working-directory: ${{ env.WORKING_DIRECTORY }}
          out: out/coverage.json

      - name: Ensure summary.line is set in coverage.json (Go)
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          set -euo pipefail
          echo "ðŸ”§ Normalizing coverage: syncing summary.line from Go coverage.out"

          if [ ! -f "coverage.out" ]; then
            echo "âŒ coverage.out not found â€“ did 'go test ./... -coverprofile=coverage.out' run in make test?"
            ls -R
            exit 1
          fi

          go tool cover -func=coverage.out > coverage-func.txt

          echo "ðŸ“„ go tool cover output (summary line should be 'total: ... X.Y%'):"
          tail -n 5 coverage-func.txt || cat coverage-func.txt

          python - << 'EOF'
          import json
          from pathlib import Path

          lines = Path("coverage-func.txt").read_text(encoding="utf-8").strip().splitlines()
          if not lines:
            raise SystemExit("coverage-func.txt is empty; cannot compute coverage.")

          last = lines[-1]
          parts = last.split()
          if not parts or not parts[-1].endswith("%"):
            raise SystemExit(f"Unexpected go tool cover summary line: {last!r}")

          pct_str = parts[-1].rstrip("%")
          try:
            line_pct = float(pct_str)
          except ValueError:
            raise SystemExit(f"Invalid coverage percentage: {pct_str!r}")

          out_dir = Path("out")
          out_dir.mkdir(parents=True, exist_ok=True)
          cov_path = out_dir / "coverage.json"

          try:
            cov = json.loads(cov_path.read_text(encoding="utf-8"))
          except FileNotFoundError:
            cov = {}

          cov.setdefault("summary", {})
          cov["summary"]["line"] = line_pct
          cov.setdefault("files", [])

          cov_path.write_text(json.dumps(cov, indent=2), encoding="utf-8")
          print(f"âœ… Updated out/coverage.json with summary.line = {line_pct:.1f}")
          EOF

          echo "âœ… coverage.json after normalization:"
          cat out/coverage.json

      - name: Upload Go coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          # per-shard artifact name (so merge job can pattern match)
          name: coverage-go-shard${{ env.SHARD_INDEX }}
          path: |
            ${{ env.WORKING_DIRECTORY }}/out/coverage.json
            ${{ env.WORKING_DIRECTORY }}/coverage.out
            ${{ env.WORKING_DIRECTORY }}/coverage-func.txt
            ${{ env.WORKING_DIRECTORY }}/out/junit.xml
          if-no-files-found: ignore
          include-hidden-files: true
          retention-days: 14
