name: "Governance — Label Sync"

on:
  push:
    branches:
      - main
    paths:
      - "labels.yml"
      - ".github/labels.yml"

  workflow_dispatch:
    inputs:
      dry_run:
        description: "Run in dry-run mode (no changes applied)"
        required: false
        default: "false"

  schedule:
    - cron: "0 1 * * *"  # 01:00 UTC daily

permissions:
  contents: read
  issues: write

env:
  # Default; will be overridden by detection step below
  LABELS_FILE_PATH: ".github/labels.yml"
  DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}

jobs:
  label-sync:
    name: "Sync labels from labels.yml"
    runs-on: ubuntu-latest

    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "Locate labels.yml"
        id: locate_labels
        shell: bash
        run: |
          if [ -f ".github/labels.yml" ]; then
            echo "Found .github/labels.yml"
            echo "labels_file=.github/labels.yml" >> "$GITHUB_OUTPUT"
          elif [ -f "labels.yml" ]; then
            echo "Found labels.yml at repo root"
            echo "labels_file=labels.yml" >> "$GITHUB_OUTPUT"
          else
            echo "::error::No labels.yml found. Expected either '.github/labels.yml' or 'labels.yml' at repo root."
            exit 1
          fi

      - name: "Print labels.yml (debug)"
        run: |
          echo "Using labels file: ${{ steps.locate_labels.outputs.labels_file }}"
          echo "===== labels.yml content ====="
          cat "${{ steps.locate_labels.outputs.labels_file }}"
          echo "================================"

      - name: "Sync labels"
        if: env.DRY_RUN == 'false'
        uses: micnncim/action-label-syncer@v1
        with:
          manifest: ${{ steps.locate_labels.outputs.labels_file }}
          prune: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: "Dry-run notice (no changes applied)"
        if: env.DRY_RUN == 'true'
        run: |
          echo "DRY_RUN=true — labels.yml located at '${{ steps.locate_labels.outputs.labels_file }}'."
          echo "No changes were applied. Set dry_run=false or omit input to sync labels."
