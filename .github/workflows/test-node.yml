# =============================================================================
# BrikByteOS ‚Äî Reusable Node.js Unit Test Workflow (with governed matrix-plan)
# -----------------------------------------------------------------------------
# WBS ID : PIPE-TEST-UNIT-CI-BUILD-002
#
# Adds:
#   - Deterministic shards via BrikPipe matrix-plan (unit)
#   - Safe-by-default shard caps (clamped by parallel-matrix.yml in .github repo)
#   - Per-shard coverage artifact naming to support merge later
# =============================================================================
name: "BrikByteOS ‚Äî Node.js Unit Tests"

on:
  workflow_call:
    inputs:
      node-version:
        description: "Node.js version (must align with Runtime Matrix)"
        required: false
        type: string
        default: "20"

      working-directory:
        description: "Path to Node project (folder with package.json + Makefile)"
        required: false
        type: string
        default: "."

      # -----------------------------
      # Matrix-plan (unit) wiring
      # -----------------------------
      override_shards:
        description: "Requested shard count (unit). Will be clamped by governance caps."
        required: false
        type: string
        default: ""

      matrix_config_path:
        description: "Optional path to parallel-matrix.yml. Leave empty to use action default."
        required: false
        type: string
        default: ""
      parallel_mode:
        description: "Parallel mode: static|dynamic (default static)"
        required: false
        type: string
        default: "static"
permissions:
  contents: read

jobs:
  # ----------------------------------------------------------------------------
  # PLAN: governed deterministic matrix (unit shards)
  # ----------------------------------------------------------------------------
  plan:
    name: "Plan governed Unit matrix"
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.plan.outputs.matrix_json }}
    steps:
      - name: "Generate unit shard matrix (governed)"
        id: plan
        uses: BrikByte-Studios/.github/.github/actions/matrix-plan@main
        with:
          test_type: unit
          config_path: ${{ inputs.matrix_config_path }}
          override_shards: ${{ inputs.override_shards }}

  # ----------------------------------------------------------------------------
  # TEST: shard matrix
  # ----------------------------------------------------------------------------
  test:
    name: "Node.js: Unit Tests ‚Ä¢ shard ${{ matrix.shard }}"
    needs: plan
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.plan.outputs.matrix) }}

    env:
      LANGUAGE: node
      NODE_VERSION: ${{ inputs.node-version || '20' }}
      WORKING_DIRECTORY: ${{ inputs.working-directory || '.' }}

      # Shard contract (consumed by your Makefile/test runner when implemented)
      SHARD_INDEX: ${{ matrix.shard }}              # 0-based
      SHARD_TOTAL: ${{ strategy.job-total }}
      UNIT_SHARD: ${{ matrix.shard + 1 }}
      UNIT_SHARD_TOTAL: ${{ strategy.job-total }}

      # Optional generic contract (if you want to standardize across languages)
      E2E_SHARD: ${{ matrix.shard }}
      E2E_SHARD_TOTAL: ${{ strategy.job-total }}

      PARALLEL_MODE: ${{ inputs.parallel_mode }}
      PARALLEL: "true"

    steps:
      # -----------------------------------------------------------------------
      # 1) Checkout repository
      # -----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # 2) Verify Node project layout
      # -----------------------------------------------------------------------
      - name: Verify Node test layout
        run: |
          set -euo pipefail
          echo "üìÅ Working directory: ${WORKING_DIRECTORY}"

          if [ ! -d "${WORKING_DIRECTORY}" ]; then
            echo "‚ùå WORKING_DIRECTORY '${WORKING_DIRECTORY}' does not exist."
            exit 1
          fi

          if [ ! -f "${WORKING_DIRECTORY}/package.json" ]; then
            echo "‚ùå package.json not found in ${WORKING_DIRECTORY}."
            exit 1
          fi

          if [ ! -f "${WORKING_DIRECTORY}/Makefile" ]; then
            echo "‚ùå Makefile not found in ${WORKING_DIRECTORY}."
            echo "   Expected a Makefile exposing 'make test' (Node)."
            exit 1
          fi

      # -----------------------------------------------------------------------
      # 3) Setup Node.js runtime
      # -----------------------------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # -----------------------------------------------------------------------
      # 4) Cache deps
      # -----------------------------------------------------------------------
      - name: "Cache Node dependencies (npm / Yarn / pnpm)"
        uses: BrikByte-Studios/.github/.github/actions/cache-node-deps@main
        with:
          node-version: ${{ env.NODE_VERSION }}
          project-path: ${{ env.WORKING_DIRECTORY }}

      - name: Parallel runner (serial/static/dynamic)
        id: pr
        uses: BrikByte-Studios/.github/.github/actions/parallel-runner@main
        with:
          parallel_enabled: "true"
          parallel_mode: ${{ env.PARALLEL_MODE }}
          shard_index: ${{ matrix.shard }}          # 0-based
          shard_total: ${{ strategy.job-total }}
          selection_mode: "file-split"
          working_directory: ${{ env.WORKING_DIRECTORY }}
          test_glob: "**/*.test.*"
          out_list: "${{ env.WORKING_DIRECTORY }}/out/shard-files.txt"
          # items_file: "${{ env.WORKING_DIRECTORY }}/out/test-items.txt"
          # optional knobs:
          # allow_empty_items: true
          # selection_mode: file-split|shard-map|framework-native


      # - name: Discover Node unit test items
      #   shell: bash
      #   run: |
      #     set -euo pipefail
      #     mkdir -p ${{ env.WORKING_DIRECTORY }}/out

      #     # Pick patterns that match your repo (examples):
      #     find ${{ env.WORKING_DIRECTORY }} -type f \( \
      #       -path "*/tests/unit/*" -o -path "*/test/*" -o -path "*/__tests__/*" \
      #     \) \( \
      #       -name "*.test.js" -o -name "*.spec.js" -o -name "*.test.ts" -o -name "*.spec.ts" \
      #     \) | sort > ${{ env.WORKING_DIRECTORY }}/out/test-items.txt
      #     echo "Discovered $(wc -l < ${{ env.WORKING_DIRECTORY }}/out/test-items.txt) items"
      #     head -n 20 ${{ env.WORKING_DIRECTORY }}/out/test-items.txt || true
      #     ls -la ${{ env.WORKING_DIRECTORY }}/out

      # - name: "Plan shards (static/dynamic) ‚Äî non-blocking"
      #   id: shardplan
      #   continue-on-error: true
      #   uses: BrikByte-Studios/.github/.github/actions/shard-plan@main
      #   with:
      #     mode: ${{ env.PARALLEL_MODE }}
      #     shard_count: ${{ env.UNIT_SHARD_TOTAL }}
      #     test_type: "unit"
      #     items_file: "${{ env.WORKING_DIRECTORY }}/out/test-items.txt"
      #     workdir: "${{ env.WORKING_DIRECTORY }}"
      #     out_dir: "${{ env.WORKING_DIRECTORY }}/out"
      #     audit_root: ".audit"
      #     seed: "${{ github.sha }}" # deterministic input

      # - name: "Fallback to static if shard planner failed"
      #   if: steps.shardplan.outcome != 'success'
      #   run: |
      #     echo "::warning::Shard planner failed; falling back to static mode."
      #     echo "PARALLEL_MODE=static" >> "$GITHUB_ENV"

      # -----------------------------------------------------------------------
      # 5) Run unit tests via `make test`
      #
      # NOTE:
      #   Your repo's Makefile should read UNIT_SHARD/UNIT_SHARD_TOTAL and only
      #   execute its shard (deterministically). If it doesn't yet, each shard
      #   will run the full suite (wasteful but still correct).
      # -----------------------------------------------------------------------
      - name: Run Node.js unit tests (make test)
        if: steps.pr.outputs.is_empty_shard != 'true'
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          set -euo pipefail

          echo "üß™ [TEST] Language      : ${LANGUAGE}"
          echo "üß™ [TEST] Runtime       : Node.js ${NODE_VERSION}"
          echo "üß™ [TEST] Directory     : ${PWD}"
          echo "üß™ [TEST] Command       : make test"
          echo "üß™ [TEST] Shard         : ${UNIT_SHARD}/${UNIT_SHARD_TOTAL}"
          echo "üß™ [TEST] Mode          : ${PARALLEL_MODE}"
          echo "üß™ [TEST] Status        : STARTING"

          START_TS=$(date +%s)
          export UNIT_SHARD UNIT_SHARD_TOTAL
          export TEST_ITEMS_FILE="${{ steps.pr.outputs.selected_items_file }}"
          make test

          END_TS=$(date +%s)
          DURATION=$((END_TS - START_TS))

          echo "‚úÖ [TEST] Status        : COMPLETED"
          echo "‚è±  [TEST] Duration      : ${DURATION} seconds"

      - name: Empty shard (skip)
        if: steps.pr.outputs.is_empty_shard == 'true'
        run: echo "‚ÑπÔ∏è Empty shard ‚Äî nothing to run."

      - name: Detect coverage presence
        id: cov
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          set -euo pipefail
          if [ -f "coverage/coverage-final.json" ] || [ -f "coverage/coverage-summary.json" ]; then
            echo "has_coverage=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_coverage=false" >> "$GITHUB_OUTPUT"
          fi

      # -----------------------------------------------------------------------
      # X) Collect coverage (Node: Jest + c8 / Istanbul)
      #    - Expects coverage/coverage-final.json + coverage/coverage-summary.json
      #    - Writes normalized out/coverage.json under WORKING_DIRECTORY.
      # -----------------------------------------------------------------------
      - name: Normalize coverage ‚Üí coverage.json
        if: steps.cov.outputs.has_coverage == 'true'
        uses: BrikByte-Studios/.github/.github/actions/coverage-merge@main
        with:
          language: ${{ env.LANGUAGE }}
          working-directory: ${{ env.WORKING_DIRECTORY }}
          out: out/coverage.json

      - name: Ensure summary.line is set in coverage.json (Node + c8 json-summary)
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          set -euo pipefail
          echo "üîß Normalizing coverage: syncing summary.line from coverage/coverage-summary.json"

          # Empty shard => no tests executed => no coverage folder.
          # This is OK; skip to keep shard job green.
          if [ ! -f "coverage/coverage-summary.json" ]; then
            echo "‚ÑπÔ∏è No coverage/coverage-summary.json found (likely empty shard). Skipping summary sync."
            echo "‚ÑπÔ∏è Workspace listing:"
            ls -la
            exit 0
          fi

          node - << 'EOF'
          const fs = require('fs');

          function readJson(path) {
            return JSON.parse(fs.readFileSync(path, 'utf8'));
          }

          const summary = readJson('coverage/coverage-summary.json');

          if (!summary.total || !summary.total.lines || typeof summary.total.lines.pct !== 'number') {
            console.error('Unexpected coverage-summary.json format. total.lines.pct is missing.');
            process.exit(1);
          }

          const linePct = summary.total.lines.pct;

          let cov;
          try { cov = readJson('out/coverage.json'); } catch { cov = {}; }

          if (!cov.summary || typeof cov.summary !== 'object') cov.summary = {};
          cov.summary.line = linePct;

          if (!Array.isArray(cov.files)) cov.files = [];

          fs.mkdirSync('out', { recursive: true });
          fs.writeFileSync('out/coverage.json', JSON.stringify(cov, null, 2));
          console.log('‚úÖ Updated out/coverage.json with summary.line =', linePct);
          EOF

          echo "‚úÖ coverage.json after normalization:"
          cat out/coverage.json

      # -----------------------------------------------------------------------
      # Upload per-shard coverage artifacts (important for later merge)
      # -----------------------------------------------------------------------
      - name: Upload Node coverage artifacts (per shard)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ env.LANGUAGE }}-shard${{ matrix.shard }}
          path: |
            ${{ env.WORKING_DIRECTORY }}/out/coverage.json
            ${{ env.WORKING_DIRECTORY }}/coverage/
            ${{ env.WORKING_DIRECTORY }}/out/junit.xml
          if-no-files-found: ignore
          include-hidden-files: true
          retention-days: 14
