# =============================================================================
# BrikByteOS ‚Äî Reusable Node.js Unit Test Workflow
# -----------------------------------------------------------------------------
# WBS ID : PIPE-TEST-UNIT-CI-BUILD-002
# Repos  :
#   - Implemented in:
#       ‚Ä¢ BrikByte-Studios/.github (.github/workflows/test-node.yml)
#   - Consumed by:
#       ‚Ä¢ BrikByte-Studios/brik-pipe-examples/node-api-example
#       ‚Ä¢ Product repos (via workflow_call)
#
# Contract:
#   - Expects repo to expose:
#       ‚Ä¢ Makefile with `make test` (per PIPE-TEST-UNIT-STANDARDS-INIT-001)
#   - This workflow:
#       ‚Ä¢ Sets up Node
#       ‚Ä¢ (Optionally) uses cache-node-deps composite
#       ‚Ä¢ Runs `make test` and fails CI on non-zero exit.
# =============================================================================
name: "BrikByteOS ‚Äî Node.js Unit Tests"

on:
  # Reusable mode for service repos
  workflow_call:
    inputs:
      node-version:
        description: "Node.js version (must align with Runtime Matrix)"
        required: false
        type: string
        default: "20"
      working-directory:
        description: "Path to Node project (folder with package.json + Makefile)"
        required: false
        type: string
        default: "."

permissions:
  contents: read

jobs:
  test:
    name: "Node.js: Unit Tests"
    # Optional matrix for direct CI mode.
    # - For workflow_call, we still honour inputs.node-version;
    #   if you want the matrix only in direct mode, you can gate it with `if`.
    strategy:
      fail-fast: false
      matrix:
        node-version: ["18", "20"]

    runs-on: ubuntu-latest

    # NOTE:
    #   - When called via workflow_call, inputs.node-version is set.
    #   - When triggered via push/PR:
    #        inputs.node-version is empty, so we use matrix.node-version.
    env:
      LANGUAGE: node
      NODE_VERSION: ${{ inputs.node-version != '' && inputs.node-version || matrix.node-version }}
      WORKING_DIRECTORY: ${{ inputs.working-directory != '' && inputs.working-directory || '.' }}

    steps:
      # -----------------------------------------------------------------------
      # 1) Checkout repository
      # -----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # 2) Verify Node project layout
      #    - Must have package.json + Makefile in WORKING_DIRECTORY
      # -----------------------------------------------------------------------
      - name: Verify Node test layout
        run: |
          echo "üìÅ Working directory: ${WORKING_DIRECTORY}"

          if [ ! -d "${WORKING_DIRECTORY}" ]; then
            echo "‚ùå WORKING_DIRECTORY '${WORKING_DIRECTORY}' does not exist."
            exit 1
          fi

          if [ ! -f "${WORKING_DIRECTORY}/package.json" ]; then
            echo "‚ùå package.json not found in ${WORKING_DIRECTORY}."
            exit 1
          fi

          if [ ! -f "${WORKING_DIRECTORY}/Makefile" ]; then
            echo "‚ùå Makefile not found in ${WORKING_DIRECTORY}."
            echo "   Expected a Makefile exposing 'make test' (Node)."
            exit 1
          fi

      # -----------------------------------------------------------------------
      # 3) Setup Node.js runtime
      # -----------------------------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # -----------------------------------------------------------------------
      # 4) (Optional) Use central Node cache composite
      #    - Implemented in BrikByte-Studios/.github/.github/actions/cache-node-deps
      # -----------------------------------------------------------------------
      - name: "Cache Node dependencies (npm / Yarn / pnpm)"
        uses: BrikByte-Studios/.github/.github/actions/cache-node-deps@main
        with:
          node-version: ${{ env.NODE_VERSION }}
          project-path: ${{ env.WORKING_DIRECTORY }}

      # -----------------------------------------------------------------------
      # 5) Run unit tests via `make test`
      #    - MUST fail on non-zero exit (blocks merges via status checks).
      # -----------------------------------------------------------------------
      - name: Run Node.js unit tests (make test)
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          set -euo pipefail

          echo "üß™ [TEST] Language  : ${LANGUAGE}"
          echo "üß™ [TEST] Runtime   : Node.js ${NODE_VERSION}"
          echo "üß™ [TEST] Directory : ${PWD}"
          echo "üß™ [TEST] Command   : make test"
          echo "üß™ [TEST] Status    : STARTING"

          START_TS=$(date +%s)

          make test

          END_TS=$(date +%s)
          DURATION=$((END_TS - START_TS))

          echo "‚úÖ [TEST] Status    : COMPLETED"
          echo "‚è±  [TEST] Duration : ${DURATION} seconds"
          echo "‚ÑπÔ∏è  [TEST] See TAP summary above for test counts."
