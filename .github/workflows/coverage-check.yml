# =============================================================================
# BrikByteOS — Coverage Governance Gate Workflow
# -----------------------------------------------------------------------------
# Task / WBS:
#   - [TASK] GOV-TEST-COVERAGE-POLICY-004
#
# Repo:
#   - Implemented in:
#       • BrikByte-Studios/.github (.github/workflows/coverage-check.yml)
#   - Consumed by:
#       • BrikByte-Studios/brik-pipe-examples/*
#       • Product repos via workflow_call
#
# Purpose:
#   Enforce coverage thresholds (overall + critical paths) for protected branches
#   using coverage.json + .governance/tests.yml.
# =============================================================================
name: "BrikByteOS — Coverage Governance Gate"

on:
  workflow_call:
    inputs:
      working-directory:
        description: "Directory where coverage.json lives (relative to repo root)"
        required: false
        default: "."
        type: string
      coverage-file:
        description: "Path to normalized coverage.json (relative to working-directory)"
        required: false
        default: "./out/coverage.json"
        type: string
      policy-file:
        description: "Coverage policy file (relative to repo root)"
        required: false
        default: ".governance/tests.yml"
        type: string
      baseline-file:
        description: "Optional baseline coverage file (relative to repo root)."
        required: false
        default: ".audit/coverage-baseline.json"
        type: string
      coverage-artifact-name:
        description: "Name of coverage artifact uploaded by test job"
        required: false
        default: "coverage-node"
        type: string
      node-version:
        description: "Node version used to run the governance gate"
        required: false
        default: "20"
        type: string

  pull_request:
    branches:
      - main
      - "release/*"

permissions:
  contents: read

jobs:
  coverage-gate:
    name: "Coverage Governance Gate"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # Download coverage artifact into a neutral folder (avoid double-nesting)
      # -----------------------------------------------------------------------
      - name: Download coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.coverage-artifact-name }}
          path: .artifacts/coverage

      # -----------------------------------------------------------------------
      # Materialize coverage into canonical path:
      #   <working-directory>/<coverage-file>
      # This avoids "node-api-example/node-api-example/out/coverage.json" issues.
      # -----------------------------------------------------------------------
      - name: Materialize coverage.json into working directory
        shell: bash
        run: |
          set -euo pipefail

          WD="${{ inputs.working-directory }}"
          COV_REL="${{ inputs.coverage-file }}"
          COV_REL="${COV_REL#./}"

          TARGET="${WD}/${COV_REL}"

          echo "[COVERAGE] working-directory : ${WD}"
          echo "[COVERAGE] coverage-file     : ${COV_REL}"
          echo "[COVERAGE] target            : ${TARGET}"

          echo "[COVERAGE] downloaded files:"
          find .artifacts/coverage -maxdepth 8 -type f -print || true

          # Find coverage.json anywhere inside the artifact payload
          found="$(find .artifacts/coverage \
            -type f \
            \( -path "*/out/coverage.json" -o -name "coverage.json" \) \
            -print -quit 2>/dev/null || true)"

          if [[ -z "${found}" ]]; then
            echo "[COVERAGE] ERROR: Could not find coverage.json in downloaded artifact."
            exit 1
          fi

          echo "[COVERAGE] using: ${found}"

          mkdir -p "$(dirname "${TARGET}")"
          cp "${found}" "${TARGET}"

          echo "[COVERAGE] ✅ materialized: ${TARGET}"
          ls -la "$(dirname "${TARGET}")"
          head -n 40 "${TARGET}" || true

      # -----------------------------------------------------------------------
      # Run coverage governance gate
      # -----------------------------------------------------------------------
      - name: Run coverage governance gate
        uses: BrikByte-Studios/.github/.github/actions/coverage-gate@main
        with:
          working-directory: ${{ inputs.working-directory }}
          coverage-file: ${{ inputs.coverage-file }}
          policy-file: ${{ inputs.policy-file }}
          baseline-file: ${{ inputs.baseline-file }}
          node-version: ${{ inputs.node-version }}
