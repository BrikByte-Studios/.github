# =============================================================================
# BrikByteOS â€” Coverage Governance Gate Workflow
# -----------------------------------------------------------------------------
# Task / WBS:
#   - [TASK] GOV-TEST-COVERAGE-POLICY-004
#
# Repo:
#   - Implemented in:
#       â€¢ BrikByte-Studios/.github (.github/workflows/coverage-check.yml)
#   - Consumed by:
#       â€¢ BrikByte-Studios/brik-pipe-examples/*
#       â€¢ Product repos via workflow_call
#
# Purpose:
#   Enforce coverage thresholds (overall + critical paths) for protected branches
#   using coverage.json + .governance/tests.yml.
# =============================================================================
name: "BrikByteOS â€” Coverage Governance Gate"

on:
  # Reusable mode for product/example repos
  workflow_call:
    inputs:
      working-directory:
        description: "Directory where coverage.json lives (for logs / relative paths)"
        required: false
        default: "."
        type: string
      coverage-file:
        description: "Path to normalized coverage.json (relative to repo root)"
        required: false
        default: "out/coverage.json"
        type: string
      policy-file:
        description: "Coverage policy file (relative to repo root)"
        required: false
        default: ".governance/tests.yml"
        type: string
      baseline-file:
        description: "Optional baseline coverage file (relative to repo root)."
        required: false
        default: ".audit/coverage-baseline.json"
        type: string
      coverage-artifact-name:
        description: "Name of coverage artifact uploaded by test job"
        required: false
        default: "coverage-node"
        type: string

  # Optional direct mode for governance repo itself (if you ever want it)
  pull_request:
    branches:
      - main
      - "release/*"

permissions:
  contents: read

jobs:
  coverage-gate:
    name: "Coverage Governance Gate"
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------------------------------------
      # 1) Checkout repository
      # -----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # 2) Download coverage artifact produced by the tests job
      #    - Caller must upload an artifact with this name and include
      #      a coverage.json somewhere inside it.
      # -----------------------------------------------------------------------
      - name: Download coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.coverage-artifact-name }}
          path: .

      # -----------------------------------------------------------------------
      # 3) Locate coverage.json dynamically
      #    - Avoids hard-coding node-api-example/out/coverage.json
      #    - Whatever path we find is exported as $COVERAGE_FILE.
      # -----------------------------------------------------------------------
      - name: Locate coverage.json
        id: locate-coverage
        run: |
          set -euo pipefail

          echo "ðŸ—‚ Workspace tree after artifact download:"
          ls -R
          echo

          echo "ðŸ” Searching for coverage.json..."
          FOUND=$(find . -maxdepth 6 -type f -name "coverage.json" | head -n 1 || true)

          if [ -z "$FOUND" ]; then
            echo "âŒ No coverage.json found in workspace after artifact download."
            echo "   Ensure the tests workflow uploads an artifact containing coverage.json."
            exit 1
          fi

          echo "âœ… Found coverage.json at: $FOUND"
          echo "COVERAGE_FILE=$FOUND" >> "$GITHUB_ENV"

      # -----------------------------------------------------------------------
      # 4) Run coverage governance gate
      #    - Uses the discovered coverage.json path.
      #    - Enforces thresholds defined in .governance/tests.yml.
      # -----------------------------------------------------------------------
      - name: Run coverage governance gate
        uses: BrikByte-Studios/.github/.github/actions/coverage-gate@main
        with:
          working-directory: ${{ inputs.working-directory }}
          coverage-file: ${{ env.COVERAGE_FILE }}
          policy-file: ${{ inputs.policy-file }}
          baseline-file: ${{ inputs.baseline-file }}
          node-version: "20"
