# -------------------------------------------------------------------
# Purpose:
# - Soft enforcement + audit trace for mandatory reviewers.
# - Ensures PRs that touch integration or E2E tests were approved by:
#     - QA Automation Lead
#     - Platform Lead
#
# This is NOT the primary enforcement mechanism (CODEOWNERS is),
# but it provides:
# - Machine-auditable proof
# - .audit compatibility later
# -------------------------------------------------------------------

name: "Governance - Validate Required Reviewers"

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review, edited]

jobs:
  validate-reviewers:
    name: "Validate mandatory reviewers"
    runs-on: ubuntu-latest

    steps:
      - name: "Validate required reviewers"
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const files = await github.paginate(
              github.rest.pulls.listFiles,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
              }
            );

            const touchesIntegration = files.some(f =>
              f.filename.includes("tests/integration") ||
              f.filename.includes("tests/e2e")
            );

            if (!touchesIntegration) {
              console.log("✅ PR does not affect integration/E2E tests.");
              return;
            }

            const reviews = await github.paginate(
              github.rest.pulls.listReviews,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
              }
            );

            const approvedBy = reviews
              .filter(r => r.state === "APPROVED")
              .map(r => r.user.login.toLowerCase());

            const required = [
              "qa-automation",
              "platform-leads"
            ];

            const missing = required.filter(
              req => !approvedBy.includes(req)
            );

            if (missing.length > 0) {
              core.setFailed(
                `❌ Missing required approvals from: ${missing.join(", ")}`
              );
            } else {
              console.log("✅ All mandatory reviewers have approved.");
            }
