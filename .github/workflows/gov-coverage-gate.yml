name: GOV-COVERAGE-GATE â€” Minimum Coverage (PIPE-GOV-7.3.2)

on:
  workflow_call:
    inputs:
      effective_policy_path:
        description: "Path to effective merged policy JSON"
        required: false
        default: "out/effective-policy.json"
        type: string
      coverage_report_path:
        description: "Path to coverage summary JSON"
        required: false
        default: "coverage/coverage-summary.json"
        type: string
      decision_in:
        description: "Existing decision.json (if any)"
        required: false
        default: ".audit/decision.json"
        type: string
      decision_out:
        description: "Output decision.json path"
        required: false
        default: ".audit/decision.json"
        type: string

jobs:
  coverage-gate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # Assume tests already ran and coverage file exists in the caller repo

      - name: Coverage Gate
        run: >
          node scripts/policy/coverage-gate.js
          --org-policy .github/policy.yml
          --effective-policy "${{ inputs.effective_policy_path }}"
          --coverage-report "${{ inputs.coverage_report_path }}"
          --decision-in "${{ inputs.decision_in }}"
          --decision-out "${{ inputs.decision_out }}"
