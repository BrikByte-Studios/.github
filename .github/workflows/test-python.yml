# =============================================================================
# BrikByteOS ‚Äî Reusable Python Unit Test Workflow
# -----------------------------------------------------------------------------
# WBS ID : PIPE-TEST-UNIT-CI-BUILD-002
# Repos  :
#   - Implemented in:
#       ‚Ä¢ BrikByte-Studios/.github (.github/workflows/test-python.yml)
#   - Consumed by:
#       ‚Ä¢ BrikByte-Studios/brik-pipe-examples/python-api-example
#       ‚Ä¢ Product repos (via workflow_call)
#
# Contract:
#   - Expects:
#       ‚Ä¢ Makefile with `make test` calling `pytest`
#       ‚Ä¢ tests/ directory with test_*.py / *_test.py
# =============================================================================
name: "BrikByteOS ‚Äî Python Unit Tests"

on:
  workflow_call:
    inputs:
      python-version:
        description: "Python version (e.g. 3.11; must match runtime matrix)"
        required: false
        type: string
        default: "3.11"
      working-directory:
        description: "Path to Python project (Makefile + tests/)"
        required: false
        type: string
        default: "."

permissions:
  contents: read

jobs:
  test:
    name: "Python: Unit Tests"
    runs-on: ubuntu-latest

    env:
      LANGUAGE: python
      PYTHON_VERSION: ${{ inputs.python-version != '' && inputs.python-version || '3.11' }}
      WORKING_DIRECTORY: ${{ inputs.working-directory != '' && inputs.working-directory || '.' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify Python test layout
        run: |
          echo "üìÅ Working directory: ${WORKING_DIRECTORY}"

          if [ ! -d "${WORKING_DIRECTORY}" ]; then
            echo "‚ùå WORKING_DIRECTORY '${WORKING_DIRECTORY}' does not exist."
            exit 1
          fi

          if [ ! -f "${WORKING_DIRECTORY}/Makefile" ]; then
            echo "‚ùå Makefile not found in ${WORKING_DIRECTORY}."
            echo "   Expected 'make test' calling pytest."
            exit 1
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # Optional: central Python cache composite
      - name: "Cache Python dependencies"
        uses: BrikByte-Studios/.github/.github/actions/cache-python-deps@main
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          project-path: ${{ env.WORKING_DIRECTORY }}

      # -----------------------------------------------------------------------
      # Run unit tests via `make test`
      # -----------------------------------------------------------------------
      - name: Run Python unit tests (make test)
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          set -euo pipefail

          echo "üß™ [TEST] Language  : ${LANGUAGE}"
          echo "üß™ [TEST] Runtime   : Python ${PYTHON_VERSION}"
          echo "üß™ [TEST] Directory : ${PWD}"
          echo "üß™ [TEST] Command   : make test"
          echo "üß™ [TEST] Status    : STARTING"

          START_TS=$(date +%s)

          make test

          END_TS=$(date +%s)
          DURATION=$((END_TS - START_TS))

          echo "‚úÖ [TEST] Status    : COMPLETED"
          echo "‚è±  [TEST] Duration : ${DURATION} seconds"
          echo "‚ÑπÔ∏è  [TEST] See pytest summary above for test counts."

      # -----------------------------------------------------------------------
      # X) Collect coverage (Python: pytest + pytest-cov)
      #    - Expects coverage.xml produced by pytest-cov.
      # -----------------------------------------------------------------------
      - name: Normalize coverage ‚Üí coverage.json
        uses: BrikByte-Studios/.github/.github/actions/coverage-merge@main
        with:
          language: ${{ env.LANGUAGE }}
          working-directory: ${{ env.WORKING_DIRECTORY }}
          out: out/coverage.json

      - name: Ensure summary.line is set in coverage.json (Python)
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          set -euo pipefail
          echo "üîß Normalizing coverage: syncing summary.line from coverage.xml"

          if [ ! -f "coverage.xml" ]; then
            echo "‚ùå coverage.xml not found ‚Äì did pytest run with --cov-report=xml:coverage.xml?"
            ls -R
            exit 1
          fi

          python - << 'EOF'
          import json
          import xml.etree.ElementTree as ET
          from pathlib import Path

          xml_path = Path("coverage.xml")
          tree = ET.parse(xml_path)
          root = tree.getroot()

          # coverage.py / pytest-cov typically put overall line-rate on the root tag:
          # <coverage line-rate="0.95" ...>
          line_rate_attr = root.get("line-rate", "0")
          try:
            line_rate = float(line_rate_attr) * 100.0   # convert ratio ‚Üí percentage
          except ValueError:
            raise SystemExit(f"Invalid line-rate in coverage.xml: {line_rate_attr!r}")

          out_dir = Path("out")
          out_dir.mkdir(parents=True, exist_ok=True)
          cov_path = out_dir / "coverage.json"

          try:
            cov = json.loads(cov_path.read_text(encoding="utf-8"))
          except FileNotFoundError:
            cov = {}

          cov.setdefault("summary", {})
          cov["summary"]["line"] = line_rate  # numeric percentage

          cov.setdefault("files", [])  # can stay empty until you enforce critical_paths

          cov_path.write_text(json.dumps(cov, indent=2), encoding="utf-8")
          print(f"‚úÖ Updated out/coverage.json with summary.line = {line_rate:.1f}")
          EOF

          echo "‚úÖ coverage.json after normalization:"
          cat out/coverage.json

      - name: Upload Python coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ env.LANGUAGE }}   # => coverage-python
          path: |
            ${{ env.WORKING_DIRECTORY }}/out/coverage.json
            ${{ env.WORKING_DIRECTORY }}/coverage.xml
          if-no-files-found: ignore

