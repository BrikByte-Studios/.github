# PIPE-BUILD-SCHEMA-TEST-004 â€” Per-Language Build Config Validation
# VALID NOW â€” because brik-pipe-cli is published ðŸŽ‰

name: "Config: Validate brikpipe.build.yml"

on:
  workflow_call:
    inputs:
      project-path:
        description: "Path where brikpipe.build.yml lives"
        default: "."
        type: string

      config-file:
        description: "Config to validate"
        default: "brikpipe.build.yml"
        type: string

      schema-file:
        description: "Schema path inside meta repo"
        default: ".github/schemas/brikpipe-build.schema.json"
        type: string

  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read

jobs:
  validate:
    runs-on: ubuntu-latest

    env:
      PROJECT_PATH: ${{ inputs.project-path }}
      CONFIG_FILE:  ${{ inputs.config-file }}
      SCHEMA_FILE:  ${{ inputs.schema-file }}

    steps:
      # Repo with actual project config
      - uses: actions/checkout@v4

      # Meta-repo containing canonical schema
      - name: Checkout BrikByte governance repo
        uses: actions/checkout@v4
        with:
          repository: BrikByte-Studios/.github
          path: .brik-meta

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # ---- NEW â€” Valid because CLI is published ðŸŽ‰ ----
      - name: Install CLI validator
        run: |
          npm init -y --silent
          npm install brik-pipe-cli@latest

      # ---- Workflow_call direct validation mode ----
      - name: Validate config using CLI
        run: |
          echo "ðŸ§ª Running brikpipe config validation..."
          npx brik-pipe-cli validate build-config \
            --cwd "${PROJECT_PATH}" \
            --file "${CONFIG_FILE}" \
            --schema ".brik-meta/${SCHEMA_FILE}"
