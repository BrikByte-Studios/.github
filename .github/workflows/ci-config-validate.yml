# .github/workflows/ci-config-validate.yml
#
# PIPE-BUILD-SCHEMA-TEST-004 â€” Add Schema Validation for Per-Language Pipeline Config
#
# Purpose:
#   - Validate all brikpipe.build.yml configs against the central schema.
#   - Block merges when configurations are incorrect or unsafe.
#
name: "Config: Validate brikpipe.build.yml"

on:
  # âœ… Reusable workflow mode (called from other repos / workflows)
  workflow_call:
    inputs:
      project-path:
        description: "Relative path to the project root (where brikpipe.build.yml lives)"
        required: false
        default: "."
        type: string
      config-file:
        description: "Relative path (from project-path) to the build config file"
        required: false
        default: "brikpipe.build.yml"
        type: string
      schema-file:
        description: "Relative path (from repo root) to the JSON schema"
        required: false
        default: ".github/schemas/brikpipe-build.schema.json"
        type: string

  # Native mode in the governance repo (.github)
  #    - Scans the repo for ALL brikpipe.build.yml files
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

permissions:
  contents: read

jobs:
  validate-build-config:
    name: "Validate Build Config Schema"
    runs-on: ubuntu-latest

    env:
      PROJECT_PATH: ${{ inputs.project-path || '.' }}
      CONFIG_FILE:  ${{ inputs.config-file || '' }}
      SCHEMA_FILE:  ${{ inputs.schema-file || '.github/schemas/brikpipe-build.schema.json' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install validator dependencies
        run: bash .github/scripts/install-validator-deps.sh

      # -------------------------------------------------------------------
      # Mode 1: Single-file validation (reusable workflow typical case)
      #   - Triggered when CONFIG_FILE is set (workflow_call with inputs)
      # -------------------------------------------------------------------
      - name: Validate single config (workflow_call mode)
        if: env.CONFIG_FILE != ''
        run: |
          echo "ðŸ”§ Validating single config via workflow_call..."
          echo "  PROJECT_PATH = ${PROJECT_PATH}"
          echo "  CONFIG_FILE  = ${CONFIG_FILE}"
          echo "  SCHEMA_FILE  = ${SCHEMA_FILE}"

          CONFIG_PATH="${PROJECT_PATH}/${CONFIG_FILE}"

          if [ ! -f "$CONFIG_PATH" ]; then
            echo "âŒ Config file not found at: $CONFIG_PATH"
            exit 1
          fi

          node .github/scripts/validate-build-config.mjs \
            --file "$CONFIG_PATH" \
            --schema "$SCHEMA_FILE"

      # -------------------------------------------------------------------
      # Mode 2: Scan & validate all configs (governance repo mode)
      #   - Triggered when CONFIG_FILE is empty (push / PR with no inputs)
      # -------------------------------------------------------------------
      - name: Find brikpipe.build.yml files
        id: find_configs
        if: env.CONFIG_FILE == ''
        run: |
          echo "ðŸ”Ž Searching for brikpipe.build.yml files from repo root..."
          CONFIG_FILES=$(find . -name "brikpipe.build.yml" -type f || true)

          if [ -z "$CONFIG_FILES" ]; then
            echo "â„¹ï¸ No brikpipe.build.yml files found. Nothing to validate."
            echo "configs=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "ðŸ“„ Found configs:"
          echo "$CONFIG_FILES"

          # Encode as JSON array for downstream step
          CONFIG_FILES_JSON=$(printf '%s\n' $CONFIG_FILES | jq -R . | jq -s .)
          echo "configs=$CONFIG_FILES_JSON" >> "$GITHUB_OUTPUT"

      - name: Validate all discovered configs
        if: env.CONFIG_FILE == '' && steps.find_configs.outputs.configs != ''
        run: |
          echo "ðŸ”§ Validating discovered configs..."
          echo '${{ steps.find_configs.outputs.configs }}' | jq -c '.[]' | while read -r file; do
            CONFIG_PATH=$(echo "$file" | jq -r '.')
            echo "----------------------------------------"
            echo "Validating: $CONFIG_PATH"
            node .github/scripts/validate-build-config.mjs \
              --file "$CONFIG_PATH" \
              --schema "$SCHEMA_FILE"
          done
