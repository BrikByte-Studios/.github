name: "reusable-publish-artifacts"

on:
  workflow_call:
    inputs:
      # --- Core ---
      tag:
        required: true
        type: string

      # These globs are evaluated in THIS workflow workspace.
      # In production we expect the caller to upload build outputs as workflow artifacts,
      # and this reusable downloads them into dist/release before publishing.
      artifacts_glob:
        required: true
        type: string
      attachments_glob:
        required: false
        type: string

      # --- Publishing controls ---
      overwrite_policy:
        required: false
        type: string
        default: "fail" # fail | skip | overwrite

      draft:
        required: false
        type: boolean
        default: false
      prerelease:
        required: false
        type: boolean
        default: false

      # Optional: callers can pass a file path (e.g. CHANGELOG.md).
      # If provided, we expect the caller to upload a workflow artifact containing that file.
      body_path:
        required: false
        type: string
        default: ""

      require_attachments:
        required: false
        type: boolean
        default: true

      # --- Audit ---
      audit_dir:
        required: false
        type: string
        default: ".audit"
      audit_namespace:
        required: false
        type: string
        default: "release/artifacts"

      # --- Release notes generation (optional) ---
      # If true and body_path is empty, we generate release notes (preview) and use them as release body.
      generate_release_notes:
        required: false
        type: boolean
        default: true

      # --- Artifact handoff names (caller must match these) ---
      dist_artifact_name:
        required: false
        type: string
        default: "release-dist" # should contain dist/release/*
      notes_artifact_name:
        required: false
        type: string
        default: "release-notes" # produced by this workflow when generate_release_notes=true
      changelog_artifact_name:
        required: false
        type: string
        default: "changelog-md" # should contain CHANGELOG.md (or whatever body_path basename is)

    outputs:
      release_url:
        value: ${{ jobs.publish.outputs.release_url }}
      audit_path:
        value: ${{ jobs.publish.outputs.audit_path }}

permissions:
  contents: write # required for release create + asset upload

jobs:
  # ------------------------------------------------------------
  # 1) Generate release notes file + upload as artifact (optional)
  # Runs only when:
  # - generate_release_notes=true
  # - body_path is not provided
  # ------------------------------------------------------------
  release_notes:
    name: Generate release notes
    if: ${{ inputs.generate_release_notes && inputs.body_path == '' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      notes_file: ${{ steps.mk.outputs.notes_file }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate release notes (preview)
        id: cl
        uses: BrikByte-Studios/brik-pipe-actions/.github/actions/changelog-builder@main
        with:
          mode: "preview"
          version: ${{ inputs.tag }}
          infer_version: "false"
          include_merges: "false"
          enforcement_mode: "warn"
          audit_enabled: "true"
          audit_dir: ${{ inputs.audit_dir }}

      # Robust writing: avoid heredoc quoting issues.
      - name: Write release notes file
        id: mk
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist/release
          node - <<'NODE'
          const fs = require("fs");
          const p = "dist/release/release-notes.md";
          const content = process.env.RELEASE_NOTES || "";
          fs.writeFileSync(p, content, "utf8");
          console.log("Wrote", p, "bytes=", Buffer.byteLength(content, "utf8"));
          NODE
          echo "notes_file=dist/release/release-notes.md" >> "$GITHUB_OUTPUT"
        env:
          RELEASE_NOTES: ${{ steps.cl.outputs.release_notes_md }}

      - name: Upload release notes artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.notes_artifact_name }}
          path: ${{ steps.mk.outputs.notes_file }}
          if-no-files-found: error

  # ------------------------------------------------------------
  # 2) Publish GitHub release assets
  #
  # Data contract:
  # - Caller uploads build outputs as artifact: inputs.dist_artifact_name
  # - If caller provides body_path, caller uploads that file as artifact: inputs.changelog_artifact_name
  # - Otherwise (and enabled) this workflow generates release notes and downloads notes artifact.
  #
  # IMPORTANT:
  # - publish must run even when release_notes is skipped (generate_release_notes=false OR body_path provided)
  # ------------------------------------------------------------
  publish:
    name: publish-github-release
    runs-on: ubuntu-latest
    needs: [release_notes]
    if: ${{ always() && (needs.release_notes.result == 'success' || needs.release_notes.result == 'skipped') }}

    outputs:
      release_url: ${{ steps.pub.outputs.release_url }}
      audit_path: ${{ steps.pub.outputs.audit_path }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --- Always download dist artifacts (required for artifacts_glob to match) ---
      - name: Download release dist artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.dist_artifact_name }}
          path: dist/release

      # --- If we generated notes, download them into dist/release ---
      - name: Download generated release notes artifact
        if: ${{ inputs.generate_release_notes && inputs.body_path == '' }}
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.notes_artifact_name }}
          path: dist/release

      # --- If caller provided body_path, download that artifact safely into dist/notes ---
      - name: Download caller-provided body file artifact
        if: ${{ inputs.body_path != '' }}
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.changelog_artifact_name }}
          path: dist/notes

      # Decide which body_path to use:
      # - If caller provided inputs.body_path => resolve to dist/notes/<basename>
      # - Else if we generated notes => dist/release/release-notes.md
      # - Else => empty (no body)
      - name: Resolve body path
        id: body
        shell: bash
        run: |
          set -euo pipefail

          if [ -n "${{ inputs.body_path }}" ]; then
            base="$(basename "${{ inputs.body_path }}")"
            echo "body_path=dist/notes/${base}" >> "$GITHUB_OUTPUT"
          elif [ "${{ inputs.generate_release_notes }}" = "true" ] && [ "${{ inputs.body_path }}" = "" ]; then
            echo "body_path=dist/release/release-notes.md" >> "$GITHUB_OUTPUT"
          else
            echo "body_path=" >> "$GITHUB_OUTPUT"
          fi

      - name: Preflight validate artifacts + attachments
        shell: bash
        run: |
          set -euo pipefail
          echo "[preflight] listing dist/release"
          ls -la dist/release || true

          # Validate body_path if set
          if [ -n "${{ steps.body.outputs.body_path }}" ]; then
            test -f "${{ steps.body.outputs.body_path }}" || (echo "body_path missing: ${{ steps.body.outputs.body_path }}" && exit 1)
          fi

      - name: Publish GitHub Release assets
        id: pub
        uses: BrikByte-Studios/brik-pipe-actions/.github/actions/publish-github-release@main
        with:
          tag: ${{ inputs.tag }}
          artifacts_glob: ${{ inputs.artifacts_glob }}
          attachments_glob: ${{ inputs.attachments_glob }}
          overwrite_policy: ${{ inputs.overwrite_policy }}
          draft: ${{ inputs.draft }}
          prerelease: ${{ inputs.prerelease }}
          body_path: ${{ steps.body.outputs.body_path }}
          require_attachments: ${{ inputs.require_attachments }}
          audit_dir: ${{ inputs.audit_dir }}
          audit_namespace: ${{ inputs.audit_namespace }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload .audit bundle as workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: audit-bundle
          path: ${{ steps.pub.outputs.audit_path }}
          if-no-files-found: error
