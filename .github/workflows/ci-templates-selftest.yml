# PIPE-BUILD-TEMPLATES-TEST-006 ‚Äî Template Self-Tests
#
# Purpose:
#   - Periodically run a "smoke test" matrix against brik-pipe-examples
#   - For each supported runtime, run `make ci` in the corresponding example:
#       * node-api-example
#       * python-api-example
#       * java-api-example
#       * go-api-example
#       * dotnet-api-example
#   - Ensures:
#       * Runtime + Makefile contracts still hold
#       * Build + test paths remain healthy
#
# v1 Approach:
#   - Runs directly against brik-pipe-examples repos.
#   - Indirectly validates that templates remain compatible with conventions
#     defined in PIPE-BUILD-CONVENTIONS-CONFIG-003.
#
name: "CI Templates: Self-Test (brik-pipe-examples)"

on:
  # Nightly check to catch drift early
  schedule:
    - cron: "0 2 * * *"  # 02:00 UTC nightly
  # Run on main changes (optional but recommended)
  push:
    branches: [main, master]
  # Allow manual runs
  workflow_dispatch:

permissions:
  contents: read

jobs:
  selftest-matrix:
    name: "Self-test templates via example repos"
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        runtime:
          - node
          - python
          - java
          - go
          - dotnet

    env:
      EXAMPLES_REPO: BrikByte-Studios/brik-pipe-examples
      # Map runtimes to subdirectories in a simple way
      NODE_PROJECT: node-api-example
      PYTHON_PROJECT: python-api-example
      JAVA_PROJECT: java-api-example
      GO_PROJECT: go-api-example
      DOTNET_PROJECT: dotnet-api-example
      AUDIT_FILE: .audit/selftest-${{ matrix.runtime }}-${{ github.run_id }}.json

    steps:
      - name: Checkout .github repo
        uses: actions/checkout@v4
      # -------------------------------------------------------------------
      # 1) Checkout the examples repo
      #
      # We run directly in brik-pipe-examples so `make ci` matches the real
      # developer + CI experience for those repos.
      # -------------------------------------------------------------------
      - name: Checkout brik-pipe-examples
        uses: actions/checkout@v4
        with:
          repository: ${{ env.EXAMPLES_REPO }}
          path: examples
          # Keep default: repo checked out into $GITHUB_WORKSPACE

      # -------------------------------------------------------------------
      # 2) Select project path based on runtime
      #
      # This step normalizes the project path for the matrix runtime.
      # -------------------------------------------------------------------
      - name: Resolve project path for runtime
        id: project
        run: |
          case "${{ matrix.runtime }}" in
            node)
              echo "path=${NODE_PROJECT}" >> "$GITHUB_OUTPUT"
              ;;
            python)
              echo "path=${PYTHON_PROJECT}" >> "$GITHUB_OUTPUT"
              ;;
            java)
              echo "path=${JAVA_PROJECT}" >> "$GITHUB_OUTPUT"
              ;;
            go)
              echo "path=${GO_PROJECT}" >> "$GITHUB_OUTPUT"
              ;;
            dotnet)
              echo "path=${DOTNET_PROJECT}" >> "$GITHUB_OUTPUT"
              ;;
            *)
              echo "‚ùå Unknown runtime: ${{ matrix.runtime }}"
              exit 1
              ;;
          esac

          echo "Selected project path: $(cat "$GITHUB_OUTPUT")"

      # -------------------------------------------------------------------
      # 3) Print a small header per runtime
      # -------------------------------------------------------------------
      - name: Show runtime & project
        run: |
          echo "üß™ Self-testing runtime: ${{ matrix.runtime }}"
          echo "üìÅ Project path: ${{ steps.project.outputs.path }}"

      # -------------------------------------------------------------------
      # 4) Setup language-specific toolchain (minimal)
      #
      # The goal is not to recreate the full template behavior here, but to
      # ensure `make ci` is runnable for each example.
      # -------------------------------------------------------------------

      # Node.js
      - name: Setup Node.js
        if: matrix.runtime == 'node'
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # Python
      - name: Setup Python
        if: matrix.runtime == 'python'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Java
      - name: Setup Java
        if: matrix.runtime == 'java'
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      # Go
      - name: Setup Go
        if: matrix.runtime == 'go'
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"

      # .NET
      - name: Setup .NET
        if: matrix.runtime == 'dotnet'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      # -------------------------------------------------------------------
      # 5) Run `make ci` in the example project
      #
      # This is the heart of the self-test: ensure that for each runtime,
      # the example repo fully builds & tests using our canonical contract.
      # -------------------------------------------------------------------
      - name: Run make ci in example project
        working-directory: ${{ steps.project.outputs.path }}
        run: |
          echo "üõ†  Running make ci in $(pwd)..."
          make ci

      # -------------------------------------------------------------------
      # 6) Emit a small JSON summary artifact for auditability
      #
      # This can be consumed later or mirrored into .audit/ if desired.
      # -------------------------------------------------------------------
      - name: Write self-test audit summary
        # This step actually creates the file.
        run: |
          set -euo pipefail
          mkdir -p .audit

          cat << 'EOF' > "${AUDIT_FILE}"
          {
            "runtime": "${{ matrix.runtime }}",
            "run_id": "${{ github.run_id }}",
            "run_number": "${{ github.run_number }}",
            "repo": "${{ github.repository }}",
            "sha": "${{ github.sha }}",
            "status": "success"
          }
          EOF

      - name: Upload self-test audit summary
        uses: actions/upload-artifact@v4
        with:
          name: ci-templates-selftest-${{ matrix.runtime }}-${{ github.run_id }}
          # ‚úÖ Use the same env var here, no ${...} shell syntax
          path: ${{ env.AUDIT_FILE }}
          if-no-files-found: error
