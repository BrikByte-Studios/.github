# PIPE-BUILD-TEMPLATES-TEST-006 â€” Template Self-Tests
#
# Purpose:
#   - Periodically run a "smoke test" matrix against brik-pipe-examples
#   - For each supported runtime, run `make ci` in the corresponding example:
#       * node-api-example
#       * python-api-example
#       * java-api-example
#       * go-api-example
#       * dotnet-api-example
#   - Ensures:
#       * Runtime + Makefile contracts still hold
#       * Build + test paths remain healthy
#
# v1 Approach:
#   - Runs directly against brik-pipe-examples repos.
#   - Indirectly validates that templates remain compatible with conventions
#     defined in PIPE-BUILD-CONVENTIONS-CONFIG-003.
#
name: "CI Templates: Self-Test (brik-pipe-examples)"

on:
  # Nightly check to catch drift early
  schedule:
    - cron: "0 2 * * *"  # 02:00 UTC nightly
  # Run on main changes (optional but recommended)
  push:
    branches: [main, master]
  # Allow manual runs
  workflow_dispatch:

permissions:
  contents: read

jobs:
  selftest-matrix:
    name: "Self-test templates via example repos"
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        runtime:
          - node
          - python
          - java
          - go
          - dotnet

    env:
      EXAMPLES_REPO: BrikByte-Studios/brik-pipe-examples
      # Map runtimes to subdirectories in a simple way
      NODE_PROJECT: node-api-example
      PYTHON_PROJECT: python-api-example
      JAVA_PROJECT: java-api-example
      GO_PROJECT: go-api-example
      DOTNET_PROJECT: dotnet-api-example

    steps:
      # -------------------------------------------------------------------
      # 1) Checkout the examples repo
      #
      # We run directly in brik-pipe-examples so `make ci` matches the real
      # developer + CI experience for those repos.
      # -------------------------------------------------------------------
      - name: Checkout brik-pipe-examples
        uses: actions/checkout@v4
        with:
          repository: ${{ env.EXAMPLES_REPO }}
          # Keep default: repo checked out into $GITHUB_WORKSPACE

      # -------------------------------------------------------------------
      # 2) Select project path based on runtime
      #
      # This step normalizes the project path for the matrix runtime.
      # -------------------------------------------------------------------
      - name: Resolve project path for runtime
        id: project
        run: |
          case "${{ matrix.runtime }}" in
            node)
              echo "path=${NODE_PROJECT}" >> "$GITHUB_OUTPUT"
              ;;
            python)
              echo "path=${PYTHON_PROJECT}" >> "$GITHUB_OUTPUT"
              ;;
            java)
              echo "path=${JAVA_PROJECT}" >> "$GITHUB_OUTPUT"
              ;;
            go)
              echo "path=${GO_PROJECT}" >> "$GITHUB_OUTPUT"
              ;;
            dotnet)
              echo "path=${DOTNET_PROJECT}" >> "$GITHUB_OUTPUT"
              ;;
            *)
              echo "âŒ Unknown runtime: ${{ matrix.runtime }}"
              exit 1
              ;;
          esac

          echo "Selected project path: $(cat "$GITHUB_OUTPUT")"

      # -------------------------------------------------------------------
      # 3) Print a small header per runtime
      # -------------------------------------------------------------------
      - name: Show runtime & project
        run: |
          echo "ðŸ§ª Self-testing runtime: ${{ matrix.runtime }}"
          echo "ðŸ“ Project path: ${{ steps.project.outputs.path }}"

      # -------------------------------------------------------------------
      # 4) Setup language-specific toolchain (minimal)
      #
      # The goal is not to recreate the full template behavior here, but to
      # ensure `make ci` is runnable for each example.
      # -------------------------------------------------------------------

      # Node.js
      - name: Setup Node.js
        if: matrix.runtime == 'node'
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # Python
      - name: Setup Python
        if: matrix.runtime == 'python'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Java
      - name: Setup Java
        if: matrix.runtime == 'java'
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      # Go
      - name: Setup Go
        if: matrix.runtime == 'go'
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"

      # .NET
      - name: Setup .NET
        if: matrix.runtime == 'dotnet'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      # -------------------------------------------------------------------
      # 5) Run `make ci` in the example project
      #
      # This is the heart of the self-test: ensure that for each runtime,
      # the example repo fully builds & tests using our canonical contract.
      # -------------------------------------------------------------------
      - name: Run make ci in example project
        working-directory: ${{ steps.project.outputs.path }}
        run: |
          echo "ðŸ›   Running make ci in $(pwd)..."
          make ci

      # -------------------------------------------------------------------
      # 6) Emit a small JSON summary artifact for auditability
      #
      # This can be consumed later or mirrored into .audit/ if desired.
      # -------------------------------------------------------------------
      - name: Write self-test summary JSON
        run: |
          mkdir -p .audit
          SUMMARY_FILE=".audit/selftest-${{ matrix.runtime }}-${GITHUB_RUN_ID}.json"

          cat > "$SUMMARY_FILE" << 'EOF'
          {
            "doc_id": "PIPE-BUILD-TEMPLATES-TEST-006",
            "runtime": "${{ matrix.runtime }}",
            "examples_repo": "${{ env.EXAMPLES_REPO }}",
            "project_path": "${{ steps.project.outputs.path }}",
            "github_run_id": "${GITHUB_RUN_ID}",
            "github_run_attempt": "${GITHUB_RUN_ATTEMPT}",
            "github_sha": "${GITHUB_SHA}",
            "timestamp_utc": "${{ github.run_started_at }}"
          }
          EOF

          echo "ðŸ§¾ Wrote summary to: $SUMMARY_FILE"

      - name: Upload self-test summary artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "ci-templates-selftest-${{ matrix.runtime }}-${{ github.run_id }}"
          path: ".audit/selftest-${{ matrix.runtime }}-${GITHUB_RUN_ID}.json"
          if-no-files-found: error
