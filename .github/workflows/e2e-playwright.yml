# =============================================================================
# BrikByteOS â€” Playwright E2E (Reusable)
# -----------------------------------------------------------------------------
# PIPE-FLAKY-POLICY-CONFIG-002 wiring added:
#   - Select policy (repo override -> central fallback)
#   - Normalize flaky summary to satisfy evaluator contract (prevents total=0)
#   - Evaluate against policy with optional enforcement
#   - Upload flaky-eval evidence alongside E2E artifacts
#
# Notes:
#   - This workflow already uses playwright --shard (framework-native sharding).
#   - Evaluation runs only when flaky_detect == 'true' (opt-in).
# =============================================================================
name: "BrikByteOS â€” Playwright E2E (Reusable)"

on:
  workflow_call:
    inputs:
      # -----------------------------------------------------------------------
      # App under test
      # -----------------------------------------------------------------------
      target_url:
        description: "Base URL of the app under test"
        type: string
        required: true

      health_url:
        description: >
          Optional health endpoint to wait for
          (e.g., http://localhost:3000/health)
        type: string
        required: false
        default: ""

      start_app:
        description: >
          If true, start the app under test via docker-compose (localhost CI)
        type: boolean
        required: false
        default: false

      app_compose_file:
        description: "Path to app docker-compose file (if start_app=true)"
        type: string
        required: false
        default: ""

      app_service_workdir:
        description: "Working directory where app_compose_file lives"
        type: string
        required: false
        default: "."

      app_wait_seconds:
        description: >
          Max seconds to wait for app health endpoint (if health_url provided)
        type: number
        required: false
        default: 120

      # -----------------------------------------------------------------------
      # Playwright project
      # -----------------------------------------------------------------------
      service_workdir:
        description: "Working directory of the UI project"
        type: string
        required: false
        default: "."

      enable_firefox:
        description: "Enable Firefox project"
        type: boolean
        required: false
        default: false

      enable_webkit:
        description: "Enable WebKit project"
        type: boolean
        required: false
        default: false

      workers:
        description: "Playwright workers (e.g. 50%, 4)"
        type: string
        required: false
        default: "50%"

      retries:
        description: "Playwright retry count"
        type: number
        required: false
        default: 1

      trace_mode:
        description: "Trace mode (on, on-first-retry, retain-on-failure, off)"
        type: string
        required: false
        default: "on-first-retry"

      video_mode:
        description: "Video mode (on, on-first-retry, retain-on-failure, off)"
        type: string
        required: false
        default: "retain-on-failure"

      artifact_name:
        description: "Base artifact name"
        type: string
        required: false
        default: "playwright-e2e"

      # -----------------------------------------------------------------------
      # Cross-runner artifact export toggles (BrikByteOS standard)
      # -----------------------------------------------------------------------
      e2e_video:
        description: "Always export video when supported"
        type: boolean
        required: false
        default: false

      e2e_trace:
        description: "Always export traces when supported"
        type: boolean
        required: false
        default: false

      e2e_artifacts_always:
        description: "Export artifacts even on success"
        type: boolean
        required: false
        default: false

      job_timeout_minutes:
        description: "Job timeout in minutes to avoid hung sessions"
        type: number
        required: false
        default: 30

      override_shards:
        description: "Requested shard count (clamped by governance caps)"
        type: string
        required: false
        default: ""

      browsers:
        description: >
          Override browser list CSV (optional). If empty, derives from enable_*
          flags.
        type: string
        required: false
        default: ""

      # -----------------------------------------------------------------------
      # Standard shard contract wiring (parallel-runner)
      # -----------------------------------------------------------------------
      parallel_enabled:
        description: "Enable parallel-runner contract (true|false)."
        type: string
        required: false
        default: "true"

      parallel_mode:
        description: "serial|static|dynamic"
        type: string
        required: false
        default: "static"

      # -----------------------------------------------------------------------
      # Flaky detection (PIPE-FLAKY-RERUN-INTEG-001)
      # -----------------------------------------------------------------------
      flaky_detect:
        description: "Enable suite-level flaky reruns (true|false)"
        type: string
        required: false
        default: "false"

      flaky_reruns:
        description: "Total attempts when flaky_detect=true (e.g., 3)"
        type: string
        required: false
        default: "3"

      flaky_export_path:
        description: >
          Relative path (from service_workdir) to store flaky evidence
        type: string
        required: false
        default: "out/flaky"

      # -----------------------------------------------------------------------
      # Flaky policy evaluation (PIPE-FLAKY-POLICY-CONFIG-002)
      # -----------------------------------------------------------------------
      flaky_policy_path:
        description: >
          Path to policy-as-code YAML (repo root) IF repo overrides exist.
          NOTE: If missing, central policy from BrikByte-Studios/.github is used.
        type: string
        required: false
        default: ".governance/flaky-tests.yml"

      flaky_policy_enforce:
        description: >
          If true, evaluator may block ONLY if policy enables blocking.
          If false, evaluator still runs (when flaky_detect=true) but never blocks.
        type: boolean
        required: false
        default: true

permissions:
  contents: read

jobs:
  plan:
    name: "Plan governed E2E matrix"
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.plan.outputs.matrix_json }}

    steps:
      - uses: actions/checkout@v4

      - name: "Compute browser list (deterministic)"
        id: browsers
        shell: bash
        run: |
          set -euo pipefail
          csv="chromium"
          if [[ "${{ inputs.enable_firefox }}" == "true" ]]; then
            csv="${csv},firefox"
          fi
          if [[ "${{ inputs.enable_webkit }}" == "true" ]]; then
            csv="${csv},webkit"
          fi

          if [[ -n "${{ inputs.browsers }}" ]]; then
            csv="${{ inputs.browsers }}"
          fi

          echo "browsers_csv=${csv}" >> "${GITHUB_OUTPUT}"
          echo "[PLAN] browsers=${csv}"

      - name: "Generate browser Ã— shard matrix (governed)"
        id: plan
        uses: BrikByte-Studios/.github/.github/actions/matrix-plan@main
        with:
          test_type: e2e
          override_shards: ${{ inputs.override_shards }}
          browsers: ${{ steps.browsers.outputs.browsers_csv }}

      - name: "Debug matrix_json"
        run: |
          echo "matrix_json=${{ steps.plan.outputs.matrix_json }}"

  e2e:
    name: "Playwright E2E â€¢ ${{ matrix.browser }} â€¢ shard ${{ matrix.shard }}"
    needs: plan
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs.job_timeout_minutes }}

    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.plan.outputs.matrix) }}

    env:
      # ----------------------------------------------------------
      # Test runner contract
      # ----------------------------------------------------------
      E2E_TARGET_URL: ${{ inputs.target_url }}
      PW_BROWSER: ${{ matrix.browser }}
      PW_WORKERS: ${{ inputs.workers }}
      PW_RETRIES: ${{ inputs.retries }}
      PW_TRACE_MODE: ${{ inputs.trace_mode }}
      PW_VIDEO_MODE: ${{ inputs.video_mode }}

      # ----------------------------------------------------------
      # Artifact exporter contract
      # ----------------------------------------------------------
      E2E_RUNNER: playwright
      E2E_VIDEO: ${{ inputs.e2e_video && 'true' || 'false' }}
      E2E_TRACE: ${{ inputs.e2e_trace && 'true' || 'false' }}
      E2E_ARTIFACTS_ALWAYS: ${{ inputs.e2e_artifacts_always && 'true' || 'false' }}

      # Flaky contract (opt-in)
      FLAKY_DETECT: ${{ inputs.flaky_detect }}
      FLAKY_RERUNS: ${{ inputs.flaky_reruns }}
      FLAKY_EXPORT_PATH: ${{ inputs.flaky_export_path }}

      # Flaky policy (PIPE-FLAKY-POLICY-CONFIG-002)
      FLAKY_POLICY_PATH: ${{ inputs.flaky_policy_path }}
      FLAKY_POLICY_ENFORCE: ${{ inputs.flaky_policy_enforce }}

      FORCE_COLOR: "0"

      PW_ENABLE_FIREFOX: ${{ matrix.browser == 'firefox' && '1' || '0' }}
      PW_ENABLE_WEBKIT: ${{ matrix.browser == 'webkit' && '1' || '0' }}

    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v4

      - name: "Parallel runner (framework-native sharding)"
        id: pr
        uses: BrikByte-Studios/.github/.github/actions/parallel-runner@main
        with:
          parallel_enabled: ${{ inputs.parallel_enabled }}
          parallel_mode: ${{ inputs.parallel_mode }}
          shard_index: ${{ matrix.shard }}
          shard_total: ${{ strategy.job-total }}
          selection_mode: "framework-native"
          working_directory: ${{ inputs.service_workdir }}

      - name: "Checkout BrikByte shared scripts"
        uses: actions/checkout@v4
        with:
          repository: BrikByte-Studios/.github
          ref: main
          path: .brikbyte-github

      - name: "Sync flaky + evaluator scripts into caller repo"
        run: |
          set -euo pipefail
          mkdir -p .github/scripts

          cp .brikbyte-github/.github/scripts/flaky-rerun.sh \
            .github/scripts/flaky-rerun.sh
          cp .brikbyte-github/.github/scripts/evaluate-flaky.ts \
            .github/scripts/evaluate-flaky.ts
          cp .brikbyte-github/.github/scripts/flaky-io.ts       .github/scripts/flaky-io.ts
          cp .brikbyte-github/.github/scripts/flaky-types.ts    .github/scripts/flaky-types.ts || true

          chmod +x .github/scripts/flaky-rerun.sh
          echo "âœ… flaky-rerun.sh + evaluate-flaky.ts synced."

      - name: "Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: "Docker info (diagnostics)"
        if: ${{ inputs.start_app }}
        run: |
          set -euo pipefail
          docker version
          docker compose version

      # -----------------------------------------------------------------------
      # OPTIONAL: Start app under test (docker compose) for localhost CI
      # -----------------------------------------------------------------------
      - name: "Validate app inputs (if start_app=true)"
        if: ${{ inputs.start_app }}
        run: |
          set -euo pipefail
          if [[ -z "${{ inputs.app_compose_file }}" ]]; then
            echo "[APP] ERROR: app_compose_file is required when start_app=true"
            exit 1
          fi
          echo "[APP] start_app=true"
          echo "[APP] workdir=${{ inputs.app_service_workdir }}"
          echo "[APP] compose=${{ inputs.app_compose_file }}"

      - name: "Start app under test (docker compose)"
        if: ${{ inputs.start_app }}
        working-directory: ${{ inputs.app_service_workdir }}
        run: |
          set -euo pipefail
          docker compose -f "${{ inputs.app_compose_file }}" up -d --build
          docker compose -f "${{ inputs.app_compose_file }}" ps

      - name: "Wait for app readiness (optional)"
        if: ${{ inputs.health_url != '' }}
        run: |
          set -euo pipefail
          echo "[APP] Waiting for: ${{ inputs.health_url }}"
          timeout=${{ inputs.app_wait_seconds }}
          elapsed=0
          until curl -fsS "${{ inputs.health_url }}" >/dev/null 2>&1; do
            sleep 2
            elapsed=$((elapsed+2))
            if (( elapsed >= timeout )); then
              echo "[APP] ERROR: not ready within ${timeout}s"
              exit 1
            fi
          done
          echo "[APP] Ready âœ…"

      # -----------------------------------------------------------------------
      # Playwright install + run
      # -----------------------------------------------------------------------
      - name: "Install dependencies"
        working-directory: ${{ inputs.service_workdir }}
        run: |
          set -euo pipefail
          if [ -f "package-lock.json" ]; then
            npm ci
          else
            npm install
          fi

      - name: "Install Playwright browsers"
        working-directory: ${{ inputs.service_workdir }}
        run: |
          set -euo pipefail
          case "${PW_BROWSER}" in
            chromium) npx playwright install --with-deps chromium ;;
            firefox)  npx playwright install --with-deps firefox ;;
            webkit)   npx playwright install --with-deps webkit ;;
            *) echo "Unknown browser: ${PW_BROWSER}" && exit 1 ;;
          esac

      - name: "Run Playwright tests (flaky opt-in)"
        working-directory: ${{ inputs.service_workdir }}
        env:
          SHARD_INDEX: ${{ steps.pr.outputs.shard_index }}
          SHARD_TOTAL: ${{ steps.pr.outputs.shard_total }}
        run: |
          set -euo pipefail

          SHARD_1=$((SHARD_INDEX + 1))

          echo "[E2E] Browser=${PW_BROWSER}"
          echo "[E2E] Target=${E2E_TARGET_URL}"
          echo "[E2E] Shard=${SHARD_1}/${SHARD_TOTAL}"
          echo "[E2E] Contract shard_index=${SHARD_INDEX}"
          echo "[E2E] FlakyDetect=${FLAKY_DETECT} Reruns=${FLAKY_RERUNS} Export=${FLAKY_EXPORT_PATH}"

          export FLAKY_EXPORT_PATH="${PWD}/${FLAKY_EXPORT_PATH:-out/flaky}"
          export FLAKY_LABEL="playwright-${PW_BROWSER}"
          FLAKY_SH="${GITHUB_WORKSPACE}/.github/scripts/flaky-rerun.sh"

          if [[ ! -f "${FLAKY_SH}" ]]; then
            echo "âŒ flaky-rerun.sh not found at: ${FLAKY_SH}"
            ls -la "${GITHUB_WORKSPACE}/.github/scripts" || true
            exit 1
          fi

          "${FLAKY_SH}" -- npx playwright test \
            --project="${PW_BROWSER}" \
            --shard="${SHARD_1}/${SHARD_TOTAL}"

      # =============================================================================
      # PIPE-FLAKY-POLICY-CONFIG-002 â€” Evaluate evidence against policy-as-code
      # =============================================================================

      - name: "Select policy source (repo override -> central fallback)"
        if: ${{ always() && env.FLAKY_DETECT == 'true' }}
        run: |
          set -euo pipefail

          mkdir -p .tmp-flaky-eval

          REPO_POLICY="${GITHUB_WORKSPACE}/${FLAKY_POLICY_PATH}"
          CENTRAL_POLICY="${GITHUB_WORKSPACE}/.brikbyte-github/.governance/flaky-tests.yml"
          OUT_POLICY="${GITHUB_WORKSPACE}/.tmp-flaky-eval/policy.yml"

          echo "ðŸ§© [FLAKY] Repo policy     : ${REPO_POLICY}"
          echo "ðŸ›ï¸ [FLAKY] Central policy  : ${CENTRAL_POLICY}"
          echo "ðŸ“Œ [FLAKY] Selected policy : ${OUT_POLICY}"

          if [[ -f "${REPO_POLICY}" ]]; then
            echo "âœ… [FLAKY] Using repo override policy."
            cp "${REPO_POLICY}" "${OUT_POLICY}"
          else
            if [[ ! -f "${CENTRAL_POLICY}" ]]; then
              echo "âŒ [FLAKY] Central policy missing at: ${CENTRAL_POLICY}"
              exit 1
            fi
            echo "âœ… [FLAKY] Repo policy not found; using central policy."
            cp "${CENTRAL_POLICY}" "${OUT_POLICY}"
          fi

      - name: "Install evaluator deps (repo-root) [js-yaml + tsx]"
        if: ${{ always() && env.FLAKY_DETECT == 'true' }}
        working-directory: ${{ github.workspace }}
        env:
          NPM_CONFIG_FUND: "false"
          NPM_CONFIG_AUDIT: "false"
        run: |
          set -euo pipefail
          node -v
          npm -v

          if [[ ! -f package.json ]]; then
            npm init -y >/dev/null 2>&1
          fi

          npm i --no-save js-yaml@4 tsx@4 >/dev/null 2>&1
          echo "âœ… deps installed into repo-root node_modules"

      - name: "Normalize flaky evidence â†’ summary.normalized.json"
        if: ${{ always() && env.FLAKY_DETECT == 'true' }}
        run: |
          set -euo pipefail

          EXPORT_DIR="${GITHUB_WORKSPACE}/${{ inputs.service_workdir }}/${FLAKY_EXPORT_PATH}"
          EXPECTED="${EXPORT_DIR}/summary.json"
          LABELED="${EXPORT_DIR}/${FLAKY_LABEL:-playwright-chromium}.summary.json"

          EVIDENCE=""
          if [[ -f "${EXPECTED}" ]]; then
            EVIDENCE="${EXPECTED}"
          elif [[ -f "${LABELED}" ]]; then
            EVIDENCE="${LABELED}"
          else
            found="$(ls -1 "${EXPORT_DIR}"/*.summary.json 2>/dev/null | head -n 1 || true)"
            if [[ -n "${found}" ]]; then EVIDENCE="${found}"; fi
          fi

          if [[ -z "${EVIDENCE}" ]]; then
            echo "â„¹ï¸ [FLAKY] No evidence found â†’ skipping normalization."
            ls -la "${EXPORT_DIR}" || true
            exit 0
          fi

          OUT_NORM="${EXPORT_DIR}/summary.normalized.json"
          echo "ðŸ”§ [FLAKY] Normalizing: ${EVIDENCE} -> ${OUT_NORM}"

          EVIDENCE="${EVIDENCE}" OUT_NORM="${OUT_NORM}" python - <<'PY'
          import json
          from pathlib import Path
          import os

          evidence = Path(os.environ["EVIDENCE"])
          out_norm = Path(os.environ["OUT_NORM"])

          data = json.loads(evidence.read_text(encoding="utf-8"))

          attempts = data.get("attempts") if isinstance(data, dict) else None
          pass_count = 0
          fail_count = 0
          total_attempts = 0

          if isinstance(attempts, list) and attempts:
            total_attempts = len(attempts)
            for a in attempts:
              s = (a.get("status") or "").strip().lower()
              if not s:
                rc = int(a.get("exit_code", 0) or 0)
                s = "pass" if rc == 0 else "fail"
                a["status"] = s
              if s in ("pass", "passed", "ok", "success"):
                pass_count += 1
              elif s in ("fail", "failed", "error"):
                fail_count += 1
          else:
            pass_count = int(data.get("pass_count", 0) or 0) if isinstance(data, dict) else 0
            fail_count = int(data.get("fail_count", 0) or 0) if isinstance(data, dict) else 0
            total_attempts = pass_count + fail_count

          if isinstance(data, dict):
            data["pass_count"] = pass_count
            data["fail_count"] = fail_count
            data["total_attempts"] = total_attempts
            data["attempts"] = attempts if isinstance(attempts, list) else data.get("attempts", [])

          out_norm.parent.mkdir(parents=True, exist_ok=True)
          out_norm.write_text(json.dumps(data, indent=2), encoding="utf-8")
          print(f"âœ… wrote {out_norm} (pass={pass_count}, fail={fail_count}, total={total_attempts})")
          PY

          echo "=== normalized summary ==="
          cat "${OUT_NORM}"

      - name: "Evaluate flaky policy (use normalized summary)"
        if: ${{ always() && env.FLAKY_DETECT == 'true' }}
        run: |
          set -euo pipefail

          POLICY="${GITHUB_WORKSPACE}/.tmp-flaky-eval/policy.yml"
          EXPORT_DIR="${GITHUB_WORKSPACE}/${{ inputs.service_workdir }}/${FLAKY_EXPORT_PATH}"
          IN_NORM="${EXPORT_DIR}/summary.normalized.json"
          OUT_JSON="${EXPORT_DIR}/evaluation.json"

          echo "ðŸ§© [FLAKY] Policy     : ${POLICY}"
          echo "ðŸ“ [FLAKY] Export dir : ${EXPORT_DIR}"
          echo "ðŸ“¥ [FLAKY] Normalized : ${IN_NORM}"
          echo "ðŸ“¤ [FLAKY] Output     : ${OUT_JSON}"
          echo "ðŸ›¡ï¸ [FLAKY] Enforce    : ${FLAKY_POLICY_ENFORCE}"

          if [[ ! -f "${POLICY}" ]]; then
            echo "âŒ [FLAKY] Missing policy file: ${POLICY}"
            exit 1
          fi

          if [[ ! -f "${IN_NORM}" ]]; then
            echo "â„¹ï¸ [FLAKY] Normalized summary missing â†’ skipping evaluation (non-blocking)."
            ls -la "${EXPORT_DIR}" || true
            exit 0
          fi

          EVAL_TS="${GITHUB_WORKSPACE}/.github/scripts/evaluate-flaky.ts"
          if [[ ! -f "${EVAL_TS}" ]]; then
            echo "âŒ [FLAKY] evaluate-flaky.ts not found at: ${EVAL_TS}"
            ls -la "${GITHUB_WORKSPACE}/.github/scripts" || true
            exit 1
          fi

          pushd "${GITHUB_WORKSPACE}" >/dev/null
          npx tsx "${EVAL_TS}" \
            --policy "${POLICY}" \
            --input "${IN_NORM}" \
            --out "${OUT_JSON}" \
            --md || rc=$?
          popd >/dev/null

          if [[ "${rc:-0}" != "0" && "${FLAKY_POLICY_ENFORCE}" != "true" ]]; then
            echo "âš ï¸ [FLAKY] Evaluator exit=${rc} but enforce=false â†’ not blocking."
            exit 0
          fi

          exit "${rc:-0}"

      - name: "Upload flaky evaluation artifact (always)"
        if: ${{ always() && env.FLAKY_DETECT == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: >-
            flaky-eval-playwright-
            ${{ matrix.browser }}-
            shard-${{ matrix.shard }}-
            ${{ github.run_id }}-
            attempt-${{ github.run_attempt }}
          path: |
            ${{ inputs.service_workdir }}/${{ inputs.flaky_export_path }}/
          if-no-files-found: warn
          include-hidden-files: true
          retention-days: 14

      # -----------------------------------------------------------------------
      # ALWAYS: capture deep E2E diagnostics
      # -----------------------------------------------------------------------
      - name: "Capture E2E diagnostics (always)"
        if: always()
        uses: BrikByte-Studios/.github/.github/actions/capture-e2e-diagnostics@main
        with:
          runner: "playwright"
          browser: ${{ matrix.browser }}
          status: ${{ job.status }}
        env:
          PLAYWRIGHT_DIAG_DIR: "${{ inputs.service_workdir }}/test-results/diagnostics"
          CYPRESS_DIAG_DIR: "cypress/diagnostics"
          SELENIUM_DIAG_DIR: "target/selenium-artifacts/diagnostics"
          E2E_DIAG_HEAVY_ON_FAILURE_ONLY: "true"
          E2E_DIAG_DISABLE_HAR_BY_DEFAULT: "true"
          E2E_DIAG_MAX_TOTAL_MB: "150"

      - name: "Set E2E_STATUS for exporter (always)"
        if: always()
        run: |
          set -euo pipefail
          status="${{ job.status }}"
          if [[ "${status}" == "failure" || "${status}" == "cancelled" ]]; then
            echo "E2E_STATUS=failed" >> "${GITHUB_ENV}"
          else
            echo "E2E_STATUS=success" >> "${GITHUB_ENV}"
          fi

      - name: "Export E2E artifacts (always)"
        if: always()
        uses: BrikByte-Studios/.github/.github/actions/export-e2e-artifacts@main
        with:
          runner: "playwright"
          browser: ${{ matrix.browser }}
          status: ${{ job.status }}
          video: ${{ inputs.e2e_video }}
          trace: ${{ inputs.e2e_trace }}
          artifacts_always: ${{ inputs.e2e_artifacts_always }}
        env:
          E2E_MAX_TOTAL_MB: "300"
          E2E_MAX_VIDEOS: "10"
          PLAYWRIGHT_SCREENSHOTS_DIR: "${{ inputs.service_workdir }}/test-results"
          PLAYWRIGHT_VIDEOS_DIR: "${{ inputs.service_workdir }}/test-results"
          PLAYWRIGHT_TRACES_DIR: "${{ inputs.service_workdir }}/test-results"
          PLAYWRIGHT_REPORT_DIR: "${{ inputs.service_workdir }}/playwright-report"

      - name: "Teardown app under test (always)"
        if: ${{ always() && inputs.start_app }}
        working-directory: ${{ inputs.app_service_workdir }}
        run: |
          set -euo pipefail
          docker compose -f "${{ inputs.app_compose_file }}" down -v || true

      - name: "Upload E2E artifacts (always)"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: >-
            ${{ inputs.artifact_name }}-
            ${{ matrix.browser }}-
            shard-${{ matrix.shard }}-
            ${{ github.run_id }}
          path: |
            .audit/**/e2e/artifacts/**
            .audit/**/e2e/diagnostics/**
            ${{ inputs.service_workdir }}/out/flaky/**
          if-no-files-found: warn
          include-hidden-files: true
          retention-days: 14
