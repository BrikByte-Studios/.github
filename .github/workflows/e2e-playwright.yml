name: "E2E (Playwright • Cross-Browser)"

# -----------------------------------------------------------------------------
# Reusable Playwright E2E workflow (BrikByteOS standard)
#
# ENV CONTRACT:
#   Required:
#     - E2E_TARGET_URL
#
# Exporter / Audit:
#   - E2E_RUNNER=playwright
#   - E2E_STATUS=success|failed
#   - E2E_VIDEO=true|false
#   - E2E_TRACE=true|false
#   - E2E_ARTIFACTS_ALWAYS=true|false
#
# Optional app lifecycle (CI localhost mode):
#   - start_app=true runs docker compose up -d --build
#   - health_url can be used to wait for readiness
#
# Always-on guarantees:
#   - Always set E2E_STATUS
#   - Always export artifacts (best-effort, non-fatal)
#   - Always upload .audit evidence
#   - Always teardown app (if started here)
# -----------------------------------------------------------------------------

on:
  workflow_call:
    inputs:
      # -----------------------------------------------------------------------
      # App under test
      # -----------------------------------------------------------------------
      target_url:
        description: "Base URL of the app under test"
        type: string
        required: true

      health_url:
        description: "Optional health endpoint to wait for (e.g., http://localhost:3000/health)"
        type: string
        required: false
        default: ""

      start_app:
        description: "If true, start the app under test via docker-compose (localhost CI)"
        type: boolean
        required: false
        default: false

      app_compose_file:
        description: "Path to app docker-compose file (required if start_app=true)"
        type: string
        required: false
        default: ""

      app_service_workdir:
        description: "Working directory where app_compose_file lives"
        type: string
        required: false
        default: "."

      app_wait_seconds:
        description: "Max seconds to wait for app health endpoint (if health_url provided)"
        type: number
        required: false
        default: 120

      # -----------------------------------------------------------------------
      # Playwright project
      # -----------------------------------------------------------------------
      service_workdir:
        description: "Working directory of the UI project"
        type: string
        required: false
        default: "."

      enable_firefox:
        description: "Enable Firefox project"
        type: boolean
        required: false
        default: false

      enable_webkit:
        description: "Enable WebKit project"
        type: boolean
        required: false
        default: false

      workers:
        description: "Playwright workers (e.g. 50%, 4)"
        type: string
        required: false
        default: "50%"

      retries:
        description: "Playwright retry count"
        type: number
        required: false
        default: 1

      trace_mode:
        description: "Trace mode (on, on-first-retry, retain-on-failure, off)"
        type: string
        required: false
        default: "on-first-retry"

      video_mode:
        description: "Video mode (on, on-first-retry, retain-on-failure, off)"
        type: string
        required: false
        default: "retain-on-failure"

      artifact_name:
        description: "Base artifact name"
        type: string
        required: false
        default: "playwright-e2e"

      # -----------------------------------------------------------------------
      # Cross-runner artifact export toggles (BrikByteOS standard)
      # -----------------------------------------------------------------------
      e2e_video:
        description: "Always export video when supported"
        type: boolean
        required: false
        default: false

      e2e_trace:
        description: "Always export traces when supported"
        type: boolean
        required: false
        default: false

      e2e_artifacts_always:
        description: "Export artifacts even on success"
        type: boolean
        required: false
        default: false

      job_timeout_minutes:
        description: "Job timeout in minutes to avoid hung sessions"
        type: number
        required: false
        default: 30

      override_shards:
        description: "Requested shard count (clamped by governance caps)"
        type: string
        required: false
        default: ""

      browsers:
        description: "Override browser list CSV (optional). If empty, derives from enable_* flags."
        type: string
        required: false
        default: ""

jobs:
  plan:
    name: "Plan governed E2E matrix"
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.plan.outputs.matrix_json }}
    steps:
      - uses: actions/checkout@v4
      - name: "Compute browser list (deterministic)"
        id: browsers
        shell: bash
        run: |
          set -euo pipefail
          # Always include chromium; add optional browsers based on inputs.
          csv="chromium"
          if [[ "${{ inputs.enable_firefox }}" == "true" ]]; then csv="${csv},firefox"; fi
          if [[ "${{ inputs.enable_webkit }}" == "true" ]]; then csv="${csv},webkit"; fi

          # If caller provided explicit browsers CSV, it wins (still deterministic).
          if [[ -n "${{ inputs.browsers }}" ]]; then
            csv="${{ inputs.browsers }}"
          fi

          echo "browsers_csv=${csv}" >> "${GITHUB_OUTPUT}"
          echo "[PLAN] browsers=${csv}"

      - name: "Generate browser × shard matrix (governed)"
        id: plan
        uses: BrikByte-Studios/.github/.github/actions/matrix-plan@main
        with:
          test_type: e2e
          override_shards: ${{ inputs.override_shards }}
          browsers: ${{ steps.browsers.outputs.browsers_csv }}

  e2e:
    name: "Playwright E2E • ${{ matrix.browser }} • shard ${{ matrix.shard }}"
    needs: plan
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs.job_timeout_minutes }}

    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.plan.outputs.matrix) }}


    env:
      # ----------------------------------------------------------
      # Test runner contract
      # ----------------------------------------------------------
      E2E_TARGET_URL: ${{ inputs.target_url }}
      PW_BROWSER: ${{ matrix.browser }}
      PW_WORKERS: ${{ inputs.workers }}
      PW_RETRIES: ${{ inputs.retries }}
      PW_TRACE_MODE: ${{ inputs.trace_mode }}
      PW_VIDEO_MODE: ${{ inputs.video_mode }}


      # ----------------------------------------------------------
      # Artifact exporter contract
      # ----------------------------------------------------------
      E2E_RUNNER: playwright
      E2E_VIDEO: ${{ inputs.e2e_video && 'true' || 'false' }}
      E2E_TRACE: ${{ inputs.e2e_trace && 'true' || 'false' }}
      E2E_ARTIFACTS_ALWAYS: ${{ inputs.e2e_artifacts_always && 'true' || 'false' }}

      FORCE_COLOR: "0"

      PW_ENABLE_FIREFOX: ${{ matrix.browser == 'firefox' && '1' || '0' }}
      PW_ENABLE_WEBKIT: ${{ matrix.browser == 'webkit' && '1' || '0' }}

    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v4

      - name: "Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: "Docker info (diagnostics)"
        if: ${{ inputs.start_app }}
        run: |
          set -euo pipefail
          docker version
          docker compose version

      # -----------------------------------------------------------------------
      # OPTIONAL: Start app under test (docker compose) for localhost CI
      # -----------------------------------------------------------------------
      - name: "Validate app inputs (if start_app=true)"
        if: ${{ inputs.start_app }}
        run: |
          set -euo pipefail
          if [[ -z "${{ inputs.app_compose_file }}" ]]; then
            echo "[APP] ERROR: app_compose_file is required when start_app=true"
            exit 1
          fi
          echo "[APP] start_app=true"
          echo "[APP] workdir=${{ inputs.app_service_workdir }}"
          echo "[APP] compose=${{ inputs.app_compose_file }}"

      - name: "Start app under test (docker compose)"
        if: ${{ inputs.start_app }}
        working-directory: ${{ inputs.app_service_workdir }}
        run: |
          set -euo pipefail
          : <<'DOCSTRING'
          Start app under test (docker compose)

          Purpose:
            Bring up the UI service so Playwright can hit E2E_TARGET_URL.

          Notes:
            - Use inputs.target_url pointing to this runner host, e.g. http://localhost:3000
            - This step must not print secrets.
          DOCSTRING
          docker compose -f "${{ inputs.app_compose_file }}" up -d --build
          docker compose -f "${{ inputs.app_compose_file }}" ps

      - name: "Wait for app readiness (optional)"
        if: ${{ inputs.health_url != '' }}
        run: |
          set -euo pipefail
          : <<'DOCSTRING'
          Wait for app readiness

          Purpose:
            Ensure health endpoint responds before Playwright starts.
          DOCSTRING

          echo "[APP] Waiting for: ${{ inputs.health_url }}"
          timeout=${{ inputs.app_wait_seconds }}
          elapsed=0

          until curl -fsS "${{ inputs.health_url }}" >/dev/null 2>&1; do
            sleep 2
            elapsed=$((elapsed+2))
            if (( elapsed >= timeout )); then
              echo "[APP] ERROR: not ready within ${timeout}s"
              exit 1
            fi
          done

          echo "[APP] Ready ✅"

      # -----------------------------------------------------------------------
      # Playwright install + run
      # -----------------------------------------------------------------------
      - name: "Install dependencies"
        working-directory: ${{ inputs.service_workdir }}
        run: |
          set -euo pipefail
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: "Install Playwright browsers"
        working-directory: ${{ inputs.service_workdir }}
        run: |
          set -euo pipefail
          case "${PW_BROWSER}" in
            chromium) npx playwright install --with-deps chromium ;;
            firefox)  npx playwright install --with-deps firefox ;;
            webkit)   npx playwright install --with-deps webkit ;;
            *) echo "Unknown browser: ${PW_BROWSER}" && exit 1 ;;
          esac

      - name: "Run Playwright tests"
        working-directory: ${{ inputs.service_workdir }}
        run: |
          set -euo pipefail
          echo "[E2E] Browser=${PW_BROWSER}"
          echo "[E2E] Target=${E2E_TARGET_URL}"
          echo "[E2E] Shard=${{ matrix.shard }}/${{ strategy.job-total }}"

          npx playwright test \
            --project="${PW_BROWSER}" \
            --shard="${{ matrix.shard }}/${{ strategy.job-total }}"


      # -----------------------------------------------------------------------
      # ALWAYS: capture deep E2E diagnostics (console, network, trace, DOM)
      # -----------------------------------------------------------------------
      - name: "Capture E2E diagnostics (always)"
        if: always()
        uses: BrikByte-Studios/.github/.github/actions/capture-e2e-diagnostics@main
        with:
          runner: "playwright"
          browser: ${{ matrix.browser }}
          status: ${{ job.status }}
        env:
          # Where the Playwright diagnostics producer writes files
          PLAYWRIGHT_DIAG_DIR: "${{ inputs.service_workdir }}/test-results/diagnostics"

          # Future-proofing for other runners (no-op here)
          CYPRESS_DIAG_DIR: "cypress/diagnostics"
          SELENIUM_DIAG_DIR: "target/selenium-artifacts/diagnostics"
          # Mitigation 1: heavy only on failure (retain-on-failure)
          E2E_DIAG_HEAVY_ON_FAILURE_ONLY: "true"

          # Contingency: HAR off by default (esp. good for Selenium/Cypress)
          E2E_DIAG_DISABLE_HAR_BY_DEFAULT: "true"

          # Mitigation 2: size budget
          E2E_DIAG_MAX_TOTAL_MB: "150"

      # -----------------------------------------------------------------------
      # ALWAYS: normalize status for exporter
      # -----------------------------------------------------------------------
      - name: "Set E2E_STATUS for exporter (always)"
        if: always()
        run: |
          set -euo pipefail
          status="${{ job.status }}"
          if [[ "${status}" == "failure" || "${status}" == "cancelled" ]]; then
            echo "E2E_STATUS=failed" >> "${GITHUB_ENV}"
          else
            echo "E2E_STATUS=success" >> "${GITHUB_ENV}"
          fi

      # -----------------------------------------------------------------------
      # ALWAYS: export artifacts into .audit (via reusable action)
      # -----------------------------------------------------------------------
      - name: "Export E2E artifacts (always)"
        if: always()
        uses: BrikByte-Studios/.github/.github/actions/export-e2e-artifacts@main
        with:
          runner: "playwright"
          browser: ${{ matrix.browser }}
          status: ${{ job.status }}
          video: ${{ inputs.e2e_video }}
          trace: ${{ inputs.e2e_trace }}
          artifacts_always: ${{ inputs.e2e_artifacts_always }}
        env:
          E2E_MAX_TOTAL_MB: "300"
          E2E_MAX_VIDEOS: "10"

          PLAYWRIGHT_SCREENSHOTS_DIR: "${{ inputs.service_workdir }}/test-results"
          PLAYWRIGHT_VIDEOS_DIR: "${{ inputs.service_workdir }}/test-results"
          PLAYWRIGHT_TRACES_DIR: "${{ inputs.service_workdir }}/test-results"
          PLAYWRIGHT_REPORT_DIR: "${{ inputs.service_workdir }}/playwright-report"

      # -----------------------------------------------------------------------
      # ALWAYS: teardown app under test (if started here)
      # -----------------------------------------------------------------------
      - name: "Teardown app under test (always)"
        if: ${{ always() && inputs.start_app }}
        working-directory: ${{ inputs.app_service_workdir }}
        run: |
          set -euo pipefail
          docker compose -f "${{ inputs.app_compose_file }}" down -v || true

      # -----------------------------------------------------------------------
      # ALWAYS: upload audit artifacts
      # -----------------------------------------------------------------------
      - name: "Upload E2E artifacts (always)"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}-${{ matrix.browser }}-shard-${{ matrix.shard }}-${{ github.run_id }}
          path: |
            .audit/**/e2e/artifacts/**
            .audit/**/e2e/diagnostics/**
          if-no-files-found: warn
          include-hidden-files: true
          retention-days: 14
