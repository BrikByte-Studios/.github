name: "E2E (Playwright • Cross-Browser)"

# -----------------------------------------------------------------------------
# Reusable Playwright E2E workflow (BrikByteOS standard)
#
# ENV CONTRACT:
#   Required:
#     - E2E_TARGET_URL
#
#   Exporter / Audit:
#     - E2E_RUNNER=playwright
#     - E2E_STATUS=success|failed
#     - E2E_VIDEO=true|false
#     - E2E_TRACE=true|false
#     - E2E_ARTIFACTS_ALWAYS=true|false
#
# Always-on guarantees:
#   - Export artifacts (best-effort)
#   - Upload .audit evidence
# -----------------------------------------------------------------------------

on:
  workflow_call:
    inputs:
      target_url:
        description: "Base URL of the app under test"
        type: string
        required: true

      service_workdir:
        description: "Working directory of the UI project"
        type: string
        required: false
        default: "."

      enable_firefox:
        description: "Enable Firefox project"
        type: boolean
        required: false
        default: false

      enable_webkit:
        description: "Enable WebKit project"
        type: boolean
        required: false
        default: false

      workers:
        description: "Playwright workers (e.g. 50%, 4)"
        type: string
        required: false
        default: "50%"

      retries:
        description: "Playwright retry count"
        type: number
        required: false
        default: 1

      trace_mode:
        description: "Trace mode (on, on-first-retry, retain-on-failure, off)"
        type: string
        required: false
        default: "on-first-retry"

      artifact_name:
        description: "Base artifact name"
        type: string
        required: false
        default: "playwright-e2e"

      e2e_video:
        description: "Always export video when supported"
        type: boolean
        required: false
        default: false

      e2e_trace:
        description: "Always export traces when supported"
        type: boolean
        required: false
        default: false

      e2e_artifacts_always:
        description: "Export artifacts even on success"
        type: boolean
        required: false
        default: false

jobs:
  e2e:
    name: "Playwright E2E • ${{ matrix.browser }}"
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]

    env:
      # ----------------------------------------------------------
      # Test runner contract
      # ----------------------------------------------------------
      E2E_TARGET_URL: ${{ inputs.target_url }}
      PW_BROWSER: ${{ matrix.browser }}
      PW_WORKERS: ${{ inputs.workers }}
      PW_RETRIES: ${{ inputs.retries }}
      PW_TRACE_MODE: ${{ inputs.trace_mode }}

      # ----------------------------------------------------------
      # Artifact exporter contract
      # ----------------------------------------------------------
      E2E_RUNNER: playwright
      E2E_VIDEO: ${{ inputs.e2e_video }}
      E2E_TRACE: ${{ inputs.e2e_trace }}
      E2E_ARTIFACTS_ALWAYS: ${{ inputs.e2e_artifacts_always }}

      FORCE_COLOR: "0"

    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v4

      - name: "Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: "Install dependencies"
        working-directory: ${{ inputs.service_workdir }}
        run: |
          set -euo pipefail
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: "Install Playwright browsers"
        working-directory: ${{ inputs.service_workdir }}
        run: |
          set -euo pipefail
          npx playwright install --with-deps

      - name: "Run Playwright tests"
        if: >
          matrix.browser == 'chromium' ||
          (matrix.browser == 'firefox' && inputs.enable_firefox) ||
          (matrix.browser == 'webkit' && inputs.enable_webkit)
        working-directory: ${{ inputs.service_workdir }}
        run: |
          set -euo pipefail
          echo "[E2E] Browser=${PW_BROWSER}"
          echo "[E2E] Target=${E2E_TARGET_URL}"
          npx playwright test --project="${PW_BROWSER}"

      # -----------------------------------------------------------------------
      # ALWAYS: normalize status for exporter
      # -----------------------------------------------------------------------
      - name: "Set E2E_STATUS for exporter (always)"
        if: always()
        run: |
          set -euo pipefail
          status="${{ job.status }}"
          if [[ "${status}" == "failure" || "${status}" == "cancelled" ]]; then
            echo "E2E_STATUS=failed" >> "${GITHUB_ENV}"
          else
            echo "E2E_STATUS=success" >> "${GITHUB_ENV}"
          fi

      # -----------------------------------------------------------------------
      # ALWAYS: export artifacts into .audit (via reusable action)
      # -----------------------------------------------------------------------
      - name: "Export E2E artifacts (always)"
        if: always()
        uses: BrikByte-Studios/.github/.github/actions/export-e2e-artifacts@main
        with:
          runner: "playwright"
          browser: ${{ matrix.browser }}
          status: ${{ job.status }}
          video: ${{ inputs.e2e_video }}
          trace: ${{ inputs.e2e_trace }}
          artifacts_always: ${{ inputs.e2e_artifacts_always }}

      # -----------------------------------------------------------------------
      # ALWAYS: upload audit artifacts
      # -----------------------------------------------------------------------
      - name: "Upload E2E artifacts (always)"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}-${{ matrix.browser }}-${{ github.run_id }}
          path: ${{ inputs.service_workdir }}/.audit/**/e2e/artifacts/**
          if-no-files-found: warn
          include-hidden-files: true
