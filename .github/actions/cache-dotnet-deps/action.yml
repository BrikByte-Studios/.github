# ======================================================================
# BrikByteOS â€” .NET / NuGet Dependency Cache (dotnet restore)
# ----------------------------------------------------------------------
# TASK:
#   PIPE-CACHE-DOTNET-BUILD-00X â€” Implement .NET dependency cache
#
# PURPOSE:
#   Provide a reusable composite action that:
#     - Caches NuGet packages used by .NET builds.
#     - Targets standard NuGet cache locations:
#         â€¢ Linux/macOS: ~/.nuget/packages
#         â€¢ (Optionally) shared NuGet HTTP cache dirs.
#     - Cache key includes:
#         â€¢ OS (runner.os)
#         â€¢ dotnet-version (.NET SDK)
#         â€¢ Hash of project/solution files:
#             - *.sln
#             - *.csproj / *.fsproj / *.vbproj
#             - Directory.Packages.props / nuget.config (if present)
#
# USAGE EXAMPLE (consumer workflow):
#
#   env:
#     DOTNET_VERSION: "8.0.x"
#
#   jobs:
#     build:
#       runs-on: ubuntu-latest
#       steps:
#         - uses: actions/checkout@v4
#
#         - name: "Setup .NET"
#           uses: actions/setup-dotnet@v4
#           with:
#             dotnet-version: ${{ env.DOTNET_VERSION }}
#
#         - name: "Cache .NET / NuGet dependencies"
#           uses: BrikByte-Studios/.github/.github/actions/cache-dotnet-deps@main
#           with:
#             dotnet-version: ${{ env.DOTNET_VERSION }}
#             project-path: dotnet-api-example
#
#         - name: "Restore, build, test"
#           working-directory: dotnet-api-example
#           run: |
#             dotnet restore
#             dotnet build --configuration Release
#             dotnet test --configuration Release
#
# NOTES:
#   - Designed for SDK-style projects with dotnet CLI + NuGet.
#   - For monorepos, 'project-path' points to the root containing the .sln
#     and/or primary .csproj.
#   - No secrets are required; this only uses actions/cache.
# ======================================================================

name: "Cache .NET / NuGet Dependencies"
description: >
  BrikByteOS composite action to cache .NET NuGet packages using
  dotnet-versionâ€“ and project fileâ€“aware cache keys.

inputs:
  dotnet-version:
    description: >
      .NET SDK version used in CI (e.g. 7.0.x, 8.0.x). Must match the
      version configured via actions/setup-dotnet for safe cache reuse.
    required: true

  project-path:
    description: >
      Relative path to the .NET project/solution root (where *.sln or
      primary *.csproj live). Defaults to '.' for single-project repos.
    required: false
    default: "."

outputs:
  cache-path:
    description: "NuGet cache path(s) that were cached (comma-separated)."
    value: ${{ steps.cache-dotnet.outputs.cache-paths }}

runs:
  using: "composite"
  steps:
    # -------------------------------------------------------------------
    # 1) Detect .NET project structure and NuGet cache paths
    #
    #    - Validates presence of:
    #        â€¢ <project-path>/*.sln OR
    #        â€¢ <project-path>/*.csproj / *.fsproj / *.vbproj
    #    - If none found â†’ we emit a notice + skip caching.
    #
    #    - Cache paths (Linux/macOS runners):
    #        â€¢ NuGet global packages: ~/.nuget/packages
    #        â€¢ (Optional) HTTP cache dirs can be added later if needed.
    # -------------------------------------------------------------------
    - name: "Detect .NET project & NuGet cache"
      id: detect
      shell: bash
      run: |
        set -euo pipefail

        PROJECT_PATH="${{ inputs.project-path }}"
        echo "ðŸ” Inspecting .NET project at: ${PROJECT_PATH}"

        shopt -s nullglob

        sln_files=( "${PROJECT_PATH}"/*.sln )
        csproj_files=( "${PROJECT_PATH}"/*.csproj )
        fsproj_files=( "${PROJECT_PATH}"/*.fsproj )
        vbproj_files( "${PROJECT_PATH}"/*.vbproj )

        has_solution="false"
        has_project="false"

        if [ ${#sln_files[@]} -gt 0 ]; then
          has_solution="true"
        fi

        if [ ${#csproj_files[@]} -gt 0 ] || [ ${#fsproj_files[@]} -gt 0 ] || [ ${#vbproj_files[@]} -gt 0 ]; then
          has_project="true"
        fi

        if [ "${has_solution}" != "true" ] && [ "${has_project}" != "true" ]; then
          echo "::notice::.NET cache: No *.sln or project file found under '${PROJECT_PATH}'. Skipping cache."
          echo "has-project=false"        >> "$GITHUB_OUTPUT"
          echo "nuget-cache-paths="       >> "$GITHUB_OUTPUT"
          exit 0
        fi

        echo "âœ… .NET project files detected under '${PROJECT_PATH}'."
        echo "   Solutions: ${sln_files[*]:-<none>}"
        echo "   Projects : ${csproj_files[*]:-<none>} ${fsproj_files[*]:-} ${vbproj_files[*]:-}"

        # Global NuGet package cache (standard for Linux/macOS):
        NUGET_GLOBAL_PACKAGES="${HOME}/.nuget/packages"

        echo "ðŸ“¦ NuGet global packages cache: ${NUGET_GLOBAL_PACKAGES}"

        echo "has-project=true"                    >> "$GITHUB_OUTPUT"
        echo "nuget-cache-paths=${NUGET_GLOBAL_PACKAGES}" >> "$GITHUB_OUTPUT"

    # -------------------------------------------------------------------
    # 2) Cache NuGet packages with actions/cache@v4
    #
    #    - Only runs if we have a valid .NET project (has-project=true).
    #
    #    - Key components:
    #        â€¢ dotnet-<os>-<dotnet-version>-<hash(project files)>
    #
    #    - Project file hash includes:
    #        â€¢ *.sln / *.csproj / *.fsproj / *.vbproj
    #        â€¢ Directory.Packages.props (central package management)
    #        â€¢ nuget.config
    # -------------------------------------------------------------------
    - name: "Cache NuGet dependencies"
      id: cache-dotnet
      if: ${{ steps.detect.outputs.has-project == 'true' }}
      uses: actions/cache@v4
      with:
        path: ${{ steps.detect.outputs.nuget-cache-paths }}
        key: >
          dotnet-${{ runner.os }}-${{ inputs.dotnet-version }}-${{
            hashFiles(
              '**/*.sln',
              '**/*.csproj',
              '**/*.fsproj',
              '**/*.vbproj',
              '**/Directory.Packages.props',
              '**/nuget.config'
            )
          }}
        restore-keys: |
          dotnet-${{ runner.os }}-${{ inputs.dotnet-version }}-

    # -------------------------------------------------------------------
    # 3) Log cache result for observability
    # -------------------------------------------------------------------
    - name: "Summarize .NET cache result"
      if: ${{ steps.detect.outputs.has-project == 'true' }}
      shell: bash
      run: |
        set -euo pipefail

        CACHE_HIT="${{ steps.cache-dotnet.outputs.cache-hit }}"
        NUGET_PATHS="${{ steps.detect.outputs.nuget-cache-paths }}"

        if [ "${CACHE_HIT}" = "true" ]; then
          echo "âœ… .NET / NuGet cache HIT for dotnet-version=${{ inputs.dotnet-version }}."
        else
          echo "â„¹ï¸ .NET / NuGet cache MISS for dotnet-version=${{ inputs.dotnet-version }} â€” new cache will be created."
        fi

        echo "   Cached NuGet path(s): ${NUGET_PATHS}"

        echo "cache-paths=${NUGET_PATHS}" >> "$GITHUB_OUTPUT"
