{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://brikbyte-studios.github.io/schemas/policy.schema.json",
  "title": "BrikByte Studios â€” Org & Repo Policy Schema",
  "description": "Canonical schema for .github/policy.yml (org baseline) and repo-level policy.yml files.",
  "type": "object",
  "additionalProperties": false,
  "properties": {
    "version": {
      "type": "integer",
      "description": "Schema version (not policy_version). Used to track breaking changes in the schema itself.",
      "minimum": 1
    },
    "extends": {
      "type": "string",
      "description": "Inheritance directive for repo-level policies. 'org' inherits the org baseline; 'none' opts out (requires governance approval). Org .github/policy.yml SHOULD omit this.",
      "enum": ["org", "none"]
    },
    "policy_version": {
      "type": "string",
      "description": "Semantic version for this policy definition (X.Y.Z).",
      "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$"
    },
    "mode": {
      "type": "string",
      "description": "Operational mode: advisory (warn only) or enforce (block merges).",
      "enum": ["advisory", "enforce"]
    },
    "reviews": {
      "type": "object",
      "description": "Review-related policy (required approvals, CODEOWNERS, etc.).",
      "additionalProperties": false,
      "required": ["required_approvals", "require_code_owner_review"],
      "properties": {
        "required_approvals": {
          "type": "integer",
          "minimum": 1,
          "maximum": 6,
          "description": "Minimum number of GitHub approvals required on protected branches."
        },
        "require_code_owner_review": {
          "type": "boolean",
          "description": "Whether at least one CODEOWNER review is required."
        },
        "additional_reviewer_teams": {
          "type": "array",
          "description": "Additional reviewer teams that should be requested automatically.",
          "items": {
            "type": "string"
          }
        }
      },
      "default": {
        "type": "object",
        "description": "Default review rules when no branch-specific rule matches.",
        "additionalProperties": false,
        "properties": {
          "required_approvals": {
            "type": "integer",
            "minimum": 1,
            "maximum": 6
          },
          "require_code_owner_review": {
            "type": "boolean"
          },
          "required_roles": {
            "type": "array",
            "description": "Logical roles/teams (e.g. GitHub team slugs) from which at least one approver is required.",
            "items": {
              "type": "string"
            }
          }
        }
      },
       "branches": {
          "type": "object",
          "description": "Branch-specific rules keyed by exact branch name or glob patterns (e.g. 'main', 'release/*', 'hotfix/*').",
          "additionalProperties": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "required_approvals": {
                "type": "integer",
                "minimum": 1,
                "maximum": 6
              },
              "require_code_owner_review": {
                "type": "boolean"
              },
              "required_roles": {
                "type": "array",
                "description": "Roles/teams required for this branch pattern.",
                "items": {
                  "type": "string"
                }
              }
            }
          }
        }
    },
    "tests": {
      "type": "object",
      "description": "Test quality and coverage requirements.",
      "additionalProperties": false,
      "required": ["coverage_min", "require_tests_green"],
      "properties": {
        "coverage_min": {
          "type": "integer",
          "minimum": 0,
          "maximum": 100,
          "description": "Absolute minimum overall test coverage percentage required on protected branches."
        },
        "coverage_delta_min": {
          "type": "number",
          "description": "Minimum allowed delta vs baseline coverage in percentage points. Example: -2 means coverage may drop by at most 2 percentage points.",
          "default": -2
        },
        "coverage_report_path": {
          "type": "string",
          "description": "Relative path (from repo root) to the coverage summary JSON file (e.g., coverage/coverage-summary.json)."
        },
        "require_tests_green": {
          "type": "boolean",
          "description": "Whether all required test jobs must be green for a policy pass."
        },
        "critical_paths_only": {
          "type": "boolean",
          "description": "If true, coverage_min applies only to critical paths (e.g., core services)."
        }
      }
    },
    "security": {
      "type": "object",
      "description": "Static/dynamic security scan thresholds and tools.",
      "additionalProperties": false,
      "properties": {
        "sast": {
          "type": "object",
          "description": "SAST (CodeQL, Semgrep, etc.) configuration.",
          "additionalProperties": false,
          "required": ["tool", "max_severity"],
          "properties": {
            "tool": {
              "type": "string",
              "description": "SAST tool identifier (e.g., codeql, semgrep)."
            },
            "max_severity": {
              "type": "string",
              "description": "Maximum allowed SAST severity for unwaived findings.",
              "enum": ["none", "low", "medium", "high", "critical"]
            },
            "report_path": {
              "type": "string",
              "description": "Path to SAST report (e.g., SARIF or JSON summary)."
            }
          }
        },
        "sca": {
          "type": "object",
          "description": "SCA (dependency vulnerability) configuration.",
          "additionalProperties": false,
          "required": ["tool", "max_severity"],
          "properties": {
            "tool": {
              "type": "string",
              "description": "SCA tool identifier (e.g., npm-audit, pip-audit, mvn-dependency-check)."
            },
            "max_severity": {
              "type": "string",
              "description": "Maximum allowed SCA severity for unwaived findings.",
              "enum": ["none", "low", "medium", "high", "critical"]
            },
            "report_path": {
              "type": "string",
              "description": "Path to SCA report (e.g., JSON summary)."
            }
          }
        }
      },
      "required": ["sast", "sca"]
    },
    "docs": {
      "type": "object",
      "description": "Documentation / ADR update requirements.",
      "additionalProperties": false,
      "required": ["require_docs_on_feature_change"],
      "properties": {
        "require_docs_on_feature_change": {
          "type": "boolean",
          "description": "If true, changes labelled as features must include docs updates."
        },
        "paths": {
          "type": "array",
          "description": "Glob patterns for paths considered 'docs' for enforcement.",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "supply_chain": {
      "type": "object",
      "description": "Software supply chain requirements.",
      "additionalProperties": false,
      "properties": {
        "require_signed_artifacts": {
          "type": "boolean",
          "description": "Require build artifacts to be signed (e.g., Sigstore)."
        },
        "require_sbom": {
          "type": "boolean",
          "description": "Require SBOM generation for releases."
        }
      }
    },

    "waivers": {
      "type": "array",
      "description": "Policy-level waivers for specific rules (including security.sast/security.sca).",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["rule", "scope", "reason", "ttl", "approver", "evidence"],
        "properties": {
          "rule": {
            "type": "string",
            "description": "Rule identifier, e.g. security.sca or security.sast."
          },
          "scope": {
            "type": "string",
            "description": "Scope of the waiver (e.g., CVE ID, query ID, package name)."
          },
          "reason": {
            "type": "string",
            "description": "Why this waiver is granted (context/justification)."
          },
          "ttl": {
            "type": "string",
            "description": "Expiry date in YYYY-MM-DD format."
          },
          "approver": {
            "type": "string",
            "description": "GitHub handle or name of the approver."
          },
          "evidence": {
            "type": "string",
            "description": "Link to evidence of compensating controls or risk acceptance."
          }
        }
      }
    }
  },

  "required": [
    "policy_version",
    "mode",
    "reviews",
    "tests",
    "security",
    "docs"
  ]
}
